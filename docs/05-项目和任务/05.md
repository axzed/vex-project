# 项目管理

## 1. 改bug

在前面我们返回json格式的时候，是用的驼峰命名，但是前端需求的数据有些并不是这种格式，所以我们需要调整一下

### 1.1 user模块

~~~go
type Member struct {
	Id               int64  `json:"id"`
	Name             string `json:"name"`
	Mobile           string `json:"mobile"`
	Status           int    `json:"status"`
	Code             string `json:"code"`
	CreateTime       string `json:"create_time"`
	LastLoginTime    string `json:"last_login_time"`
	OrganizationCode string  `json:"organization_code"`
}

type TokenList struct {
	AccessToken    string `json:"accessToken"`
	RefreshToken   string `json:"refreshToken"`
	TokenType      string `json:"tokenType"`
	AccessTokenExp int64  `json:"accessTokenExp"`
}

type OrganizationList struct {
	Id          int64  `json:"id"`
	Name        string `json:"name"`
	Avatar      string `json:"avatar"`
	Description string `json:"description"`
	OwnerCode   string `json:"owner_code"`
	CreateTime  string  `json:"create_time"`
	Personal    int32  `json:"personal"`
	Address     string `json:"address"`
	Province    int32  `json:"province"`
	City        int32  `json:"city"`
	Area        int32  `json:"area"`
	Code        string `json:"code"`
}

~~~

~~~protobuf
message MemberMessage {
  int64 id = 1;
  string name = 2;
  string mobile = 3;
  string realname = 4;
  string account = 5;
  int32 status = 6;
  string  lastLoginTime = 7;
  string address = 8;
  int32 province = 9;
  int32 city = 10;
  int32 area = 11;
  string email = 12;
  string code = 13;
}
message OrganizationMessage {
  int64 id = 1;
  string name = 2;
  string avatar = 3;
  string description = 4;
  int64 memberId = 5;
  string createTime = 6;
  int32 personal = 7;
  string address = 8;
  int32 province = 9;
  int32 city = 10;
  int32 area = 11;
  string code = 12;
  string ownerCode = 13;
}
~~~

~~~go
func ToMap(orgs []*Organization) map[int64]*Organization {
	m := make(map[int64]*Organization)
	for _, v := range orgs {
		m[v.Id] = v
	}
	return m
}

~~~

~~~go
memMsg := &login.MemberMessage{}
	err = copier.Copy(memMsg, mem)
	memIdStr := strconv.FormatInt(mem.Id, 10)
	memMsg.Code, _ = encrypts.Encrypt(memIdStr, model.AESKey)
	memMsg.LastLoginTime = tms.FormatByMill(mem.LastLoginTime)
	//2.根据用户id查组织
	orgs, err := ls.organizationRepo.FindOrganizationByMemId(c, mem.Id)
	if err != nil {
		zap.L().Error("Login db FindMember error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	var orgsMessage []*login.OrganizationMessage
	err = copier.Copy(&orgsMessage, orgs)
	for _, org := range orgsMessage {
		org.Code, _ = encrypts.EncryptInt64(org.Id, model.AESKey)
		org.OwnerCode = memMsg.Code
		org.CreateTime = tms.FormatByMill(organization.ToMap(orgs)[org.Id].CreateTime)
	}
~~~

~~~go
package tms

import "time"

func Format(t time.Time) string {
	return t.Format("2006-01-02 15:04:05")
}
func FormatYMD(t time.Time) string {
	return t.Format("2006-01-02")
}
func FormatByMill(t int64) string {
	return time.UnixMilli(t).Format("2006-01-02 15:04:05")
}

~~~



### 1.2 project模块

#### 1.2.1 index

~~~go
type Menu struct {
	Id         int64   `json:"id"`
	Pid        int64   `json:"pid"`
	Title      string  `json:"title"`
	Icon       string  `json:"icon"`
	Url        string  `json:"url"`
	FilePath   string  `json:"file_path"`
	Params     string  `json:"params"`
	Node       string  `json:"node"`
	Sort       int32   `json:"sort"`
	Status     int32   `json:"status"`
	CreateBy   int64   `json:"create_by"`
	IsInner    int32   `json:"is_inner"`
	Values     string  `json:"values"`
	ShowSlider int32   `json:"show_slider"`
	StatusText string  `json:"statusText"`
	InnerText  string  `json:"innerText"`
	FullUrl    string  `json:"fullUrl"`
	Children   []*Menu `json:"children"`
}
~~~

~~~go
message MenuMessage {
  int64  id = 1;
  int64 pid = 2;
  string title = 3;
  string icon = 4;
  string url = 5;
  string filePath = 6;
  string params = 7;
  string node = 8;
  int32 sort = 9;
  int32 status = 10;
  int64 createBy = 11;
  int32 isInner = 12;
  string values = 13;
  int32 showSlider = 14;
  string statusText = 15;
  string innerText  = 16;
  string fullUrl    = 17;
  repeated MenuMessage children = 18;
}
~~~

~~~go
package menu

import "github.com/jinzhu/copier"

type ProjectMenu struct {
	Id         int64
	Pid        int64
	Title      string
	Icon       string
	Url        string
	FilePath   string
	Params     string
	Node       string
	Sort       int
	Status     int
	CreateBy   int64
	IsInner    int
	Values     string
	ShowSlider int
}

func (*ProjectMenu) TableName() string {
	return "ms_project_menu"
}

type ProjectMenuChild struct {
	ProjectMenu
	StatusText string
	InnerText  string
	FullUrl    string
	Children   []*ProjectMenuChild
}

func CovertChild(pms []*ProjectMenu) []*ProjectMenuChild {
	var pmcs []*ProjectMenuChild
	copier.Copy(&pmcs, pms)
	for _, v := range pmcs {
		v.StatusText = getStatus(v.Status)
		v.InnerText = getInnerText(v.IsInner)
		v.FullUrl = getFullUrl(v.Url, v.Params, v.Values)
	}
	var childPmcs []*ProjectMenuChild
	//递归
	for _, v := range pmcs {
		if v.Pid == 0 {
			child := copyChild(v)
			childPmcs = append(childPmcs, child)
		}
	}
	toChild(childPmcs, pmcs)
	return childPmcs
}

func getFullUrl(url string, params string, values string) string {
	if (params != "" && values != "") || values != "" {
		return url + "/" + values
	}
	return url
}

func getInnerText(inner int) string {
	if inner == 0 {
		return "导航"
	}
	if inner == 1 {
		return "内页"
	}
	return ""
}

func getStatus(status int) string {
	if status == 0 {
		return "禁用"
	}
	if status == 1 {
		return "使用中"
	}
	return ""
}

func toChild(childPmcs []*ProjectMenuChild, pmcs []*ProjectMenuChild) {
	for _, pmc := range childPmcs {
		for _, pm := range pmcs {
			if pmc.Id == pm.Pid {
				child := copyChild(pm)
				pmc.Children = append(pmc.Children, child)
			}
		}
		toChild(pmc.Children, pmcs)
	}
}

func copyChild(from *ProjectMenuChild) *ProjectMenuChild {
	child := &ProjectMenuChild{}
	copier.Copy(child, from)
	return child
}

~~~

~~~go
func (u *HandlerProject) index(c *gin.Context) {
	result := &common.Result{}
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &project.IndexMessage{}
	indexResponse, err := ProjectServiceClient.Index(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	var menus []*menu.Menu
	copier.Copy(&menus, indexResponse.Menus)
	c.JSON(http.StatusOK, result.Success(menus))
}
~~~

sql排序：

~~~go
func (m *MenuDao) FindAll(ctx context.Context) ([]*menu.ProjectMenu, error) {
	var pms []*menu.ProjectMenu
	err := m.conn.Session(ctx).Order("pid,sort asc, id asc").Find(&pms).Error
	return pms, err
}

~~~





#### 1.2.2 myprojectlist

~~~go
package project

type Project struct {
	Id                 int64   `json:"id"`
	Cover              string  `json:"cover"`
	Name               string  `json:"name"`
	Description        string  `json:"description"`
	AccessControlType  string  `json:"access_control_type"`
	WhiteList          string  `json:"white_list"`
	Order              int     `json:"order"`
	Deleted            int     `json:"deleted"`
	TemplateCode       string  `json:"template_code"`
	Schedule           float64 `json:"schedule"`
	CreateTime         string  `json:"create_time"`
	OrganizationCode   string  `json:"organization_code"`
	DeletedTime        string  `json:"deleted_time"`
	Private            int     `json:"private"`
	Prefix             string  `json:"prefix"`
	OpenPrefix         int     `json:"open_prefix"`
	Archive            int     `json:"archive"`
	ArchiveTime        int64   `json:"archive_time"`
	OpenBeginTime      int     `json:"open_begin_time"`
	OpenTaskPrivate    int     `json:"open_task_private"`
	TaskBoardTheme     string  `json:"task_board_theme"`
	BeginTime          int64   `json:"begin_time"`
	EndTime            int64   `json:"end_time"`
	AutoUpdateSchedule int     `json:"auto_update_schedule"`
	Code               string  `json:"code"`
}

type MemberProject struct {
	Id          int64  `json:"id"`
	ProjectCode int64  `json:"project_code"`
	MemberCode  int64  `json:"member_code"`
	JoinTime    string `json:"join_time"`
	IsOwner     int64  `json:"is_owner"`
	Authorize   string `json:"authorize"`
}

type ProAndMember struct {
	Project
	ProjectCode int64  `json:"project_code"`
	MemberCode  int64  `json:"member_code"`
	JoinTime    int64  `json:"join_time"`
	IsOwner     int64  `json:"is_owner"`
	Authorize   string `json:"authorize"`
	OwnerName   string `json:"owner_name"`
	Collected   int    `json:"collected"`
}

~~~

~~~go

message ProjectMessage {
  int64 Id = 1;
  string Cover = 2;
  string Name = 3;
  string Description = 4;
  string AccessControlType = 5;
  string WhiteList = 6;
  int32 Order = 7;
  int32 Deleted = 8;
  string TemplateCode = 9;
  double Schedule = 10;
  string CreateTime = 11;
  string OrganizationCode = 12;
  string DeletedTime = 13;
  int32 Private = 14;
  string Prefix = 15;
  int32 OpenPrefix = 16;
  int32 Archive = 17;
  int64 ArchiveTime = 18;
  int32 OpenBeginTime = 19;
  int32 OpenTaskPrivate = 20;
  string TaskBoardTheme = 21;
  string BeginTime = 22;
  string EndTime = 23;
  int32 AutoUpdateSchedule = 24;
  int64 ProjectCode = 25;
  int64 MemberCode = 26;
  string JoinTime  = 27;
  int64 IsOwner = 28;
  string Authorize = 29;
  string code = 30;
  string ownerName = 31;
  int32 collected = 32;
}

message ProjectRpcMessage{
  int64 memberId = 1;
  string memberName = 2;
  int64 page = 3;
  int64 pageSize = 4;
}
~~~

加上排序：（改表的字段 order是关键字）

~~~go
func (p *ProjectDao) FindProjectByMemId(ctx context.Context, memId int64, page int64, size int64) ([]*project.ProAndMember, int64, error) {
	session := p.conn.Session(ctx)
	index := (page - 1) * size
	db := session.Raw("select * from ms_project a, ms_project_member b where a.id=b.project_code and b.member_code=? order by sort limit ?,?", memId, index, size)
	var mp []*project.ProAndMember
	err := db.Scan(&mp).Error
	var total int64
	session.Model(&project.MemberProject{}).Where("member_code=?", memId).Count(&total)
	return mp, total, err
}
~~~

~~~go
for _, v := range pmm {
		v.Code, _ = encrypts.EncryptInt64(v.Id, model.AESKey)
		pam := project2.ToMap(pm)[v.Id]
		v.AccessControlType = pam.GetAccessControlType()
		v.OrganizationCode, _ = encrypts.EncryptInt64(pam.OrganizationCode, model.AESKey)
		v.JoinTime = tms.FormatByMill(pam.JoinTime)
		v.OwnerName = in.MemberName
		v.Order = int32(pam.Sort)
		v.CreateTime = tms.FormatByMill(pam.CreateTime)
	}
~~~

~~~go

func (m *ProAndMember) GetAccessControlType() string {
	if m.AccessControlType == 0 {
		return "open"
	}
	if m.AccessControlType == 1 {
		return "private"
	}
	if m.AccessControlType == 2 {
		return "custom"
	}
	return ""
}

func ToMap(orgs []*ProAndMember) map[int64]*ProAndMember {
	m := make(map[int64]*ProAndMember)
	for _, v := range orgs {
		m[v.Id] = v
	}
	return m
}

~~~



中间件：

~~~go
c.Set("memberName", member.Member.Name)
~~~

~~~go
memberName := c.GetString("memberName")
	var page = &model.Page{}
	page.Bind(c)
	pm, err := ProjectServiceClient.FindProjectByMemId(ctx, &project.ProjectRpcMessage{MemberId: memberId, MemberName: memberName, Page: page.Page, PageSize: page.PageSize})
	
~~~



## 2. 项目管理-我的项目

请求uri：project/project

参数：

| 名称                    | 类型   | 描述                                              |
| ----------------------- | ------ | ------------------------------------------------- |
| Authorization（header） | string | bearer ${token}                                   |
| page                    | int    | form表单参数                                      |
| pageSize                | int    | form表单参数                                      |
| selectBy                | string | my 我的项目 collect 收藏 archive 归档 deleted回收 |

响应：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "list":[
            {
                "id":13044,
                "cover":"http:\/\/127.0.0.1\/static\/image\/default\/project-cover.png",
                "name":"12312",
                "code":"lbevtfoz618xr7su3ih0mpnc",
                "description":"",
                "access_control_type":"open",
                "white_list":null,
                "order":0,
                "deleted":0,
                "template_code":"",
                "schedule":0,
                "create_time":"2022-07-26 21:30:59",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "deleted_time":null,
                "private":1,
                "prefix":null,
                "open_prefix":0,
                "archive":0,
                "archive_time":null,
                "open_begin_time":0,
                "open_task_private":0,
                "task_board_theme":"simple",
                "begin_time":null,
                "end_time":null,
                "auto_update_schedule":0,
                "project_code":null,
                "member_code":null,
                "join_time":"2022-07-26 21:30:59",
                "is_owner":1,
                "authorize":null,
                "owner_name":"子龙",
                "collected":0
            },
            {
                "id":13043,
                "cover":"http:\/\/127.0.0.1\/static\/image\/default\/project-cover.png",
                "name":"财务管理系统",
                "code":"7mdlxqzeay96i1rbk4uovnfh",
                "description":"",
                "access_control_type":"open",
                "white_list":null,
                "order":0,
                "deleted":0,
                "template_code":"",
                "schedule":0,
                "create_time":"2022-07-26 21:24:36",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "deleted_time":null,
                "private":1,
                "prefix":null,
                "open_prefix":0,
                "archive":0,
                "archive_time":null,
                "open_begin_time":0,
                "open_task_private":0,
                "task_board_theme":"simple",
                "begin_time":null,
                "end_time":null,
                "auto_update_schedule":0,
                "project_code":null,
                "member_code":null,
                "join_time":"2022-07-26 21:24:36",
                "is_owner":1,
                "authorize":null,
                "owner_name":"子龙",
                "collected":0
            }
        ],
        "total":2
    }
}
~~~

### 2.1 涉及到的表

~~~sql
CREATE TABLE `vex_project_collection`  (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `project_code` bigint(20) NULL DEFAULT 0 COMMENT '项目id',
  `member_code` bigint(20)  NULL DEFAULT 0 COMMENT '成员id',
  `create_time` bigint(20)  NULL DEFAULT 0 COMMENT '加入时间',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 46 CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '项目-收藏表' ROW_FORMAT = COMPACT;
~~~

### 2.2 实现

~~~go
func (u *HandlerProject) myProjectList(c *gin.Context) {
	result := &common.Result{}
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	memberId := c.GetInt64("memberId")
	memberName := c.GetString("memberName")
	var page = &model.Page{}
	page.Bind(c)
	selectBy := c.PostForm("selectBy")
	pm, err := ProjectServiceClient.FindProjectByMemId(ctx,
		&project.ProjectRpcMessage{
			MemberId:   memberId,
			MemberName: memberName,
			SelectBy:   selectBy,
			Page:       page.Page,
			PageSize:   page.PageSize})
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}

	var pam []*project2.ProAndMember
	copier.Copy(&pam, pm.Pm)
	if pam == nil {
		pam = []*project2.ProAndMember{}
	}
	c.JSON(http.StatusOK, result.Success(gin.H{
		"list":  pam,
		"total": pm.Total,
	}))
}
~~~

~~~protobuf
message ProjectRpcMessage{
  int64 memberId = 1;
  string memberName = 2;
  int64 page = 3;
  int64 pageSize = 4;
  string selectBy = 5;
}
~~~

~~~go

func (c *ProjectService) FindProjectByMemId(ctx context.Context, in *project.ProjectRpcMessage) (*project.MyProjectResponse, error) {
	id := in.MemberId
	var pm []*project2.ProAndMember
	var total int64
	var err error
	if in.SelectBy == "" || in.SelectBy == "my" {
		pm, total, err = c.projectRepo.FindProjectByMemId(ctx, id, "", in.Page, in.PageSize)
	}
	if in.SelectBy == "archive" {
		pm, total, err = c.projectRepo.FindProjectByMemId(ctx, id, "and archive = 1 ", in.Page, in.PageSize)
	}
	if in.SelectBy == "deleted" {
		pm, total, err = c.projectRepo.FindProjectByMemId(ctx, id, "and deleted = 1 ", in.Page, in.PageSize)
	}
	if in.SelectBy == "collect" {
		pm, total, err = c.projectRepo.FindCollectProjectByMemId(ctx, id, in.Page, in.PageSize)
	}
	if err != nil {
		zap.L().Error("menu findAll error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	if pm == nil {
		return &project.MyProjectResponse{Pm: []*project.ProjectMessage{}, Total: total}, nil
	}
	var pmm []*project.ProjectMessage
	copier.Copy(&pmm, pm)
	for _, v := range pmm {
		v.Code, _ = encrypts.EncryptInt64(v.Id, model.AESKey)
		pam := project2.ToMap(pm)[v.Id]
		v.AccessControlType = pam.GetAccessControlType()
		v.OrganizationCode, _ = encrypts.EncryptInt64(pam.OrganizationCode, model.AESKey)
		v.JoinTime = tms.FormatByMill(pam.JoinTime)
		v.OwnerName = in.MemberName
		v.Order = int32(pam.Sort)
		v.CreateTime = tms.FormatByMill(pam.CreateTime)
	}
	return &project.MyProjectResponse{Pm: pmm, Total: total}, nil
}
~~~

~~~go
type ProjectRepo interface {
	FindProjectByMemId(ctx context.Context, memId int64, condition string, page int64, size int64) ([]*project.ProAndMember, int64, error)
	FindCollectProjectByMemId(ctx context.Context, memId int64, page int64, size int64) ([]*project.ProAndMember, int64, error)
}

~~~

~~~go

func (p *ProjectDao) FindCollectProjectByMemId(ctx context.Context, memId int64, page int64, size int64) ([]*project.ProAndMember, int64, error) {
	session := p.conn.Session(ctx)
	index := (page - 1) * size
	sql := fmt.Sprintf("select * from ms_project where id in (select project_code from ms_project_collection where member_code=? ) order by sort limit ?,?")
	db := session.Raw(sql, memId, index, size)
	var mp []*project.ProAndMember
	err := db.Scan(&mp).Error
	var total int64
	query := fmt.Sprintf("member_code=?")
	session.Model(&project.CollectionProject{}).Where(query, memId).Count(&total)
	return mp, total, err
}

func (p ProjectDao) FindProjectByMemId(ctx context.Context, memId int64, condition string, page int64, size int64) ([]*pro.ProjectAndMember, int64, error) {
	var pms []*pro.ProjectAndMember
	session := p.conn.Session(ctx)
	index := (page - 1) * size
	sql := fmt.Sprintf("select * from ms_project a, ms_project_member b where a.id = b.project_code and b.member_code=? %s order by sort limit ?,?", condition)
	raw := session.Raw(sql, memId, index, size)
	raw.Scan(&pms)
	var total int64
	query := fmt.Sprintf("select count(*) from ms_project a, ms_project_member b where a.id = b.project_code and b.member_code=? %s", condition)
	tx := session.Raw(query, memId)
	err := tx.Scan(&total).Error
	return pms, total, err
}
~~~

~~~go

type CollectionProject struct {
	Id          int64
	ProjectCode int64
	MemberCode  int64
	CreateTime  int64
}

func (*CollectionProject) TableName() string {
	return "vex_project_collection"
}
~~~



## 3. 项目模板

创建项目的时候，可以选择一个项目模板

请求uri：project/project_template

参数：

| 名称                    | 类型   | 描述                                    |
| ----------------------- | ------ | --------------------------------------- |
| Authorization（header） | string | bearer ${token}                         |
| page                    | int    | form表单参数                            |
| pageSize                | int    | form表单参数                            |
| viewType                | string | 0 查询自定义模板 1 系统模板 -1 所有模板 |

响应：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "total":4,
        "list":[
            {
                "id":11,
                "name":"产品进展",
                "description":"适用于互联网产品人员对产品计划、跟进及发布管理",
                "sort":0,
                "create_time":"2018-04-30 22:15:10",
                "code":"d85f1bvwpml2nhxe94zu7tyi",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "cover":"http:\/\/easyproject.net\/static\/image\/default\/cover.png",
                "member_code":"",
                "is_system":1,
                "task_stages":[
                    {
                        "name":"产品计划"
                    },
                    {
                        "name":"即将发布"
                    },
                    {
                        "name":"测试"
                    },
                    {
                        "name":"准备发布"
                    },
                    {
                        "name":"发布成功"
                    }
                ]
            },
            {
                "id":12,
                "name":"需求管理",
                "description":"适用于产品部门对需求的收集、评估及反馈管理",
                "sort":0,
                "create_time":"2018-04-30 22:16:29",
                "code":"d85f1bvwpml2nhxe92zu7tyi",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "cover":"http:\/\/easyproject.net\/static\/image\/default\/cover.png",
                "member_code":"",
                "is_system":1,
                "task_stages":[
                    {
                        "name":"需求收集"
                    },
                    {
                        "name":"评估确认"
                    },
                    {
                        "name":"需求暂缓"
                    },
                    {
                        "name":"研发中"
                    },
                    {
                        "name":"内测中"
                    },
                    {
                        "name":"通知用户"
                    },
                    {
                        "name":"已完成&归档"
                    }
                ]
            },
            {
                "id":13,
                "name":"机械制造",
                "description":"适用于制造商对图纸设计及制造安装的工作流程管理",
                "sort":0,
                "create_time":"2018-04-30 22:19:06",
                "code":"d85f1bvwpml2nhxe91zu7tyi",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "cover":"http:\/\/easyproject.net\/static\/image\/default\/cover.png",
                "member_code":"",
                "is_system":1,
                "task_stages":[
                    {
                        "name":"协议签订"
                    },
                    {
                        "name":"图纸设计"
                    },
                    {
                        "name":"评审及打样"
                    },
                    {
                        "name":"构件采购"
                    },
                    {
                        "name":"制造安装"
                    },
                    {
                        "name":"内部检验"
                    },
                    {
                        "name":"验收"
                    }
                ]
            },
            {
                "id":19,
                "name":"OKR 管理",
                "description":"适用于团队的 OKR 管理",
                "sort":0,
                "create_time":"2018-12-24 16:57:49",
                "code":"un6125mxt4dcizhjqwvgyb3a",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "cover":"https:\/\/beta.vilson.xyz\/static\/upload\/\/20190103\/4c46f35da98ca0e1eeed192d8576b9c4.png",
                "member_code":"6v7be19pwman2fird04gqu53",
                "is_system":0,
                "task_stages":[
                    {
                        "name":"待处理"
                    },
                    {
                        "name":"进行中"
                    },
                    {
                        "name":"已完成"
                    }
                ]
            }
        ],
        "page":1
    }
}
~~~

### 3.1 涉及到的表

~~~sql
CREATE TABLE `vex_project_template`  (
  `id` int(0) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '类型名称',
  `description` text CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL COMMENT '备注',
  `sort` tinyint(0) NULL DEFAULT 0,
  `create_time` bigint(20)  NULL DEFAULT 0,
  `organization_code` bigint(0) NULL DEFAULT NULL COMMENT '组织id',
  `cover` varchar(511) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '封面',
  `member_code` bigint(0) NULL DEFAULT NULL COMMENT '创建人',
  `is_system` tinyint(1) NULL DEFAULT 0 COMMENT '系统默认',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 20 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci COMMENT = '项目类型表' ROW_FORMAT = COMPACT;
~~~

~~~sql
INSERT INTO `vexproject`.`vex_project_template`(`id`, `name`, `description`, `sort`, `create_time`, `organization_code`, `cover`, `member_code`, `is_system`) VALUES (11, '产品进展', '适用于互联网产品人员对产品计划、跟进及发布管理', 0, 1670904236057, 17, 'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fbpic.51yuansu.com%2Fpic3%2Fcover%2F01%2F91%2F92%2F5982adf6c88ea_610.jpg&refer=http%3A%2F%2Fbpic.51yuansu.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1673496114&t=956c5614481fedea97794e161deddb00', NULL, 1);
INSERT INTO `vexproject`.`vex_project_template`(`id`, `name`, `description`, `sort`, `create_time`, `organization_code`, `cover`, `member_code`, `is_system`) VALUES (12, '需求管理', '适用于产品部门对需求的收集、评估及反馈管理', 0, 1670904236057, 17, 'https://img0.baidu.com/it/u=437485064,4277010738&fm=253&fmt=auto&app=138&f=JPEG?w=610&h=491', NULL, 1);
INSERT INTO `vexproject`.`vex_project_template`(`id`, `name`, `description`, `sort`, `create_time`, `organization_code`, `cover`, `member_code`, `is_system`) VALUES (13, '机械制造', '适用于制造商对图纸设计及制造安装的工作流程管理', 0, 1670904236057, 17, 'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fbpic.51yuansu.com%2Fpic2%2Fcover%2F00%2F38%2F93%2F5812ca7a24020_610.jpg&refer=http%3A%2F%2Fbpic.51yuansu.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1673496114&t=6d03fb91b230058fc43f1b7ae00f73e3', NULL, 1);
INSERT INTO `vexproject`.`vex_project_template`(`id`, `name`, `description`, `sort`, `create_time`, `organization_code`, `cover`, `member_code`, `is_system`) VALUES (19, 'OKR 管理', '适用于团队的 OKR 管理', 0, 1670904236057, 17, 'https://img2.baidu.com/it/u=2241642503,1613686234&fm=253&fmt=auto&app=138&f=JPEG?w=603&h=500', 1015, 0);

~~~

~~~sql
CREATE TABLE `vex_task_stages_template`  (
  `id` int(0) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '类型名称',
  `project_template_code` int(0) NULL DEFAULT 0 COMMENT '项目id',
  `create_time` bigint(0) NULL DEFAULT NULL,
  `sort` int(0) NULL DEFAULT 0,
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 84 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci COMMENT = '任务列表模板表' ROW_FORMAT = COMPACT;
~~~

~~~sql
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (61, '待处理', 19, 1670904236057, 1);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (62, '进行中', 19, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (63, '已完成', 19, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (65, '协议签订', 13, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (66, '图纸设计', 13, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (67, '评审及打样', 13, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (68, '构件采购', 13, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (69, '制造安装', 13, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (70, '内部检验', 13, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (71, '验收', 13, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (72, '需求收集', 12, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (73, '评估确认', 12, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (74, '需求暂缓', 12, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (75, '研发中', 12, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (76, '内测中', 12, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (77, '通知用户', 12, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (78, '已完成&归档', 12, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (79, '产品计划', 11, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (80, '即将发布', 11, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (81, '测试', 11, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (82, '准备发布', 11, 1670904236057, 0);
INSERT INTO `vexproject`.`vex_task_stages_template`(`id`, `name`, `project_template_code`, `create_time`, `sort`) VALUES (83, '发布成功', 11, 1670904236057, 0);

~~~

### 3.2 实现

#### 3.2.1 模型

~~~go
package project

import (
	"test.com/project-common/encrypts"
	"test.com/project-common/tms"
	"test.com/project-project/internal/data/task"
	"test.com/project-user/pkg/model"
)

type Project struct {
	Id                 int64
	Cover              string
	Name               string
	Description        string
	AccessControlType  int
	WhiteList          string
	Sort               int
	Deleted            int
	TemplateCode       string
	Schedule           float64
	CreateTime         int64
	OrganizationCode   int64
	DeletedTime        string
	Private            int
	Prefix             string
	OpenPrefix         int
	Archive            int
	ArchiveTime        int64
	OpenBeginTime      int
	OpenTaskPrivate    int
	TaskBoardTheme     string
	BeginTime          int64
	EndTime            int64
	AutoUpdateSchedule int
}

func (*Project) TableName() string {
	return "vex_project"
}

type MemberProject struct {
	Id          int64
	ProjectCode int64
	MemberCode  int64
	JoinTime    int64
	IsOwner     int64
	Authorize   string
}

func (*MemberProject) TableName() string {
	return "vex_project_member"
}

type CollectionProject struct {
	Id          int64
	ProjectCode int64
	MemberCode  int64
	CreateTime  int64
}

func (*CollectionProject) TableName() string {
	return "vex_project_collection"
}

type ProAndMember struct {
	Project
	ProjectCode int64
	MemberCode  int64
	JoinTime    int64
	IsOwner     int64
	Authorize   string
}

func (m *ProAndMember) GetAccessControlType() string {
	if m.AccessControlType == 0 {
		return "open"
	}
	if m.AccessControlType == 1 {
		return "private"
	}
	if m.AccessControlType == 2 {
		return "custom"
	}
	return ""
}

func ToMap(orgs []*ProAndMember) map[int64]*ProAndMember {
	m := make(map[int64]*ProAndMember)
	for _, v := range orgs {
		m[v.Id] = v
	}
	return m
}

type ProjectTemplate struct {
	Id               int
	Name             string
	Description      string
	Sort             int
	CreateTime       int64
	OrganizationCode int64
	Cover            string
	MemberCode       int64
	IsSystem         int
}

func (*ProjectTemplate) TableName() string {
	return "vex_project_template"
}

type ProjectTemplateAll struct {
	Id               int
	Name             string
	Description      string
	Sort             int
	CreateTime       string
	OrganizationCode string
	Cover            string
	MemberCode       string
	IsSystem         int
	TaskStages       []*task.TaskStagesOnlyName
    Code 			 string
}


func (pt ProjectTemplate) Convert(taskStages []*task.TaskStagesOnlyName) *ProjectTemplateAll {
	organizationCode, _ := encrypts.EncryptInt64(pt.OrganizationCode, model.AESKey)
	memberCode, _ := encrypts.EncryptInt64(pt.MemberCode, model.AESKey)
	code, _ := encrypts.EncryptInt64(int64(pt.Id), model.AESKey)
	pta := &ProjectTemplateAll{
		Id:               pt.Id,
		Name:             pt.Name,
		Description:      pt.Description,
		Sort:             pt.Sort,
		CreateTime:       tms.FormatByMill(pt.CreateTime),
		OrganizationCode: organizationCode,
		Cover:            pt.Cover,
		MemberCode:       memberCode,
		IsSystem:         pt.IsSystem,
		TaskStages:       taskStages,
		Code:             code,
	}
	return pta
}
func ToProjectTemplateIds(pts []ProjectTemplate) []int {
	var ids []int
	for _, v := range pts {
		ids = append(ids, v.Id)
	}
	return ids
}

~~~

~~~go
package task

type MsTaskStagesTemplate struct {
	Id                  int
	Name                string
	ProjectTemplateCode int
	CreateTime          int64
	Sort                int
}

func (*MsTaskStagesTemplate) TableName() string {
	return "ms_task_stages_template"
}

type TaskStagesOnlyName struct {
	Name string
}

func CovertProjectMap(tsts []MsTaskStagesTemplate) map[int][]*TaskStagesOnlyName {
	var tss = make(map[int][]*TaskStagesOnlyName)
	for _, v := range tsts {
		ts := &TaskStagesOnlyName{}
		ts.Name = v.Name
		tss[v.ProjectTemplateCode] = append(tss[v.ProjectTemplateCode], ts)
	}
	return tss
}

~~~

api：

~~~go

type ProjectTemplate struct {
	Id               int                   `json:"id"`
	Name             string                `json:"name"`
	Description      string                `json:"description"`
	Sort             int                   `json:"sort"`
	CreateTime       string                `json:"create_time"`
	OrganizationCode string                `json:"organization_code"`
	Cover            string                `json:"cover"`
	MemberCode       string                `json:"member_code"`
	IsSystem         int                   `json:"is_system"`
	TaskStages       []*TaskStagesOnlyName `json:"task_stages"`
    Code             string                `json:"code"`
}

type TaskStagesOnlyName struct {
	Name string `json:"name"`
}

~~~

#### 3.2.2 proto

~~~protobuf
message ProjectRpcMessage{
  int64 memberId = 1;
  string memberName = 2;
  int64 page = 3;
  int64 pageSize = 4;
  string selectBy = 5;
  string organizationCode = 6;
  int32 viewType = 7;
}

message ProjectTemplateMessage{
  int32 id = 1;
  string name = 2;
  string description = 3;
  int32 sort = 4;
  string createTime = 5;
  string organizationCode = 6;
  string cover = 7;
  string memberCode = 8;
  int32 isSystem = 9;
  repeated TaskStages taskStages = 10;
  string code = 11;
}
message TaskStages{
  string name = 1;
}
message ProjectTemplateResponse{
  repeated ProjectTemplateMessage ptm = 1;
  int64  Total = 2;
}
service ProjectService {
  rpc Index(IndexMessage) returns (IndexResponse) {}
  rpc FindProjectByMemId(ProjectRpcMessage) returns (MyProjectResponse){}
  rpc FindProjectTemplate(ProjectRpcMessage) returns (ProjectTemplateResponse){}
}
~~~

####  3.2.3 服务实现

~~~go
type ProjectTemplateRepo interface {
	FindProjectTemplateSystem(ctx context.Context, page int64, size int64) ([]project.ProjectTemplate, int64, error)
	FindProjectTemplateCustom(ctx context.Context, memId int64, organizationCode int64, page int64, size int64) ([]project.ProjectTemplate, int64, error)
	FindProjectTemplateAll(ctx context.Context, organizationCode int64, page int64, size int64) ([]project.ProjectTemplate, int64, error)
}

~~~

~~~go
type TaskStagesTemplateRepo interface {
	FindInProTemIds(ctx context.Context, id []int) ([]task.MsTaskStagesTemplate, error)
}
~~~

~~~go
type ProjectService struct {
	project.UnimplementedProjectServiceServer
	cache                  repo.Cache
	transaction            tran.Transaction
	menuRepo               repo.MenuRepo
	projectRepo            repo.ProjectRepo
	projectTemplateRepo    repo.ProjectTemplateRepo
	taskStagesTemplateRepo repo.TaskStagesTemplateRepo
}

func New() *ProjectService {
	return &ProjectService{
		cache:                  dao.Rc,
		transaction:            dao.NewTransaction(),
		menuRepo:               dao.NewMenuDao(),
		projectRepo:            dao.NewProjectDao(),
		projectTemplateRepo:    dao.NewProjectTemplateDao(),
		taskStagesTemplateRepo: dao.NewTaskStagesTemplateDao(),
	}
}


~~~

~~~go

func (ps *ProjectService) FindProjectTemplate(ctx context.Context, msg *project.ProjectRpcMessage) (*project.ProjectTemplateResponse, error) {
	organizationCodeStr, _ := encrypts.Decrypt(msg.OrganizationCode, model.AESKey)
	organizationCode, _ := strconv.ParseInt(organizationCodeStr, 10, 64)
	page := msg.Page
	pageSize := msg.PageSize
	var pts []project2.ProjectTemplate
	var total int64
	var err error
	if msg.ViewType == -1 {
		pts, total, err = ps.projectTemplateRepo.FindProjectTemplateAll(ctx, organizationCode, page, pageSize)
	}
	if msg.ViewType == 1 {
		pts, total, err = ps.projectTemplateRepo.FindProjectTemplateSystem(ctx, page, pageSize)
	}
	if msg.ViewType == 0 {
		pts, total, err = ps.projectTemplateRepo.FindProjectTemplateCustom(ctx, msg.MemberId, organizationCode, page, pageSize)
	}
	if err != nil {
		zap.L().Error("FindProjectTemplate error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	//查询task stages数据库
	tsts, err := ps.taskStagesTemplateRepo.FindInProTemIds(ctx, project2.ToProjectTemplateIds(pts))
	if err != nil {
		zap.L().Error("FindProjectTemplate FindInProTemIds error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	var ptAll []*project2.ProjectTemplateAll
	for _, v := range pts {
		ptAll = append(ptAll, v.Convert(task.CovertProjectMap(tsts)[v.Id]))
	}
	var ptRsp []*project.ProjectTemplateMessage
	copier.Copy(&ptRsp, ptAll)
	return &project.ProjectTemplateResponse{Ptm: ptRsp, Total: total}, nil
}

~~~

~~~go
package dao

import (
	"context"
	"test.com/project-project/internal/data/project"
	"test.com/project-project/internal/database/gorms"
)

type ProjectTemplateDao struct {
	conn *gorms.GormConn
}

func (p *ProjectTemplateDao) FindProjectTemplateSystem(ctx context.Context, page int64, size int64) ([]project.ProjectTemplate, int64, error) {
	var pts []project.ProjectTemplate
	session := p.conn.Session(ctx)
	err := session.Where("is_system=?", 1).Limit(int(size)).Offset(int((page - 1) * size)).Find(&pts).Error
	var total int64
	session.Model(&project.ProjectTemplate{}).Where("is_system=?", 1).Count(&total)
	return pts, total, err
}

func (p ProjectTemplateDao) FindProjectTemplateCustom(ctx context.Context, memId int64, organizationCode int64, page int64, size int64) ([]project.ProjectTemplate, int64, error) {
	var pts []project.ProjectTemplate
	session := p.conn.Session(ctx)
	err := session.
		Where("is_system=? and member_code=? and organization_code=?", 0, memId, organizationCode).
		Limit(int(size)).
		Offset(int((page - 1) * size)).
		Find(&pts).Error
	var total int64
	session.Model(&project.ProjectTemplate{}).Where("is_system=? and member_code=? and organization_code=?", 0, memId, organizationCode).Count(&total)
	return pts, total, err
}

func (p ProjectTemplateDao) FindProjectTemplateAll(ctx context.Context, organizationCode int64, page int64, size int64) ([]project.ProjectTemplate, int64, error) {
	var pts []project.ProjectTemplate
	session := p.conn.Session(ctx)
	err := session.
		Where("organization_code=?", organizationCode).
		Limit(int(size)).
		Offset(int((page - 1) * size)).
		Find(&pts).Error
	var total int64
	session.Model(&project.ProjectTemplate{}).Where("organization_code=?", organizationCode).Count(&total)
	return pts, total, err
}

func NewProjectTemplateDao() *ProjectTemplateDao {
	return &ProjectTemplateDao{
		conn: gorms.New(),
	}
}

~~~



~~~go
package dao

import (
	"context"
	"test.com/project-project/internal/data/task"
	"test.com/project-project/internal/database/gorms"
)

type TaskStagesTemplateDao struct {
	conn *gorms.GormConn
}

func (t *TaskStagesTemplateDao) FindInProTemIds(ctx context.Context, ids []int) ([]task.MsTaskStagesTemplate, error) {
	var tsts []task.MsTaskStagesTemplate
	session := t.conn.Session(ctx)
	err := session.Where("project_template_code in ?", ids).Find(&tsts).Error
	return tsts, err
}

func NewTaskStagesTemplateDao() *TaskStagesTemplateDao {
	return &TaskStagesTemplateDao{
		conn: gorms.New(),
	}
}

~~~

#### 3.2.4 api



~~~go
group.POST("/project_template", h.projectTemplate)
~~~

~~~go
if len(orgs) > 0 {
		memMsg.OrganizationCode, _ = encrypts.EncryptInt64(orgs[0].Id, model.AESKey)
	}
~~~

~~~protobuf
message MemberMessage {
  int64 id = 1;
  string name = 2;
  string mobile = 3;
  string realname = 4;
  string account = 5;
  int32 status = 6;
  string  lastLoginTime = 7;
  string address = 8;
  int32 province = 9;
  int32 city = 10;
  int32 area = 11;
  string email = 12;
  string code = 13;
  string organizationCode = 14;
}
~~~

~~~go

func (u *HandlerProject) projectTemplate(c *gin.Context) {
	result := &common.Result{}
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	memberId := c.GetInt64("memberId")
	memberName := c.GetString("memberName")
	organizationCode := c.GetString("organizationCode")
	var page = &model.Page{}
	page.Bind(c)
	viewTypeStr := c.PostForm("viewType")
	viewType, _ := strconv.ParseInt(viewTypeStr, 10, 64)
	projectTemplateRsp, err := ProjectServiceClient.FindProjectTemplate(ctx,
		&project.ProjectRpcMessage{
			MemberId:         memberId,
			MemberName:       memberName,
			OrganizationCode: organizationCode,
			Page:             page.Page,
			PageSize:         page.PageSize,
			ViewType:         int32(viewType)})
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	var pts []*project2.ProjectTemplate
	copier.Copy(&pts, projectTemplateRsp.Ptm)
	if pts == nil {
		pts = []*project2.ProjectTemplate{}
	}
	c.JSON(http.StatusOK, result.Success(pts))
}
~~~





## 4. 创建项目

请求uri：project/project/save

参数：

| 名称                    | 类型   | 描述            |
| ----------------------- | ------ | --------------- |
| Authorization（header） | string | bearer ${token} |
| name                    | string | 项目名称        |
| templateCode            | string | 模板id          |
| description             | string | 描述            |
| id                      | int    | id              |

响应：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "create_time":"2022-12-13 16:57:26",
        "code":"g5bt7cphnxq2kfu8jd1or0v4",
        "name":"测试项目",
        "description":"这是一个测试需求管理项目",
        "organization_code":"6v7be19pwman2fird04gqu53",
        "task_board_theme":"simple",
        "cover":"http:\/\/127.0.0.1\/static\/image\/default\/project-cover.png",
        "id":"13045"
    }
}
~~~

### 4.1 实现

~~~protobuf

message SaveProjectMessage {
  int64 Id = 1;
  string Cover = 2;
  string Name = 3;
  string Description = 4;
  string Code = 5;
  string CreateTime = 6;
  string TaskBoardTheme = 7;
  string OrganizationCode = 8;
}
message ProjectRpcMessage{
  int64 memberId = 1;
  string memberName = 2;
  int64 page = 3;
  int64 pageSize = 4;
  string selectBy = 5;
  string organizationCode = 6;
  int32 viewType = 7;
  string name = 8;
  string templateCode = 9;
  string description = 10;
  int64 id = 11;
}
message MyProjectResponse{
  repeated ProjectMessage pm = 1;
  int64 total = 2;
}
message ProjectTemplateMessage{
  int32 id = 1;
  string name = 2;
  string description = 3;
  int32 sort = 4;
  string createTime = 5;
  string organizationCode = 6;
  string cover = 7;
  string memberCode = 8;
  int32 isSystem = 9;
  repeated TaskStages taskStages = 10;
  string code = 11;
}
message TaskStages{
  string name = 1;
}
message ProjectTemplateResponse{
  repeated ProjectTemplateMessage ptm = 1;
  int64  Total = 2;
}
service ProjectService {
  rpc Index(IndexMessage) returns (IndexResponse) {}
  rpc FindProjectByMemId(ProjectRpcMessage) returns (MyProjectResponse){}
  rpc FindProjectTemplate(ProjectRpcMessage) returns (ProjectTemplateResponse){}
  rpc SaveProject(ProjectRpcMessage) returns (SaveProjectMessage){}
}
~~~

~~~go

type SaveProjectRequest struct {
	Name         string `json:"name" form:"name"`
	TemplateCode string `json:"templateCode" form:"templateCode"`
	Description  string `json:"description" form:"description"`
	Id           int    `json:"id" form:"id"`
}

type SaveProject struct {
	Id               int64  `json:"id"`
	Cover            string `json:"cover"`
	Name             string `json:"name"`
	Description      string `json:"description"`
	Code             string `json:"code"`
	CreateTime       string `json:"create_time"`
	TaskBoardTheme   string `json:"task_board_theme"`
	OrganizationCode string `json:"organization_code"`
}

~~~

~~~go

func (u *HandlerProject) projectSave(c *gin.Context) {
	result := &common.Result{}
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	memberId := c.GetInt64("memberId")
	organizationCode := c.GetString("organizationCode")
	var req *project2.SaveProjectRequest
	c.ShouldBind(&req)
	msg := &project.ProjectRpcMessage{
		MemberId:         memberId,
		Name:             req.Name,
		OrganizationCode: organizationCode,
		Description:      req.Description,
		TemplateCode:     req.TemplateCode,
		Id:               int64(req.Id)}
	saveProjectMessage, err := ProjectServiceClient.SaveProject(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	var sp *project2.SaveProject
	copier.Copy(&sp, saveProjectMessage)
	c.JSON(http.StatusOK, result.Success(sp))
}
~~~

~~~go

func (ps *ProjectService) SaveProject(ctx context.Context, msg *project.ProjectRpcMessage) (*project.SaveProjectMessage, error) {
	organizationCodeStr, _ := encrypts.Decrypt(msg.OrganizationCode, model.AESKey)
	organizationCode, _ := strconv.ParseInt(organizationCodeStr, 10, 64)
	templateCodeStr, _ := encrypts.Decrypt(msg.TemplateCode, model.AESKey)
	templateCode, _ := strconv.ParseInt(templateCodeStr, 10, 64)
	pr := &project2.Project{
		Name:              msg.Name,
		Description:       msg.Description,
		TemplateCode:      int(templateCode),
		CreateTime:        time.Now().UnixMilli(),
		Cover:             "https://img2.baidu.com/it/u=792555388,2449797505&fm=253&fmt=auto&app=138&f=JPEG?w=667&h=500",
		Deleted:           model.NoDeleted,
		Archive:           model.NoArchive,
		OrganizationCode:  organizationCode,
		AccessControlType: model.Open,
		TaskBoardTheme:    model.Simple,
	}
	var rsp *project.SaveProjectMessage
	err := ps.transaction.Action(func(conn database.DbConn) error {
		err := ps.projectRepo.Save(ctx, conn, pr)
		if err != nil {
			zap.L().Error("SaveProject Save error", zap.Error(err))
			return model.DBError
		}
		pm := &project2.MemberProject{
			ProjectCode: pr.Id,
			MemberCode:  msg.MemberId,
			JoinTime:    time.Now().UnixMilli(),
			IsOwner:     msg.MemberId,
			Authorize:   "",
		}
		err = ps.projectRepo.SaveProjectMember(ctx, conn, pm)
		if err != nil {
			zap.L().Error("SaveProject SaveProjectMember error", zap.Error(err))
			return model.DBError
		}
		code, _ := encrypts.EncryptInt64(pr.Id, model.AESKey)
		rsp = &project.SaveProjectMessage{
			Id:               pr.Id,
			Code:             code,
			OrganizationCode: organizationCodeStr,
			Name:             pr.Name,
			Cover:            pr.Cover,
			CreateTime:       tms.FormatByMill(pr.CreateTime),
			TaskBoardTheme:   pr.TaskBoardTheme,
		}
		return nil
	})
	if err != nil {
		return nil, errs.GrpcError(err.(*errs.BError))
	}
	return rsp, nil
}
~~~



## 6. 读取项目

请求uri：project/project/read

参数：

| 名称                    | 类型   | 描述            |
| ----------------------- | ------ | --------------- |
| Authorization（header） | string | bearer ${token} |
| projectCode             | string | 项目id          |

响应：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "cover":"http:\/\/127.0.0.1\/static\/image\/default\/project-cover.png",
        "name":"财务管理系统",
        "code":"7mdlxqzeay96i1rbk4uovnfh",
        "description":"",
        "access_control_type":"open",
        "white_list":null,
        "order":0,
        "deleted":0,
        "template_code":"",
        "schedule":0,
        "create_time":"2022-07-26 21:24:36",
        "organization_code":"6v7be19pwman2fird04gqu53",
        "deleted_time":null,
        "private":1,
        "prefix":null,
        "open_prefix":0,
        "archive":0,
        "archive_time":null,
        "open_begin_time":0,
        "open_task_private":0,
        "task_board_theme":"simple",
        "begin_time":null,
        "end_time":null,
        "auto_update_schedule":0,
        "collected":0,
        "owner_name":"子龙",
        "owner_avatar":"https:\/\/static.vilson.xyz\/cover.png"
    }
}
~~~

### 6.1 实现

~~~go

func (p *HandlerProject) readProject(c *gin.Context) {
	result := &common.Result{}
	projectCode := c.PostForm("projectCode")
	memberId := c.GetInt64("memberId")
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	detail, err := ProjectServiceClient.FindProjectDetail(ctx, &project.ProjectRpcMessage{ProjectCode: projectCode, MemberId: memberId})
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	pd := &pro.ProjectDetail{}
	copier.Copy(pd, detail)
	c.JSON(http.StatusOK, result.Success(pd))
}
~~~

~~~protobuf

message ProjectDetailMessage{
  string Cover = 2;
  string Name = 3;
  string Description = 4;
  string AccessControlType = 5;
  string WhiteList = 6;
  int32 Order = 7;
  int32 Deleted = 8;
  string TemplateCode = 9;
  double Schedule = 10;
  string CreateTime = 11;
  string OrganizationCode = 12;
  string DeletedTime = 13;
  int32 Private = 14;
  string Prefix = 15;
  int32 OpenPrefix = 16;
  int32 Archive = 17;
  int64 ArchiveTime = 18;
  int32 OpenBeginTime = 19;
  int32 OpenTaskPrivate = 20;
  string TaskBoardTheme = 21;
  string BeginTime = 22;
  string EndTime = 23;
  int32 AutoUpdateSchedule = 24;
  string code = 25;
  string ownerName = 26;
  int32 collected = 27;
  string ownerAvatar = 28;
}
service ProjectService {
  rpc FindProjectDetail(ProjectRpcMessage) returns (ProjectDetailMessage){}
}

~~~

~~~go

//1. 查项目表
//2. 项目和成员的关联表 查到项目的拥有者 去member表查名字
//3. 查收藏表 判断收藏状态
func (ps *ProjectService) FindProjectDetail(ctx context.Context, msg *project.ProjectRpcMessage) (*project.ProjectDetailMessage, error) {
	projectCodeStr, _ := encrypts.Decrypt(msg.ProjectCode, model.AESKey)
	projectCode, _ := strconv.ParseInt(projectCodeStr, 10, 64)
	memberId := msg.MemberId
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	projectAndMember, err := ps.projectRepo.FindProjectByPIdAndMemId(c, projectCode, memberId)
	if err != nil {
		zap.L().Error("project FindProjectDetail FindProjectByPIdAndMemId error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	ownerId := projectAndMember.IsOwner
	member, err := rpc.LoginServiceClient.FindMemInfoById(c, &login.UserMessage{MemId: ownerId})
	if err != nil {
		zap.L().Error("project rpc FindProjectDetail FindMemInfoById error", zap.Error(err))
		return nil, err
	}
	//去user模块去找了
	//TODO 优化 收藏的时候 可以放入redis
	isCollect, err := ps.projectRepo.FindCollectByPidAndMemId(c, projectCode, memberId)
	if err != nil {
		zap.L().Error("project FindProjectDetail FindCollectByPidAndMemId error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	if isCollect {
		projectAndMember.Collected = model.Collected
	}
	var detailMsg = &project.ProjectDetailMessage{}
	copier.Copy(detailMsg, projectAndMember)
	detailMsg.OwnerAvatar = member.Avatar
	detailMsg.OwnerName = member.Name
	detailMsg.Code, _ = encrypts.EncryptInt64(projectAndMember.Id, model.AESKey)
	detailMsg.AccessControlType = projectAndMember.GetAccessControlType()
	detailMsg.OrganizationCode, _ = encrypts.EncryptInt64(projectAndMember.OrganizationCode, model.AESKey)
	detailMsg.Order = int32(projectAndMember.Sort)
	detailMsg.CreateTime = tms.FormatByMill(projectAndMember.CreateTime)
	return detailMsg, nil
}
~~~

~~~go

func (ls *LoginService) FindMemInfoById(ctx context.Context, msg *login.UserMessage) (*login.MemberMessage, error) {
	memberById, err := ls.memberRepo.FindMemberById(context.Background(), msg.MemId)
	if err != nil {
		zap.L().Error("TokenVerify db FindMemberById error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	memMsg := &login.MemberMessage{}
	copier.Copy(memMsg, memberById)
	memMsg.Code, _ = encrypts.EncryptInt64(memberById.Id, model.AESKey)
	orgs, err := ls.organizationRepo.FindOrganizationByMemId(context.Background(), memberById.Id)
	if err != nil {
		zap.L().Error("TokenVerify db FindMember error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	if len(orgs) > 0 {
		memMsg.OrganizationCode, _ = encrypts.EncryptInt64(orgs[0].Id, model.AESKey)
	}
	memMsg.CreateTime = tms.FormatByMill(memberById.CreateTime)
	return memMsg, nil
}

~~~



## 7. 编辑项目

请求uri：project/project/edit

参数：

| 名称                    | 类型   | 描述                                   |
| ----------------------- | ------ | -------------------------------------- |
| Authorization（header） | string | bearer ${token}                        |
| projectCode             | string | 项目id                                 |
| name                    | string | 名称                                   |
| description             | string | 描述                                   |
| cover                   | string | 封面                                   |
| private                 | int    | 1私有 0 公开                           |
| prefix                  | string | 项目前缀                               |
| task_board_theme        | string | 看板风格 simple简约 default默认        |
| open_prefix             | int    | 是否开启项目前缀 默认0不开启           |
| open_begin_time         | int    | 是否开启任务开始时间 0 不开启 1开启    |
| open_task_private       | int    | 是否开启新任务隐私模式 0 不开启 1 开启 |
| schedule                | int    | 进度                                   |
| auto_update_schedule    | int    | 自动更新进度 0 不开启 1开启            |

响应：

~~~json
{"code":200,"msg":"","data":[]}
~~~

~~~go
func (ps *ProjectService) UpdateProject(ctx context.Context, msg *project.UpdateProjectMessage) (*project.UpdateProjectResponse, error) {
	projectCodeStr, _ := encrypts.Decrypt(msg.ProjectCode, model.AESKey)
	projectCode, _ := strconv.ParseInt(projectCodeStr, 10, 64)
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	proj := &pro.Project{
		Id:                 projectCode,
		Name:               msg.Name,
		Description:        msg.Description,
		Cover:              msg.Cover,
		TaskBoardTheme:     msg.TaskBoardTheme,
		Prefix:             msg.Prefix,
		Private:            int(msg.Private),
		OpenPrefix:         int(msg.OpenPrefix),
		OpenBeginTime:      int(msg.OpenBeginTime),
		OpenTaskPrivate:    int(msg.OpenTaskPrivate),
		Schedule:           msg.Schedule,
		AutoUpdateSchedule: int(msg.AutoUpdateSchedule),
	}
	err := ps.projectRepo.UpdateProject(c, proj)
	if err != nil {
		zap.L().Error("project UpdateProject::UpdateProject error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	return &project.UpdateProjectResponse{}, nil
}
~~~

~~~go
func (p *ProjectDao) UpdateProject(ctx context.Context, proj *pro.Project) error {
	return p.conn.Session(ctx).Updates(&proj).Error
}
~~~

~~~protobuf
message UpdateProjectResponse{}


message UpdateProjectMessage{
  string projectCode = 1;
  string Cover = 2;
  string Name = 3;
  string Description = 4;
  double Schedule = 5;
  int32 Private = 6;
  string Prefix = 7;
  int32 OpenPrefix = 8;
  int32 OpenBeginTime = 9;
  int32 OpenTaskPrivate = 10;
  string TaskBoardTheme = 11;
  int32 AutoUpdateSchedule = 12;
  int64 MemberId = 13;
}

service ProjectService {
  rpc Index(IndexMessage) returns (IndexResponse) {}
  rpc FindProjectByMemId(ProjectRpcMessage) returns (MyProjectResponse){}
  rpc FindProjectTemplate(ProjectRpcMessage) returns (ProjectTemplateResponse){}
  rpc SaveProject(ProjectRpcMessage) returns (SaveProjectMessage){}
  rpc FindProjectDetail(ProjectRpcMessage) returns (ProjectDetailMessage){}
  rpc UpdateDeletedProject(ProjectRpcMessage) returns (DeletedProjectResponse){}
  rpc UpdateCollectProject(ProjectRpcMessage) returns (CollectProjectResponse){}
  rpc UpdateProject(UpdateProjectMessage) returns (UpdateProjectResponse){}
}
~~~

~~~go

func (p *HandlerProject) editProject(c *gin.Context) {
	result := &common.Result{}
	var req *pro.ProjectReq
	_ = c.ShouldBind(&req)
	memberId := c.GetInt64("memberId")
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &project.UpdateProjectMessage{}
	copier.Copy(msg, req)
	msg.MemberId = memberId
	_, err := ProjectServiceClient.UpdateProject(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	c.JSON(http.StatusOK, result.Success([]int{}))
}
~~~



## 8. 收藏项目

请求uri：project/project_collect/collect

参数：

| 名称                    | 类型   | 描述                         |
| ----------------------- | ------ | ---------------------------- |
| Authorization（header） | string | bearer ${token}              |
| projectCode             | string | 项目id                       |
| type                    | string | collect 收藏 cancel 取消收藏 |

响应：

~~~json
{"code":200,"msg":"加入收藏成功","data":[]}
~~~

~~~go

func (p *ProjectDao) DeleteProjectCollect(ctx context.Context, memId int64, projectCode int64) error {
	return p.conn.Session(ctx).Where("member_code=? and project_code=?", memId, projectCode).Delete(&pro.ProjectCollection{}).Error
}

func (p *ProjectDao) SaveProjectCollect(ctx context.Context, pc *pro.ProjectCollection) error {

	return p.conn.Session(ctx).Save(&pc).Error
}
~~~

~~~go

func (ps *ProjectService) UpdateCollectProject(ctx context.Context, msg *project.ProjectRpcMessage) (*project.CollectProjectResponse, error) {
	projectCodeStr, _ := encrypts.Decrypt(msg.ProjectCode, model.AESKey)
	projectCode, _ := strconv.ParseInt(projectCodeStr, 10, 64)
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	var err error
	if "collect" == msg.CollectType {
		pc := &pro.ProjectCollection{
			ProjectCode: projectCode,
			MemberCode:  msg.MemberId,
			CreateTime:  time.Now().UnixMilli(),
		}
		err = ps.projectRepo.SaveProjectCollect(c, pc)
	}
	if "cancel" == msg.CollectType {
		err = ps.projectRepo.DeleteProjectCollect(c, msg.MemberId, projectCode)
	}
	if err != nil {
		zap.L().Error("project UpdateCollectProject SaveProjectCollect error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	return &project.CollectProjectResponse{}, nil
}

~~~

~~~protobuf
message ProjectRpcMessage{
  int64 memberId = 1;
  string memberName = 2;
  int64 page = 3;
  int64 pageSize = 4;
  string selectBy = 5;
  string organizationCode = 6;
  int32 viewType = 7;
  string name = 8;
  string templateCode = 9;
  string description = 10;
  int64 id = 11;
  string projectCode = 12;
  bool deleted = 13;
  string collectType = 14;
}
message DeletedProjectResponse{}
message CollectProjectResponse{}
service ProjectService {
  rpc Index(IndexMessage) returns (IndexResponse) {}
  rpc FindProjectByMemId(ProjectRpcMessage) returns (MyProjectResponse){}
  rpc FindProjectTemplate(ProjectRpcMessage) returns (ProjectTemplateResponse){}
  rpc SaveProject(ProjectRpcMessage) returns (SaveProjectMessage){}
  rpc FindProjectDetail(ProjectRpcMessage) returns (ProjectDetailMessage){}
  rpc UpdateDeletedProject(ProjectRpcMessage) returns (DeletedProjectResponse){}
  rpc UpdateCollectProject(ProjectRpcMessage) returns (CollectProjectResponse){}
}
~~~

~~~go

func (p *HandlerProject) collectProject(c *gin.Context) {
	result := &common.Result{}
	projectCode := c.PostForm("projectCode")
	collectType := c.PostForm("type")
	memberId := c.GetInt64("memberId")
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	_, err := ProjectServiceClient.UpdateCollectProject(ctx, &project.ProjectRpcMessage{ProjectCode: projectCode, CollectType: collectType, MemberId: memberId})
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	c.JSON(http.StatusOK, result.Success([]int{}))
}

~~~



## 9. 放入回收站

请求uri：project/project/recycle

参数：

| 名称                    | 类型   | 描述            |
| ----------------------- | ------ | --------------- |
| Authorization（header） | string | bearer ${token} |
| projectCode             | string | 项目id          |

响应：

~~~json
{"code":200,"msg":"","data":[]}
~~~

~~~go
func (ps *ProjectService) UpdateDeletedProject(ctx context.Context, msg *project.ProjectRpcMessage) (*project.DeletedProjectResponse, error) {
	projectCodeStr, _ := encrypts.Decrypt(msg.ProjectCode, model.AESKey)
	projectCode, _ := strconv.ParseInt(projectCodeStr, 10, 64)
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	err := ps.projectRepo.UpdateDeletedProject(c, projectCode, msg.Deleted)
	if err != nil {
		zap.L().Error("project RecycleProject DeleteProject error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	return &project.DeletedProjectResponse{}, nil
}

~~~



~~~go
func (p *ProjectDao) UpdateDeletedProject(ctx context.Context, code int64, deleted bool) error {
	session := p.conn.Session(ctx)
	var err error
	if deleted {
		err = session.Model(&pro.Project{}).Where("id=?", code).Update("deleted", 1).Error
	} else {
		err = session.Model(&pro.Project{}).Where("id=?", code).Update("deleted", 0).Error
	}
	return err
}
~~~

~~~go
group.POST("/project/recycle", h.recycleProject)
	group.POST("/project/recovery", h.recoveryProject)

func (p *HandlerProject) recycleProject(c *gin.Context) {
	result := &common.Result{}
	projectCode := c.PostForm("projectCode")
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	_, err := ProjectServiceClient.UpdateDeletedProject(ctx, &project.ProjectRpcMessage{ProjectCode: projectCode, Deleted: true})
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	c.JSON(http.StatusOK, result.Success([]int{}))
}

func (p *HandlerProject) recoveryProject(c *gin.Context) {
	result := &common.Result{}
	projectCode := c.PostForm("projectCode")
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	_, err := ProjectServiceClient.UpdateDeletedProject(ctx, &project.ProjectRpcMessage{ProjectCode: projectCode, Deleted: false})
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	c.JSON(http.StatusOK, result.Success([]int{}))
}
~~~

