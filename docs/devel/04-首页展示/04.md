# 首页

## 1. 对id加密

使用AES加密

~~~go
package encrypts

import (
	"crypto/aes"
	"crypto/cipher"
	"crypto/md5"
	"encoding/hex"
	"io"
	"strconv"
)

func Md5(str string) string {
	hash := md5.New()
	_, _ = io.WriteString(hash, str)
	return hex.EncodeToString(hash.Sum(nil))
}

var commonIV = []byte{0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f}

func EncryptInt64(id int64, keyText string) (cipherStr string, err error) {
	idStr := strconv.FormatInt(id, 10)
	return Encrypt(idStr, keyText)
}
func Encrypt(plainText string, keyText string) (cipherStr string, err error) {
	// 转换成字节数据, 方便加密
	plainByte := []byte(plainText)
	keyByte := []byte(keyText)
	// 创建加密算法aes
	c, err := aes.NewCipher(keyByte)
	if err != nil {
		return "", err
	}
	//加密字符串
	cfb := cipher.NewCFBEncrypter(c, commonIV)
	cipherByte := make([]byte, len(plainByte))
	cfb.XORKeyStream(cipherByte, plainByte)
	cipherStr = hex.EncodeToString(cipherByte)
	return
}
func Decrypt(cipherStr string, keyText string) (plainText string, err error) {
	// 转换成字节数据, 方便加密
	keyByte := []byte(keyText)
	// 创建加密算法aes
	c, err := aes.NewCipher(keyByte)
	if err != nil {
		return "", err
	}
	// 解密字符串
	cfbdec := cipher.NewCFBDecrypter(c, commonIV)
	cipherByte, _ := hex.DecodeString(cipherStr)
	plainByte := make([]byte, len(cipherByte))
	cfbdec.XORKeyStream(plainByte, cipherByte)
	plainText = string(plainByte)
	return
}

~~~

测试：

~~~go
package encrypts

import (
	"fmt"
	"testing"
)

func TestEncrypt(t *testing.T) {
	plain := "100123213123"
	// AES 规定有3种长度的key: 16, 24, 32分别对应AES-128, AES-192, or AES-256
	key := "abcdefgehjhijkmlkjjwwoew"
	// 加密
	cipherByte, err := Encrypt(plain, key)
	if err != nil {
		fmt.Println(err)
	}
	fmt.Printf("%s ==> %x\n", plain, cipherByte)
	// 解密
	plainText, err := Decrypt(cipherByte, key)
	if err != nil {
		fmt.Println(err)
	}
	fmt.Printf("%x ==> %s\n", cipherByte, plainText)
}

~~~

> 在涉及到需要使用唯一标识展示数据的时候，我们对齐进行加密对外展示加密后的code，代码中使用code解密后进行使用

~~~protobuf
message MemberMessage {
  int64 id = 1;
  string name = 2;
  string mobile = 3;
  string realname = 4;
  string account = 5;
  int32 status = 6;
  int64  lastLoginTime = 7;
  string address = 8;
  int32 province = 9;
  int32 city = 10;
  int32 area = 11;
  string email = 12;
  string code = 13;
}
message OrganizationMessage {
  int64 id = 1;
  string name = 2;
  string avatar = 3;
  string description = 4;
  int64 memberId = 5;
  int64 createTime = 6;
  int32 personal = 7;
  string address = 8;
  int32 province = 9;
  int32 city = 10;
  int32 area = 11;
  string code = 13;
}
~~~

~~~go
package model

var (
	Normal         = 1
	Personal int32 = 1
	AESKey         = "abcdefgehjhijkmlkjjwwoew"
)

~~~

~~~go

func (ls *LoginService) Login(ctx context.Context, msg *login.LoginMessage) (*login.LoginResponse, error) {
	c := context.Background()
	//1.去数据库查询 账号密码是否正确
	pwd := encrypts.Md5(msg.Password)
	mem, err := ls.memberRepo.FindMember(c, msg.Account, pwd)
	if err != nil {
		zap.L().Error("Login db FindMember error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	if mem == nil {
		return nil, errs.GrpcError(model.AccountAndPwdError)
	}
	memMsg := &login.MemberMessage{}
	err = copier.Copy(memMsg, mem)
	memIdStr := strconv.FormatInt(mem.Id, 10)
	memMsg.Code, _ = encrypts.Encrypt(memIdStr, model.AESKey)
	//2.根据用户id查组织
	orgs, err := ls.organizationRepo.FindOrganizationByMemId(c, mem.Id)
	if err != nil {
		zap.L().Error("Login db FindMember error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	var orgsMessage []*login.OrganizationMessage
	err = copier.Copy(&orgsMessage, orgs)
	for _, org := range orgsMessage {
		org.Code, _ = encrypts.EncryptInt64(org.Id, model.AESKey)
	}
	//3.用jwt生成token
	exp := time.Duration(config.C.JwtConfig.AccessExp*3600*24) * time.Second
	rExp := time.Duration(config.C.JwtConfig.RefreshExp*3600*24) * time.Second
	token := jwts.CreateToken(memIdStr, exp, config.C.JwtConfig.AccessSecret, rExp, config.C.JwtConfig.RefreshSecret)
	tokenList := &login.TokenMessage{
		AccessToken:    token.AccessToken,
		RefreshToken:   token.RefreshToken,
		AccessTokenExp: token.AccessExp,
		TokenType:      "bearer",
	}
	return &login.LoginResponse{
		Member:           memMsg,
		OrganizationList: orgsMessage,
		TokenList:        tokenList,
	}, nil
}

~~~



## 1. 首页展示

接口uri：project/index

参数：

| 字段                    | 类型   | 描述            |
| ----------------------- | ------ | --------------- |
| Authorization（Header） | string | bearer ${token} |

响应：

~~~json
{
    "code":200,
    "msg":"",
    "data":[
        {
            "id":"121",
            "pid":0,
            "title":"项目管理",
            "icon":"project",
            "url":"#",
            "file_path":"#",
            "params":"",
            "node":"#",
            "sort":0,
            "status":1,
            "create_by":0,
            "create_at":"0000-00-00 00:00:00",
            "is_inner":false,
            "values":"",
            "show_slider":1,
            "statusText":"使用中",
            "innerText":"导航",
            "fullUrl":"#",
            "children":[
                {
                    "id":"122",
                    "pid":121,
                    "title":"项目列表",
                    "icon":"branches",
                    "url":"#",
                    "file_path":"#",
                    "params":"",
                    "node":"#",
                    "sort":0,
                    "status":1,
                    "create_by":0,
                    "create_at":"0000-00-00 00:00:00",
                    "is_inner":false,
                    "values":"",
                    "show_slider":1,
                    "statusText":"使用中",
                    "innerText":"导航",
                    "fullUrl":"#",
                    "children":[
                        {
                            "id":"151",
                            "pid":122,
                            "title":"我的项目",
                            "icon":"",
                            "url":"project\/list",
                            "file_path":"project\/list",
                            "params":":type",
                            "node":"project\/project\/index",
                            "sort":0,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":false,
                            "values":"my",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"project\/list\/my"
                        },
                        {
                            "id":"163",
                            "pid":122,
                            "title":"项目分析",
                            "icon":"",
                            "url":"project\/analysis",
                            "file_path":"project\/analysis",
                            "params":"",
                            "node":"project\/index\/info",
                            "sort":5,
                            "status":1,
                            "create_by":0,
                            "create_at":null,
                            "is_inner":false,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"project\/analysis"
                        },
                        {
                            "id":"155",
                            "pid":122,
                            "title":"我的收藏",
                            "icon":"",
                            "url":"project\/list",
                            "file_path":"project\/list",
                            "params":":type",
                            "node":"project\/project\/index",
                            "sort":10,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":false,
                            "values":"collect",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"project\/list\/collect"
                        },
                        {
                            "id":"159",
                            "pid":122,
                            "title":"已归档项目",
                            "icon":"",
                            "url":"project\/archive",
                            "file_path":"project\/archive",
                            "params":"",
                            "node":"project\/project\/index",
                            "sort":10,
                            "status":1,
                            "create_by":0,
                            "create_at":null,
                            "is_inner":false,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"project\/archive"
                        },
                        {
                            "id":"152",
                            "pid":122,
                            "title":"回收站",
                            "icon":"",
                            "url":"project\/recycle",
                            "file_path":"project\/recycle",
                            "params":"",
                            "node":"project\/project\/index",
                            "sort":20,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":false,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"project\/recycle"
                        },
                        {
                            "id":"127",
                            "pid":122,
                            "title":"我的组织",
                            "icon":"",
                            "url":"organization",
                            "file_path":"organization",
                            "params":"",
                            "node":"project\/organization\/index",
                            "sort":30,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":false,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"organization"
                        }
                    ]
                },
                {
                    "id":"156",
                    "pid":121,
                    "title":"基础设置",
                    "icon":"experiment",
                    "url":"#",
                    "file_path":"#",
                    "params":"",
                    "node":"#",
                    "sort":0,
                    "status":1,
                    "create_by":0,
                    "create_at":"0000-00-00 00:00:00",
                    "is_inner":false,
                    "values":"",
                    "show_slider":1,
                    "statusText":"使用中",
                    "innerText":"导航",
                    "fullUrl":"#",
                    "children":[
                        {
                            "id":"157",
                            "pid":156,
                            "title":"项目模板",
                            "icon":"",
                            "url":"project\/template",
                            "file_path":"project\/template",
                            "params":"",
                            "node":"project\/project_template\/index",
                            "sort":0,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":false,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"project\/template"
                        },
                        {
                            "id":"158",
                            "pid":156,
                            "title":"项目列表模板",
                            "icon":"",
                            "url":"project\/template\/taskStages",
                            "file_path":"project\/template\/taskStages",
                            "params":":code",
                            "node":"project\/task_stages_template\/index",
                            "sort":0,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":true,
                            "values":"",
                            "show_slider":0,
                            "statusText":"使用中",
                            "innerText":"内页",
                            "fullUrl":"project\/template\/taskStages"
                        }
                    ]
                },
                {
                    "id":"153",
                    "pid":121,
                    "title":"项目空间",
                    "icon":"heat-map",
                    "url":"project\/space\/task",
                    "file_path":"project\/space\/task",
                    "params":":code",
                    "node":"#",
                    "sort":20,
                    "status":1,
                    "create_by":0,
                    "create_at":"0000-00-00 00:00:00",
                    "is_inner":true,
                    "values":"",
                    "show_slider":1,
                    "statusText":"使用中",
                    "innerText":"内页",
                    "fullUrl":"project\/space\/task",
                    "children":[
                        {
                            "id":"154",
                            "pid":153,
                            "title":"任务详情",
                            "icon":"",
                            "url":"project\/space\/task\/:code\/detail",
                            "file_path":"project\/space\/taskdetail",
                            "params":":code",
                            "node":"project\/task\/read",
                            "sort":0,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":true,
                            "values":"",
                            "show_slider":0,
                            "statusText":"使用中",
                            "innerText":"内页",
                            "fullUrl":"project\/space\/task\/:code\/detail"
                        },
                        {
                            "id":"162",
                            "pid":153,
                            "title":"项目文件",
                            "icon":"",
                            "url":"project\/space\/files",
                            "file_path":"project\/space\/files",
                            "params":":code",
                            "node":"project\/index\/info",
                            "sort":10,
                            "status":1,
                            "create_by":0,
                            "create_at":null,
                            "is_inner":true,
                            "values":"",
                            "show_slider":0,
                            "statusText":"使用中",
                            "innerText":"内页",
                            "fullUrl":"project\/space\/files"
                        },
                        {
                            "id":"161",
                            "pid":153,
                            "title":"项目概况",
                            "icon":"",
                            "url":"project\/space\/overview",
                            "file_path":"project\/space\/overview",
                            "params":":code",
                            "node":"project\/index\/info",
                            "sort":20,
                            "status":1,
                            "create_by":0,
                            "create_at":null,
                            "is_inner":true,
                            "values":"",
                            "show_slider":0,
                            "statusText":"使用中",
                            "innerText":"内页",
                            "fullUrl":"project\/space\/overview"
                        },
                        {
                            "id":"168",
                            "pid":153,
                            "title":"版本管理",
                            "icon":"",
                            "url":"project\/space\/features",
                            "file_path":"project\/space\/features",
                            "params":":code",
                            "node":"project\/index\/info",
                            "sort":20,
                            "status":1,
                            "create_by":0,
                            "create_at":null,
                            "is_inner":true,
                            "values":"",
                            "show_slider":0,
                            "statusText":"使用中",
                            "innerText":"内页",
                            "fullUrl":"project\/space\/features"
                        }
                    ]
                },
                {
                    "id":"138",
                    "pid":121,
                    "title":"消息提醒",
                    "icon":"info-circle-o",
                    "url":"#",
                    "file_path":"#",
                    "params":"",
                    "node":"#",
                    "sort":30,
                    "status":1,
                    "create_by":0,
                    "create_at":"0000-00-00 00:00:00",
                    "is_inner":false,
                    "values":"",
                    "show_slider":1,
                    "statusText":"使用中",
                    "innerText":"导航",
                    "fullUrl":"#",
                    "children":[
                        {
                            "id":"139",
                            "pid":138,
                            "title":"站内消息",
                            "icon":"",
                            "url":"notify\/notice",
                            "file_path":"notify\/notice",
                            "params":"",
                            "node":"project\/notify\/index",
                            "sort":0,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":false,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"notify\/notice"
                        },
                        {
                            "id":"140",
                            "pid":138,
                            "title":"系统公告",
                            "icon":"",
                            "url":"notify\/system",
                            "file_path":"notify\/system",
                            "params":"",
                            "node":"project\/notify\/index",
                            "sort":10,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":false,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"notify\/system"
                        }
                    ]
                }
            ]
        },
        {
            "id":"160",
            "pid":0,
            "title":"团队成员",
            "icon":"team",
            "url":"#",
            "file_path":"#",
            "params":"",
            "node":"#",
            "sort":0,
            "status":1,
            "create_by":0,
            "create_at":null,
            "is_inner":true,
            "values":"",
            "show_slider":0,
            "statusText":"使用中",
            "innerText":"内页",
            "fullUrl":"#",
            "children":[
                {
                    "id":"164",
                    "pid":160,
                    "title":"团队成员",
                    "icon":"",
                    "url":"#",
                    "file_path":"#",
                    "params":"",
                    "node":"#",
                    "sort":0,
                    "status":1,
                    "create_by":0,
                    "create_at":null,
                    "is_inner":true,
                    "values":"",
                    "show_slider":0,
                    "statusText":"使用中",
                    "innerText":"内页",
                    "fullUrl":"#",
                    "children":[
                        {
                            "id":"166",
                            "pid":164,
                            "title":"团队成员",
                            "icon":"",
                            "url":"members",
                            "file_path":"members",
                            "params":"",
                            "node":"project\/department\/index",
                            "sort":0,
                            "status":1,
                            "create_by":0,
                            "create_at":null,
                            "is_inner":true,
                            "values":"",
                            "show_slider":0,
                            "statusText":"使用中",
                            "innerText":"内页",
                            "fullUrl":"members"
                        },
                        {
                            "id":"167",
                            "pid":164,
                            "title":"成员信息",
                            "icon":"",
                            "url":"members\/profile",
                            "file_path":"members\/profile",
                            "params":":code",
                            "node":"project\/department\/read",
                            "sort":0,
                            "status":1,
                            "create_by":0,
                            "create_at":null,
                            "is_inner":true,
                            "values":"",
                            "show_slider":0,
                            "statusText":"使用中",
                            "innerText":"内页",
                            "fullUrl":"members\/profile"
                        }
                    ]
                }
            ]
        },
        {
            "id":"124",
            "pid":0,
            "title":"系统设置",
            "icon":"setting",
            "url":"#",
            "file_path":"#",
            "params":"",
            "node":"#",
            "sort":100,
            "status":1,
            "create_by":0,
            "create_at":"0000-00-00 00:00:00",
            "is_inner":false,
            "values":"",
            "show_slider":1,
            "statusText":"使用中",
            "innerText":"导航",
            "fullUrl":"#",
            "children":[
                {
                    "id":"143",
                    "pid":124,
                    "title":"系统管理",
                    "icon":"appstore",
                    "url":"#",
                    "file_path":"#",
                    "params":"",
                    "node":"#",
                    "sort":0,
                    "status":1,
                    "create_by":0,
                    "create_at":"0000-00-00 00:00:00",
                    "is_inner":false,
                    "values":"",
                    "show_slider":1,
                    "statusText":"使用中",
                    "innerText":"导航",
                    "fullUrl":"#",
                    "children":[
                        {
                            "id":"144",
                            "pid":143,
                            "title":"菜单路由",
                            "icon":"",
                            "url":"system\/config\/menu",
                            "file_path":"system\/config\/menu",
                            "params":"",
                            "node":"project\/menu\/menuadd",
                            "sort":0,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":false,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"system\/config\/menu"
                        },
                        {
                            "id":"145",
                            "pid":143,
                            "title":"访问节点",
                            "icon":"",
                            "url":"system\/config\/node",
                            "file_path":"system\/config\/node",
                            "params":"",
                            "node":"project\/node\/save",
                            "sort":0,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":false,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"system\/config\/node"
                        }
                    ]
                },
                {
                    "id":"148",
                    "pid":124,
                    "title":"个人管理",
                    "icon":"user",
                    "url":"#",
                    "file_path":"#",
                    "params":"",
                    "node":"#",
                    "sort":0,
                    "status":1,
                    "create_by":0,
                    "create_at":"0000-00-00 00:00:00",
                    "is_inner":false,
                    "values":"",
                    "show_slider":1,
                    "statusText":"使用中",
                    "innerText":"导航",
                    "fullUrl":"#",
                    "children":[
                        {
                            "id":"149",
                            "pid":148,
                            "title":"个人设置",
                            "icon":"",
                            "url":"account\/setting\/base",
                            "file_path":"account\/setting\/base",
                            "params":"",
                            "node":"project\/index\/editpersonal",
                            "sort":0,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":false,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"account\/setting\/base"
                        },
                        {
                            "id":"150",
                            "pid":148,
                            "title":"安全设置",
                            "icon":"",
                            "url":"account\/setting\/security",
                            "file_path":"account\/setting\/security",
                            "params":"",
                            "node":"project\/index\/editpersonal",
                            "sort":0,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":true,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"内页",
                            "fullUrl":"account\/setting\/security"
                        }
                    ]
                },
                {
                    "id":"125",
                    "pid":124,
                    "title":"成员管理",
                    "icon":"unlock",
                    "url":"#",
                    "file_path":"#",
                    "params":"",
                    "node":"#",
                    "sort":10,
                    "status":1,
                    "create_by":0,
                    "create_at":"0000-00-00 00:00:00",
                    "is_inner":false,
                    "values":"",
                    "show_slider":1,
                    "statusText":"使用中",
                    "innerText":"导航",
                    "fullUrl":"#",
                    "children":[
                        {
                            "id":"126",
                            "pid":125,
                            "title":"账号列表",
                            "icon":"",
                            "url":"system\/account",
                            "file_path":"system\/account",
                            "params":"",
                            "node":"project\/account\/index",
                            "sort":10,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":false,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"system\/account"
                        },
                        {
                            "id":"130",
                            "pid":125,
                            "title":"访问授权",
                            "icon":"",
                            "url":"system\/account\/auth",
                            "file_path":"system\/account\/auth",
                            "params":"",
                            "node":"project\/auth\/index",
                            "sort":20,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":false,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"导航",
                            "fullUrl":"system\/account\/auth"
                        },
                        {
                            "id":"131",
                            "pid":125,
                            "title":"授权页面",
                            "icon":"",
                            "url":"system\/account\/apply",
                            "file_path":"system\/account\/apply",
                            "params":":id",
                            "node":"project\/auth\/apply",
                            "sort":30,
                            "status":1,
                            "create_by":0,
                            "create_at":"0000-00-00 00:00:00",
                            "is_inner":true,
                            "values":"",
                            "show_slider":1,
                            "statusText":"使用中",
                            "innerText":"内页",
                            "fullUrl":"system\/account\/apply"
                        }
                    ]
                }
            ]
        }
    ]
}
~~~

### 1.1 涉及到的表

菜单表，sql文件在本笔记的资料中有

### 1.3 接口实现

~~~go
package user

import (
	"google.golang.org/grpc"
	"google.golang.org/grpc/credentials/insecure"
	"google.golang.org/grpc/resolver"
	"log"
	"test.com/project-api/config"
	"test.com/project-common/discovery"
	"test.com/project-common/logs"
	"test.com/project-grpc/project"
)

var ProjectServiceClient project.ProjectServiceClient

func InitRpcProjectClient() {
	etcdRegister := discovery.NewResolver(config.C.EtcdConfig.Addrs, logs.LG)
	resolver.Register(etcdRegister)

	conn, err := grpc.Dial("etcd:///project", grpc.WithTransportCredentials(insecure.NewCredentials()))
	if err != nil {
		log.Fatalf("did not connect: %v", err)
	}
	ProjectServiceClient = project.NewProjectServiceClient(conn)
}

~~~



~~~go
package user

import (
	"github.com/gin-gonic/gin"
	"log"
	"test.com/project-api/router"
)

type RouterProject struct {
}

func init() {
	log.Println("init project router")
	ru := &RouterProject{}
	router.Register(ru)
}

func (*RouterProject) Route(r *gin.Engine) {
	//初始化grpc的客户端连接
	InitRpcProjectClient()
	h := New()
	r.POST("/project/index", h.index)
}

~~~

~~~go
package user

import (
	"context"
	"github.com/gin-gonic/gin"
	"net/http"
	common "test.com/project-common"
	"test.com/project-common/errs"
	"test.com/project-grpc/project"
	"time"
)

type HandlerProject struct {
}

func New() *HandlerProject {
	return &HandlerProject{}
}

func (u *HandlerProject) index(c *gin.Context) {
	result := &common.Result{}
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &project.IndexMessage{}
	indexResponse, err := ProjectServiceClient.Index(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	c.JSON(http.StatusOK, result.Success(indexResponse.Menus))
}

~~~

### 1.4 proto文件

~~~protobuf
syntax = "proto3";
package project.service.v1;
option go_package = "project-project/pkg/service/project.service.v1";


message IndexMessage{
  string token = 1;
}
message MenuMessage {
  int64  id = 1;
  int64 pid = 2;
  string title = 3;
  string icon = 4;
  string url = 5;
  string filePath = 6;
  string params = 7;
  string node = 8;
  int32 sort = 9;
  int32 status = 10;
  int64 createBy = 11;
  int32 isInner = 12;
  string values = 13;
  int32 showSlider = 14;
  repeated MenuMessage children = 15;
}
message IndexResponse{
  repeated MenuMessage menus = 1;
}
service ProjectService {
  rpc Index(IndexMessage) returns (IndexResponse) {}
}

~~~

### 1.5 服务实现

~~~go
package menu

import "github.com/jinzhu/copier"

type ProjectMenu struct {
	Id         int64
	Pid        int64
	Title      string
	Icon       string
	Url        string
	FilePath   string
	Params     string
	Node       string
	Sort       int
	Status     int
	CreateBy   int64
	IsInner    int
	Values     string
	ShowSlider int
}

func (*ProjectMenu) TableName() string {
	return "ms_project_menu"
}

type ProjectMenuChild struct {
	ProjectMenu
	Children []*ProjectMenuChild
}

func CovertChild(pms []*ProjectMenu) []*ProjectMenuChild {
	var pmcs []*ProjectMenuChild
	copier.Copy(&pmcs, pms)
	var childPmcs []*ProjectMenuChild
	//递归
	for _, v := range pmcs {
		if v.Pid == 0 {
			pmc := &ProjectMenuChild{}
			copier.Copy(pmc, v)
			childPmcs = append(childPmcs, pmc)
		}
	}
	toChild(childPmcs, pmcs)
	return childPmcs
}

func toChild(childPmcs []*ProjectMenuChild, pmcs []*ProjectMenuChild) {
	for _, pmc := range childPmcs {
		for _, pm := range pmcs {
			if pmc.Id == pm.Pid {
				child := &ProjectMenuChild{}
				copier.Copy(child, pm)
				pmc.Children = append(pmc.Children, child)
			}
		}
		toChild(pmc.Children, pmcs)
	}
}

~~~

~~~go
package dao

import (
	"context"
	"test.com/project-project/internal/data/menu"
	"test.com/project-project/internal/database/gorms"
)

type MenuDao struct {
	conn *gorms.GormConn
}

func NewMenuDao() *MenuDao {
	return &MenuDao{
		conn: gorms.New(),
	}
}

func (m *MenuDao) FindAll(ctx context.Context) ([]*menu.ProjectMenu, error) {
	var pms []*menu.ProjectMenu
	err := m.conn.Session(ctx).Find(&pms).Error
	return pms, err
}

~~~

~~~go
package repo

import (
	"context"
	"test.com/project-project/internal/data/menu"
)

type MenuRepo interface {
	FindAll(ctx context.Context) ([]*menu.ProjectMenu, error)
}

~~~

~~~go
package project_service_v1

import (
	"context"
	"fmt"
	"github.com/jinzhu/copier"
	"go.uber.org/zap"
	"test.com/project-grpc/project"
	"test.com/project-project/internal/dao"
	"test.com/project-project/internal/data/menu"
	"test.com/project-project/internal/database/tran"
	"test.com/project-project/internal/repo"
)

type ProjectService struct {
	project.UnimplementedProjectServiceServer
	cache       repo.Cache
	transaction tran.Transaction
	menuRepo    repo.MenuRepo
}

func New() *ProjectService {
	return &ProjectService{
		cache:       dao.Rc,
		transaction: dao.NewTransaction(),
		menuRepo:    dao.NewMenuDao(),
	}
}

func (c *ProjectService) Index(ctx context.Context, in *project.IndexMessage) (*project.IndexResponse, error) {
	projectMenus, err := c.menuRepo.FindAll(ctx)
	if err != nil {
		zap.L().Error("menu findAll error", zap.Error(err))
		return nil, err
	}
	child := menu.CovertChild(projectMenus)
	for _, v := range child {
		fmt.Printf("%v \n", v)
		for _, c := range v.Children {
			fmt.Printf("child : %v \n", c)
		}
	}
	var mms []*project.MenuMessage
	copier.Copy(&mms, child)
	return &project.IndexResponse{
		Menus: mms,
	}, nil

}

~~~

### 1.6 验证用户是否登录

~~~go
package midd

import (
	"context"
	"github.com/gin-gonic/gin"
	"net/http"
	"test.com/project-api/api/user"
	common "test.com/project-common"
	"test.com/project-common/errs"
	"test.com/project-grpc/user/login"
)

func TokenVerify() func(c *gin.Context) {
	return func(c *gin.Context) {
		result := &common.Result{}
		token := c.GetHeader("authorization")
		//验证用户是否已经登录
		member, err2 := user.LoginServiceClient.TokenVerify(context.Background(), &login.TokenVerifyMessage{Token: token})
		if err2 != nil {
			code, msg := errs.ParseGrpcError(err2)
			c.JSON(http.StatusOK, result.Fail(code, msg))
			c.Abort()
			return
		}
		c.Set("memberId", member.Member.Id)
		c.Next()
	}
}

~~~

~~~go
func (*RouterProject) Route(r *gin.Engine) {
	//初始化grpc的客户端连接
	InitRpcProjectClient()
	h := New()
	group := r.Group("/project/index")
	group.Use(midd.TokenVerify())
	group.POST("/", h.index)
}
~~~

~~~protobuf
message TokenVerifyMessage{
  string token = 1;
}
message TokenVerifyResponse{
    MemberMessage member = 1;
}
message IndexResponse{}
service LoginService {
  rpc GetCaptcha(CaptchaMessage) returns (CaptchaResponse) {}
  rpc Register(RegisterMessage) returns (RegisterResponse) {}
  rpc Login(LoginMessage) returns (LoginResponse) {}
  rpc Index(IndexMessage) returns (IndexResponse) {}
  rpc TokenVerify(TokenVerifyMessage) returns (TokenVerifyResponse) {}
}

~~~

~~~go


func (l *LoginService) TokenVerify(ctx context.Context, msg *login.TokenVerifyMessage) (*login.TokenVerifyResponse, error) {
	token := msg.Token
	if token == "" {
		return nil, errs.GrpcError(model.NoLogin)
	}
	parseToken, err := jwts.ParseToken(token, config.C.JwtConfig.AccessSecret)
	if err != nil {
		zap.L().Error("TokenVerify ParseToken err", zap.Error(err))
		return nil, errs.GrpcError(model.NoLogin)
	}
	memId, err := strconv.ParseInt(parseToken, 10, 64)
	if err != nil {
		zap.L().Error("TokenVerify ParseInt err", zap.Error(err))
		return nil, errs.GrpcError(model.NoLogin)
	}
	c := context.Background()
	mem, err := l.memberRepo.FindMemberById(c, memId)
	if err != nil {
		zap.L().Error("Login db FindMemberById error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	if mem == nil {
		zap.L().Error("TokenVerify member is nil")
		return nil, errs.GrpcError(model.NoLogin)
	}
	memMsg := &login.MemberMessage{}
	_ = copier.Copy(memMsg, mem)
	return &login.TokenVerifyResponse{Member: memMsg}, nil

}

~~~

~~~go
func (m *MemberDao) FindMemberById(ctx context.Context, id int64) (*member.Member, error) {
	var mem *member.Member
	err := m.conn.Session(ctx).Where("id=?", id).First(&mem).Error
	if err == gorm.ErrRecordNotFound {
		return nil, nil
	}
	return mem, err
}
~~~

~~~go

func ParseToken(tokenString string, secret string) (string, error) {
	token, err := jwt.Parse(tokenString, func(token *jwt.Token) (interface{}, error) {
		// Don't forget to validate the alg is what you expect:
		if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {
			return nil, fmt.Errorf("Unexpected signing method: %v", token.Header["alg"])
		}

		// hmacSampleSecret is a []byte containing your secret, e.g. []byte("my_secret_key")
		return []byte(secret), nil
	})

	if claims, ok := token.Claims.(jwt.MapClaims); ok && token.Valid {
		token := claims["token"].(string)
		var exp = claims["exp"].(int64)
		if exp <= time.Now().Unix() {
			return "", errors.New("token已过期")
		}
		return token, nil

	} else {
		return "", err
	}
}

~~~

## 2. 我的项目列表

请求uri：project/project/selfList

参数：

| 字段                    | 类型   | 描述            |
| ----------------------- | ------ | --------------- |
| Authorization（Header） | string | bearer ${token} |
| page(form表单)          | int    | 当前页数        |
| pageSize(form表单)      | int    | 每页显示数量    |

响应：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "list":[
            {
                "id":13044,
                "cover":"http:\/\/127.0.0.1\/static\/image\/default\/project-cover.png",
                "name":"12312",
                "code":"lbevtfoz618xr7su3ih0mpnc",
                "description":"",
                "access_control_type":"open",
                "white_list":null,
                "order":0,
                "deleted":0,
                "template_code":"",
                "schedule":0,
                "create_time":"2022-07-26 21:30:59",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "deleted_time":null,
                "private":1,
                "prefix":null,
                "open_prefix":0,
                "archive":0,
                "archive_time":null,
                "open_begin_time":0,
                "open_task_private":0,
                "task_board_theme":"simple",
                "begin_time":null,
                "end_time":null,
                "auto_update_schedule":0,
                "project_code":null,
                "member_code":null,
                "join_time":"2022-07-26 21:30:59",
                "is_owner":1,
                "authorize":null,
                "owner_name":"子龙",
                "collected":0
            },
            {
                "id":13043,
                "cover":"http:\/\/127.0.0.1\/static\/image\/default\/project-cover.png",
                "name":"财务管理系统",
                "code":"7mdlxqzeay96i1rbk4uovnfh",
                "description":"",
                "access_control_type":"open",
                "white_list":null,
                "order":0,
                "deleted":0,
                "template_code":"",
                "schedule":0,
                "create_time":"2022-07-26 21:24:36",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "deleted_time":null,
                "private":1,
                "prefix":null,
                "open_prefix":0,
                "archive":0,
                "archive_time":null,
                "open_begin_time":0,
                "open_task_private":0,
                "task_board_theme":"simple",
                "begin_time":null,
                "end_time":null,
                "auto_update_schedule":0,
                "project_code":null,
                "member_code":null,
                "join_time":"2022-07-26 21:24:36",
                "is_owner":1,
                "authorize":null,
                "owner_name":"子龙",
                "collected":0
            }
        ],
        "total":2
    }
}
~~~

access_control_type有三个值`open`,`private`,`custom`

### 2.1 涉及到的表

~~~sql
CREATE TABLE `ms_project`  (
  `id` bigint(0) UNSIGNED NOT NULL AUTO_INCREMENT,
  `cover` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '封面',
  `name` varchar(90) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '名称',
  `description` text CHARACTER SET utf8 COLLATE utf8_general_ci NULL COMMENT '描述',
  `access_control_type` tinyint(0) NULL DEFAULT 0 COMMENT '访问控制l类型',
  `white_list` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '可以访问项目的权限组（白名单）',
  `order` int(0) UNSIGNED NULL DEFAULT 0 COMMENT '排序',
  `deleted` tinyint(1) NULL DEFAULT 0 COMMENT '删除标记',
  `template_code` varchar(30) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT '' COMMENT '项目类型',
  `schedule` double(5, 2) NULL DEFAULT 0.00 COMMENT '进度',
  `create_time` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '创建时间',
  `organization_code` bigint(0) NULL DEFAULT NULL COMMENT '组织id',
  `deleted_time` varchar(30) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '删除时间',
  `private` tinyint(1) NULL DEFAULT 1 COMMENT '是否私有',
  `prefix` varchar(10) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '项目前缀',
  `open_prefix` tinyint(1) NULL DEFAULT 0 COMMENT '是否开启项目前缀',
  `archive` tinyint(1) NULL DEFAULT 0 COMMENT '是否归档',
  `archive_time` bigint(0) NULL DEFAULT NULL COMMENT '归档时间',
  `open_begin_time` tinyint(1) NULL DEFAULT 0 COMMENT '是否开启任务开始时间',
  `open_task_private` tinyint(1) NULL DEFAULT 0 COMMENT '是否开启新任务默认开启隐私模式',
  `task_board_theme` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT 'default' COMMENT '看板风格',
  `begin_time` bigint(0) NULL DEFAULT NULL COMMENT '项目开始日期',
  `end_time` bigint(0) NULL DEFAULT NULL COMMENT '项目截止日期',
  `auto_update_schedule` tinyint(1) NULL DEFAULT 0 COMMENT '自动更新项目进度',
  PRIMARY KEY (`id`) USING BTREE,
  INDEX `project`(`order`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 13043 CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '项目表' ROW_FORMAT = COMPACT;
~~~

~~~sql
CREATE TABLE `ms_project_member`  (
  `id` bigint(0) NOT NULL AUTO_INCREMENT,
  `project_code` bigint(0) NULL DEFAULT NULL COMMENT '项目id',
  `member_code` bigint(0) NULL DEFAULT NULL COMMENT '成员id',
  `join_time` bigint(0) NULL DEFAULT NULL COMMENT '加入时间',
  `is_owner` bigint(0) NULL DEFAULT 0 COMMENT '拥有者',
  `authorize` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '角色',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE INDEX `unique`(`project_code`, `member_code`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 37 CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '项目-成员表' ROW_FORMAT = COMPACT;
~~~

### 2.2 model生成器

根据需要，自己写一个从数据库结构到model和proto message的生成器，节省时间

~~~go
package code_gen

import (
	"fmt"
	"gorm.io/driver/mysql"
	"gorm.io/gorm"
	"gorm.io/gorm/logger"
	"html/template"
	"log"
	"os"
	"strings"
)

func connectMysql() *gorm.DB {
	//配置MySQL连接参数
	username := "root"    //账号
	password := "root"    //密码
	host := "127.0.0.1"   //数据库地址，可以是Ip或者域名
	port := 3309          //数据库端口
	Dbname := "msproject" //数据库名
	dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8&parseTime=True&loc=Local", username, password, host, port, Dbname)
	fmt.Println(dsn)
	var err error
	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{
		Logger: logger.Default.LogMode(logger.Info),
	})
	if err != nil {
		panic("连接数据库失败, error=" + err.Error())
	}
	return db
}

type Result struct {
	Field string
	Type  string
}
type StructResult struct {
	StructName string
	Result     []*Result
}
type MessageResult struct {
	MessageName string
	Result      []*Result
}

func GenStruct(table string, structName string) {
	db := connectMysql()
	var results []*Result
	db.Raw(fmt.Sprintf("describe %s", table)).Scan(&results)
	for _, v := range results {
		v.Field = Name(v.Field)
		v.Type = getType(v.Type)
	}
	tmpl, err := template.ParseFiles("./struct.tpl")
	log.Println(err)
	sr := StructResult{StructName: structName, Result: results}
	tmpl.Execute(os.Stdout, sr)
}

func GenProtoMessage(table string, messageName string) {
	db := connectMysql()
	var results []*Result
	db.Raw(fmt.Sprintf("describe %s", table)).Scan(&results)
	for _, v := range results {
		v.Field = Name(v.Field)
		v.Type = getMessageType(v.Type)
	}
	var fm template.FuncMap = make(map[string]any)
	fm["Add"] = func(v int, add int) int {
		return v + add
	}
	t := template.New("message.tpl")
	t.Funcs(fm)
	tmpl, err := t.ParseFiles("./message.tpl")
	log.Println(err)
	sr := MessageResult{MessageName: messageName, Result: results}
	err = tmpl.Execute(os.Stdout, sr)
	log.Println(err)
}

func getMessageType(t string) string {
	if strings.Contains(t, "bigint") {
		return "int64"
	}
	if strings.Contains(t, "varchar") {
		return "string"
	}
	if strings.Contains(t, "text") {
		return "string"
	}
	if strings.Contains(t, "tinyint") {
		return "int32"
	}
	if strings.Contains(t, "int") &&
		!strings.Contains(t, "tinyint") &&
		!strings.Contains(t, "bigint") {
		return "int32"
	}
	if strings.Contains(t, "double") {
		return "double"
	}
	return ""
}

func getType(t string) string {
	if strings.Contains(t, "bigint") {
		return "int64"
	}
	if strings.Contains(t, "varchar") {
		return "string"
	}
	if strings.Contains(t, "text") {
		return "string"
	}
	if strings.Contains(t, "tinyint") {
		return "int"
	}
	if strings.Contains(t, "int") &&
		!strings.Contains(t, "tinyint") &&
		!strings.Contains(t, "bigint") {
		return "int"
	}
	if strings.Contains(t, "double") {
		return "float64"
	}
	return ""
}

func Name(name string) string {
	var names = name[:]
	isSkip := false
	var sb strings.Builder
	for index, value := range names {
		if index == 0 {
			s := names[:index+1]
			s = strings.ToUpper(s)
			sb.WriteString(s)
			continue
		}
		if isSkip {
			isSkip = false
			continue
		}
		if value == 95 {
			s := names[index+1 : index+2]
			s = strings.ToUpper(s)
			sb.WriteString(s)
			isSkip = true
			continue
		} else {
			s := names[index : index+1]
			sb.WriteString(s)
		}
	}
	return sb.String()
}

~~~

~~~go
package project

type Project struct {
	Id                 int64
	Cover              string
	Name               string
	Description        string
	AccessControlType  int
	WhiteList          string
	Order              int
	Deleted            int
	TemplateCode       string
	Schedule           float64
	CreateTime         string
	OrganizationCode   int64
	DeletedTime        string
	Private            int
	Prefix             string
	OpenPrefix         int
	Archive            int
	ArchiveTime        int64
	OpenBeginTime      int
	OpenTaskPrivate    int
	TaskBoardTheme     string
	BeginTime          int64
	EndTime            int64
	AutoUpdateSchedule int
}

func (*Project) TableName() string {
	return "ms_project"
}

type MemberProject struct {
	Id          int64
	ProjectCode int64
	MemberCode  int64
	JoinTime    int64
	IsOwner     int64
	Authorize   string
}

func (*MemberProject) TableName() string {
	return "ms_project_member"
}

~~~

### 2.3 proto文件



~~~protobuf
syntax = "proto3";
package project.service.v1;
option go_package = "project-project/pkg/service/project.service.v1";


message IndexMessage{
  string token = 1;
}
message MenuMessage {
  int64  id = 1;
  int64 pid = 2;
  string title = 3;
  string icon = 4;
  string url = 5;
  string filePath = 6;
  string params = 7;
  string node = 8;
  int32 sort = 9;
  int32 status = 10;
  int64 createBy = 11;
  int32 isInner = 12;
  string values = 13;
  int32 showSlider = 14;
  repeated MenuMessage children = 15;
}
message IndexResponse{
  repeated MenuMessage menus = 1;
}

message ProjectMessage {
  int64 Id = 1;
  string Cover = 2;
  string Name = 3;
  string Description = 4;
  int32 AccessControlType = 5;
  string WhiteList = 6;
  int32 Order = 7;
  int32 Deleted = 8;
  string TemplateCode = 9;
  double Schedule = 10;
  string CreateTime = 11;
  int64 OrganizationCode = 12;
  string DeletedTime = 13;
  int32 Private = 14;
  string Prefix = 15;
  int32 OpenPrefix = 16;
  int32 Archive = 17;
  int64 ArchiveTime = 18;
  int32 OpenBeginTime = 19;
  int32 OpenTaskPrivate = 20;
  string TaskBoardTheme = 21;
  int64 BeginTime = 22;
  int64 EndTime = 23;
  int32 AutoUpdateSchedule = 24;
  int64 ProjectCode = 25;
  int64 MemberCode = 26;
  int64 JoinTime  = 27;
  int64 IsOwner = 28;
  string Authorize = 29;
  string code = 30;
}

message ProjectRpcMessage{
  int64 memberId = 1;
  int64 page = 2;
  int64 pageSize = 3;
}
message MyProjectResponse{
  repeated ProjectMessage pm = 1;
  int64 total = 2;
}
service ProjectService {
  rpc Index(IndexMessage) returns (IndexResponse) {}
  rpc FindProjectByMemId(ProjectRpcMessage) returns (MyProjectResponse){}
}

~~~

### 2.4 实现

~~~go

type ProjectService struct {
	project.UnimplementedProjectServiceServer
	cache       repo.Cache
	transaction tran.Transaction
	menuRepo    repo.MenuRepo
	projectRepo repo.ProjectRepo
}

func New() *ProjectService {
	return &ProjectService{
		cache:       dao.Rc,
		transaction: dao.NewTransaction(),
		menuRepo:    dao.NewMenuDao(),
		projectRepo: dao.NewProjectDao(),
	}
}



func (c *ProjectService) FindProjectByMemId(ctx context.Context, in *project.ProjectRpcMessage) (*project.MyProjectResponse, error) {
	id := in.MemberId
	pm, total, err := c.projectRepo.FindProjectByMemId(ctx, id, in.Page, in.PageSize)
	if err != nil {
		zap.L().Error("menu findAll error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	if pm == nil {
		return &project.MyProjectResponse{Pm: []*project.ProjectMessage{}, Total: total}, nil
	}
	var pmm []*project.ProjectMessage
	copier.Copy(&pmm, pm)
	for _, v := range pmm {
		v.Code, _ = encrypts.EncryptInt64(v.Id, model.AESKey)
	}
	return &project.MyProjectResponse{Pm: pmm, Total: total}, nil
}


~~~

~~~go
package repo

import (
	"context"
	"test.com/project-project/internal/data/project"
)

type ProjectRepo interface {
	FindProjectByMemId(ctx context.Context, memId int64, page int64, size int64) ([]*project.ProAndMember, int64, error)
}

~~~

~~~go
package dao

import (
	"context"
	"test.com/project-project/internal/data/project"
	"test.com/project-project/internal/database/gorms"
)

type ProjectDao struct {
	conn *gorms.GormConn
}

func (p *ProjectDao) FindProjectByMemId(ctx context.Context, memId int64, page int64, size int64) ([]*project.ProAndMember, int64, error) {
	session := p.conn.Session(ctx)
	index := (page - 1) * size
	db := session.Raw("select * from ms_project a, ms_project_member b where a.id=b.project_code and b.member_code=? limit ?,?", memId, index, size)
	var mp []*project.ProAndMember
	err := db.Scan(&mp).Error
	var total int64
	session.Model(&project.MemberProject{}).Where("member_code=?", memId).Count(&total)
	return mp, total, err
}

func NewProjectDao() *ProjectDao {
	return &ProjectDao{
		conn: gorms.New(),
	}
}

~~~

### 2.5 API

~~~go
package user

import (
	"context"
	"github.com/gin-gonic/gin"
	"github.com/jinzhu/copier"
	"net/http"
	"test.com/project-api/pkg/model"
	project2 "test.com/project-api/pkg/model/project"
	common "test.com/project-common"
	"test.com/project-common/errs"
	"test.com/project-grpc/project"
	"time"
)

type HandlerProject struct {
}

func New() *HandlerProject {
	return &HandlerProject{}
}

func (u *HandlerProject) index(c *gin.Context) {
	result := &common.Result{}
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &project.IndexMessage{}
	indexResponse, err := ProjectServiceClient.Index(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	c.JSON(http.StatusOK, result.Success(indexResponse.Menus))
}

func (u *HandlerProject) myProjectList(c *gin.Context) {
	result := &common.Result{}
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	idAny, _ := c.Get("memberId")
	id := idAny.(int64)
	var page = &model.Page{}
	page.Bind(c)
	pm, err := ProjectServiceClient.FindProjectByMemId(ctx, &project.ProjectRpcMessage{MemberId: id, Page: page.Page, PageSize: page.PageSize})
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	if pm.Pm == nil {
		pm.Pm = []*project.ProjectMessage{}
	}
	var pam []*project2.ProAndMember
	copier.Copy(&pam, pm.Pm)
	c.JSON(http.StatusOK, result.Success(gin.H{
		"list":  pam,
		"total": pm.Total,
	}))
}

~~~

~~~go
package user

import (
	"github.com/gin-gonic/gin"
	"log"
	"test.com/project-api/api/midd"
	"test.com/project-api/router"
)

type RouterProject struct {
}

func init() {
	log.Println("init project router")
	ru := &RouterProject{}
	router.Register(ru)
}

func (*RouterProject) Route(r *gin.Engine) {
	//初始化grpc的客户端连接
	InitRpcProjectClient()
	h := New()
	group := r.Group("/project")
	group.Use(midd.TokenVerify())
	group.POST("/index", h.index)
	group.POST("/project/selfList", h.myProjectList)
}

~~~

~~~go
package project

type Project struct {
	Id                 int64   `json:"id"`
	Cover              string  `json:"cover"`
	Name               string  `json:"name"`
	Description        string  `json:"description"`
	AccessControlType  int     `json:"accessControlType"`
	WhiteList          string  `json:"whiteList"`
	Order              int     `json:"order"`
	Deleted            int     `json:"deleted"`
	TemplateCode       string  `json:"templateCode"`
	Schedule           float64 `json:"schedule"`
	CreateTime         string  `json:"createTime"`
	OrganizationCode   int64   `json:"organizationCode"`
	DeletedTime        string  `json:"deletedTime"`
	Private            int     `json:"private"`
	Prefix             string  `json:"prefix"`
	OpenPrefix         int     `json:"openPrefix"`
	Archive            int     `json:"archive"`
	ArchiveTime        int64   `json:"archiveTime"`
	OpenBeginTime      int     `json:"openBeginTime"`
	OpenTaskPrivate    int     `json:"openTaskPrivate"`
	TaskBoardTheme     string  `json:"taskBoardTheme"`
	BeginTime          int64   `json:"beginTime"`
	EndTime            int64   `json:"endTime"`
	AutoUpdateSchedule int     `json:"autoUpdateSchedule"`
}

type MemberProject struct {
	Id          int64  `json:"id"`
	ProjectCode int64  `json:"projectCode"`
	MemberCode  int64  `json:"memberCode"`
	JoinTime    int64  `json:"joinTime"`
	IsOwner     int64  `json:"isOwner"`
	Authorize   string `json:"authorize"`
}

type ProAndMember struct {
	Project
	ProjectCode int64  `json:"projectCode"`
	MemberCode  int64  `json:"memberCode"`
	JoinTime    int64  `json:"joinTime"`
	IsOwner     int64  `json:"isOwner"`
	Authorize   string `json:"authorize"`
}

~~~

~~~go
package model

import "github.com/gin-gonic/gin"

type Page struct {
	Page     int64 `json:"page,omitempty" form:"page"`
	PageSize int64 `json:"pageSize,omitempty" form:"pageSize"`
}

func (p *Page) Bind(c *gin.Context) {
	c.ShouldBind(&p)
	if p.PageSize == 0 {
		p.PageSize = 10
	}
	if p.Page == 0 {
		p.Page = 1
	}
}

~~~



## 3. 组织列表

请求uri：project/organization/_getOrgList

参数：

| 字段                    | 类型   | 描述            |
| ----------------------- | ------ | --------------- |
| Authorization（Header） | string | bearer ${token} |

响应：

~~~json
{
    "code":200,
    "msg":"",
    "data":[
        {
            "id":1,
            "name":"子龙的个人项目",
            "avatar":null,
            "description":null,
            "owner_code":"6v7be19pwman2fird04gqu53",
            "create_time":"2018-10-12",
            "personal":1,
            "code":"6v7be19pwman2fird04gqu53",
            "address":null,
            "province":0,
            "city":0,
            "area":0
        },
        {
            "id":5,
            "name":"星星联盟",
            "avatar":null,
            "description":null,
            "owner_code":"6v7be19pwman2fird04gqu53",
            "create_time":"2019-01-13 10:24:42",
            "personal":1,
            "code":"bh5mdpzy7wg46kiqx9uclns2",
            "address":"星星联盟",
            "province":150000,
            "city":150300,
            "area":150303
        },
        {
            "id":6,
            "name":"太阳联盟",
            "avatar":null,
            "description":null,
            "owner_code":"6v7be19pwman2fird04gqu53",
            "create_time":"2019-01-13 10:26:39",
            "personal":1,
            "code":"bhlmq6n5edixkwct17a2gpv3",
            "address":"太阳联盟",
            "province":140000,
            "city":140300,
            "area":140303
        }
    ]
}
~~~

### 3.1 实现

~~~go

func (u *HandlerUser) myOrgList(c *gin.Context) {
	result := &common.Result{}
	token := c.GetHeader("Authorization")
	//验证用户是否已经登录
	mem, err2 := LoginServiceClient.TokenVerify(context.Background(), &login.TokenVerifyMessage{Token: token})
	if err2 != nil {
		code, msg := errs.ParseGrpcError(err2)
		c.JSON(http.StatusOK, result.Fail(code, msg))
		return
	}
	list, err2 := LoginServiceClient.MyOrgList(context.Background(), &login.UserMessage{MemId: mem.Member.Id})
	if err2 != nil {
		code, msg := errs.ParseGrpcError(err2)
		c.JSON(http.StatusOK, result.Fail(code, msg))
		return
	}
	if list.OrganizationList == nil {
		c.JSON(http.StatusOK, result.Success([]*user.OrganizationList{}))
		return
	}
	var orgs []*user.OrganizationList
	copier.Copy(&orgs, list.OrganizationList)
	c.JSON(http.StatusOK, result.Success(orgs))
}
~~~

~~~go
r.POST("/project/organization/_getOrgList", h.myOrgList)
~~~

~~~protobuf
message UserMessage{
  int64 memId = 1;
}
message OrgListResponse{
  repeated OrganizationMessage organizationList = 1;
}
message IndexResponse{}
service LoginService {
  rpc GetCaptcha(CaptchaMessage) returns (CaptchaResponse) {}
  rpc Register(RegisterMessage) returns (RegisterResponse) {}
  rpc Login(LoginMessage) returns (LoginResponse) {}
  rpc Index(IndexMessage) returns (IndexResponse) {}
  rpc TokenVerify(TokenVerifyMessage) returns (TokenVerifyResponse) {}
  rpc MyOrgList(UserMessage) returns (OrgListResponse) {}
}
~~~

~~~go

func (l *LoginService) MyOrgList(ctx context.Context, msg *login.UserMessage) (*login.OrgListResponse, error) {
	memId := msg.MemId
	orgs, err := l.organizationRepo.FindOrganizationByMemId(ctx, memId)
	if err != nil {
		zap.L().Error("MyOrgList FindOrganizationByMemId err", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	var orgsMessage []*login.OrganizationMessage
	err = copier.Copy(&orgsMessage, orgs)
	for _, org := range orgsMessage {
		org.Code, _ = encrypts.EncryptInt64(org.Id, model.AESKey)
	}
	return &login.OrgListResponse{OrganizationList: orgsMessage}, nil
}

~~~

