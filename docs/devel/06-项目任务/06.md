# 任务

## 1. 优化

### 1.1 登录缓存用户信息

~~~go
go func() {
		memJson, _ := json.Marshal(mem)
		ls.cache.Put(c, model.Member+"::"+memIdStr, string(memJson), exp)
		orgsJson, _ := json.Marshal(orgs)
		ls.cache.Put(c, model.MemberOrganization+"::"+memIdStr, string(orgsJson), exp)
	}()
~~~

~~~go
func (ls *LoginService) TokenVerify(ctx context.Context, msg *login.LoginMessage) (*login.LoginResponse, error) {
	token := msg.Token
	if strings.Contains(token, "bearer") {
		token = strings.ReplaceAll(token, "bearer ", "")
	}
	parseToken, err := jwts.ParseToken(token, config.C.JwtConfig.AccessSecret)
	if err != nil {
		zap.L().Error("Login  TokenVerify error", zap.Error(err))
		return nil, errs.GrpcError(model.NoLogin)
	}
	//从缓存中查询 如果没有 直接返回认证失败

	//数据库查询 优化点 登录之后 应该把用户信息缓存起来
	memberJson, err := ls.cache.Get(context.Background(), model.Member+"::"+parseToken)
	if err != nil {
		zap.L().Error("TokenVerify redis Get Member error", zap.Error(err))
		return nil, errs.GrpcError(model.NoLogin)
	}
	if memberJson == "" {
		zap.L().Error("Login TokenVerify cache already expire")
		return nil, errs.GrpcError(model.NoLogin)
	}
	memberById := &member.Member{}
	json.Unmarshal([]byte(memberJson), memberById)

	memMsg := &login.MemberMessage{}
	copier.Copy(memMsg, memberById)
	memMsg.Code, _ = encrypts.EncryptInt64(memberById.Id, model.AESKey)
	orgsJson, err := ls.cache.Get(context.Background(), model.MemberOrganization+"::"+parseToken)
	if err != nil {
		zap.L().Error("TokenVerify redis Get MemberOrganization error", zap.Error(err))
		return nil, errs.GrpcError(model.NoLogin)
	}
	if orgsJson == "" {
		zap.L().Error("Login TokenVerify cache already expire")
		return nil, errs.GrpcError(model.NoLogin)
	}
	var orgs []*organization.Organization
	json.Unmarshal([]byte(orgsJson), &orgs)
	if len(orgs) > 0 {
		memMsg.OrganizationCode, _ = encrypts.EncryptInt64(orgs[0].Id, model.AESKey)
	}
	memMsg.CreateTime = tms.FormatByMill(memberById.CreateTime)
	return &login.LoginResponse{Member: memMsg}, nil
}
~~~

### 1.2 接口缓存-统一缓存

当一个接口被频繁请求的时候，就会每次都访问数据库，对数据库造成一定的压力，这时候我们可以对此接口返回的数据进行缓存。

~~~go
package interceptor

import (
	"context"
	"encoding/json"
	"google.golang.org/grpc"
	"test.com/project-common/encrypts"
	"test.com/project-grpc/user/login"
	"test.com/project-user/internal/dao"
	"test.com/project-user/internal/repo"
	"time"
)

type Interceptor struct {
	cache    repo.Cache
	cacheMap map[string]any
}

func NewInterceptor() *Interceptor {
	cacheMap := make(map[string]any)
	cacheMap["/login.service.v1.LoginService/MyOrgList"] = &login.OrgListResponse{}
	cacheMap["/login.service.v1.LoginService/FindMemInfoById"] = &login.MemberMessage{}
	return &Interceptor{cache: dao.Rc, cacheMap: cacheMap}
}
func (i *Interceptor) CacheInterceptor() grpc.ServerOption {
	return grpc.UnaryInterceptor(func(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (resp interface{}, err error) {
		respType := i.cacheMap[info.FullMethod]
		if respType == nil {
			return handler(ctx, req)
		}
		c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
		defer cancel()
		marshal, _ := json.Marshal(req)
		cacheKey := encrypts.Md5(string(marshal))
		respJson, err := i.cache.Get(c, info.FullMethod+"::"+cacheKey)
		if err == nil {
			json.Unmarshal([]byte(respJson), &respType)
			return respType, nil
		}
		resp, err = handler(ctx, req)
		if resp == nil {
			return
		}
		bytes, _ := json.Marshal(resp)
		i.cache.Put(c, info.FullMethod+"::"+cacheKey, string(bytes), 5*time.Minute)
		return
	})
}

~~~

## 2. 任务看板

请求uri：project/task_stages

参数：

| 字段          | 类型   | 描述         |
| ------------- | ------ | ------------ |
| Authorization | string | header       |
| projectCode   | string | 项目id       |
| pageSize      | int    | 每页显示数量 |
| page          | int    | 当前页       |

返回：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "total":7,
        "page":1,
        "list":[
            {
                "name":"需求收集",
                "project_code":"7mdlxqzeay96i1rbk4uovnfh",
                "sort":0,
                "description":null,
                "create_time":"2022-07-26 21:24:36",
                "code":"712uozsl6rj0fyhtp5ckix9n",
                "deleted":0,
                "tasksLoading":true,
                "fixedCreator":false,
                "showTaskCard":false,
                "tasks":[
					
                ],
                "doneTasks":[
					
                ],
                "unDoneTasks":[

                ]
            },
            {
                "name":"评估确认",
                "project_code":"7mdlxqzeay96i1rbk4uovnfh",
                "sort":1,
                "description":null,
                "create_time":"2022-07-26 21:24:36",
                "code":"t7xez34gqasinr908d6lwbuj",
                "deleted":0,
                "tasksLoading":true,
                "fixedCreator":false,
                "showTaskCard":false,
                "tasks":[

                ],
                "doneTasks":[

                ],
                "unDoneTasks":[

                ]
            },
            {
                "name":"需求暂缓",
                "project_code":"7mdlxqzeay96i1rbk4uovnfh",
                "sort":2,
                "description":null,
                "create_time":"2022-07-26 21:24:36",
                "code":"cbk4i1xndr0qf83zatg6ve5w",
                "deleted":0,
                "tasksLoading":true,
                "fixedCreator":false,
                "showTaskCard":false,
                "tasks":[

                ],
                "doneTasks":[

                ],
                "unDoneTasks":[

                ]
            },
            {
                "name":"研发中",
                "project_code":"7mdlxqzeay96i1rbk4uovnfh",
                "sort":3,
                "description":null,
                "create_time":"2022-07-26 21:24:36",
                "code":"0bkfhom53ysjr8zpe7i1td6q",
                "deleted":0,
                "tasksLoading":true,
                "fixedCreator":false,
                "showTaskCard":false,
                "tasks":[

                ],
                "doneTasks":[

                ],
                "unDoneTasks":[

                ]
            },
            {
                "name":"内测中",
                "project_code":"7mdlxqzeay96i1rbk4uovnfh",
                "sort":4,
                "description":null,
                "create_time":"2022-07-26 21:24:36",
                "code":"4u9yhrtnvg7dc5is3p8k01x6",
                "deleted":0,
                "tasksLoading":true,
                "fixedCreator":false,
                "showTaskCard":false,
                "tasks":[

                ],
                "doneTasks":[

                ],
                "unDoneTasks":[

                ]
            },
            {
                "name":"通知用户",
                "project_code":"7mdlxqzeay96i1rbk4uovnfh",
                "sort":5,
                "description":null,
                "create_time":"2022-07-26 21:24:36",
                "code":"r6q2piwlxhbtf7v9sy3dugam",
                "deleted":0,
                "tasksLoading":true,
                "fixedCreator":false,
                "showTaskCard":false,
                "tasks":[

                ],
                "doneTasks":[

                ],
                "unDoneTasks":[

                ]
            },
            {
                "name":"已完成&归档",
                "project_code":"7mdlxqzeay96i1rbk4uovnfh",
                "sort":6,
                "description":null,
                "create_time":"2022-07-26 21:24:36",
                "code":"tmarhd71z83ov0uw62ibs4je",
                "deleted":0,
                "tasksLoading":true,
                "fixedCreator":false,
                "showTaskCard":false,
                "tasks":[

                ],
                "doneTasks":[

                ],
                "unDoneTasks":[

                ]
            }
        ]
    }
}
~~~

### 2.1涉及到的表

~~~sql
CREATE TABLE `vex_task_stages`  (
  `id` int(0) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '类型名称',
  `project_code` bigint(0) NULL DEFAULT NULL COMMENT '项目id',
  `sort` int(0) NULL DEFAULT 0 COMMENT '排序',
  `description` text CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL COMMENT '备注',
  `create_time` bigint(0) NULL DEFAULT NULL COMMENT '创建时间',
  `deleted` tinyint(1) NULL DEFAULT 0 COMMENT '删除标记',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 77 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci COMMENT = '任务列表表' ROW_FORMAT = COMPACT;
~~~



### 2.2 api

~~~go
package tasks

type TaskStagesResp struct {
	Name         string `json:"name"`
	ProjectCode  string `json:"project_code"`
	Sort         int    `json:"sort"`
	Description  string `json:"description"`
	CreateTime   string `json:"create_time"`
	Code         string `json:"code"`
	Deleted      int    `json:"deleted"`
	TasksLoading bool   `json:"tasksLoading"`
	FixedCreator bool   `json:"fixedCreator"`
	ShowTaskCard bool   `json:"showTaskCard"`
	Tasks        []int  `json:"tasks"`
	DoneTasks    []int  `json:"doneTasks"`
	UnDoneTasks  []int  `json:"unDoneTasks"`
}

~~~



~~~go
package project

import (
	"context"
	"github.com/gin-gonic/gin"
	"github.com/jinzhu/copier"
	"net/http"
	"test.com/project-api/pkg/model"
	"test.com/project-api/pkg/model/tasks"
	common "test.com/project-common"
	"test.com/project-common/errs"
	"test.com/project-grpc/task"
	"time"
)

type HandlerTask struct {
}

func (t *HandlerTask) taskStages(c *gin.Context) {
	result := &common.Result{}
	projectCode := c.PostForm("projectCode")
	page := &model.Page{}
	page.Bind(c)
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &task.TaskReqMessage{
		ProjectCode: projectCode,
		Page:        page.Page,
		PageSize:    page.PageSize,
	}
	stages, err := TaskServiceClient.TaskStages(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	var resp []*tasks.TaskStagesResp
	copier.Copy(&resp, stages.List)
	if resp == nil {
		resp = []*tasks.TaskStagesResp{}
	}
	for _, v := range resp {
		v.TasksLoading = true  //任务加载状态
		v.FixedCreator = false //添加任务按钮定位
		v.ShowTaskCard = false //是否显示创建卡片
		v.Tasks = []int{}
		v.DoneTasks = []int{}
		v.UnDoneTasks = []int{}
	}
	c.JSON(http.StatusOK, result.Success(gin.H{
		"list":  resp,
		"total": stages.Total,
		"page":  page.Page,
	}))
}

func NewTask() *HandlerTask {
	return &HandlerTask{}
}

~~~

### 2.3 创建项目增加任务步骤

~~~go
package task

type TaskStages struct {
	Id          int    `json:"id"`
	Name        string `json:"name"`
	ProjectCode int64  `json:"project_code"`
	Sort        int    `json:"sort"`
	Description string `json:"description"`
	CreateTime  int64  `json:"create_time"`
	Deleted     int    `json:"deleted"`
}

func (*TaskStages) TableName() string {
	return "ms_task_stages"
}
~~~

~~~go
//3. 保存任务步骤
		templates, err := ps.taskStagesTemplateRepo.FindByProjectTemplate(ctx, int(templateCode))
		if err != nil {
			zap.L().Error("project SaveProject taskStagesTemplate FindByProjectTemplate error", zap.Error(err))
			return errs.GrpcError(model.DBError)
		}
		for index, v := range templates {
			stages := &task.TaskStages{
				Name:        v.Name,
				Description: "",
				Sort:        index,
				CreateTime:  time.Now().UnixMilli(),
				ProjectCode: pr.Id,
				Deleted:     model.NoDeleted,
			}
			err = ps.taskStagesRepo.Save(ctx, conn, stages)
			if err != nil {
				zap.L().Error("project SaveProject SaveTaskStages error", zap.Error(err))
				return errs.GrpcError(model.DBError)
			}
		}
~~~

~~~go
func (t *TaskStagesTemplateDao) FindByProjectTemplate(ctx context.Context, projectTemplateCode int) ([]task.MsTaskStagesTemplate, error) {
	var tsts []task.MsTaskStagesTemplate
	session := t.conn.Session(ctx)
	err := session.Where("project_template_code = ?", projectTemplateCode).Order("sort desc,id asc").Find(&tsts).Error
	return tsts, err
}
~~~

~~~go
type TaskStagesRepo interface {
	Save(ctx context.Context, conn database.DbConn, stages *task.TaskStages) error
}
~~~

~~~go
package dao

import (
	"context"
	"test.com/project-project/internal/data/task"
	"test.com/project-project/internal/database"
	"test.com/project-project/internal/database/gorms"
)

type TaskStagesDao struct {
	conn *gorms.GormConn
}

func (t *TaskStagesDao) Save(ctx context.Context, conn database.DbConn, stages *task.TaskStages) error {
	t.conn = conn.(*gorms.GormConn)
	session := t.conn.Tx(ctx)
	return session.Save(&stages).Error
}

func NewTaskStagesDao() *TaskStagesDao {
	return &TaskStagesDao{
		conn: gorms.New(),
	}
}

~~~

### 2.4 实现

~~~protobuf
syntax = "proto3";
package task.service.v1;
option go_package = "project-project/pkg/service/project.service.v1";

message TaskReqMessage{
  string projectCode = 1;
  int64 page = 2;
  int64 pageSize = 3;
}
message TaskStagesMessage{
  string code = 1;
  string name = 2;
  string projectCode = 3;
  int32 sort = 4;
  string description = 5;
  string createTime = 6;
  int32 deleted = 7;
  int32 id = 8;
}
message TaskStagesResponse{
  int64 total = 1;
  repeated TaskStagesMessage list = 2;
}
service TaskService {
  rpc TaskStages(TaskReqMessage) returns (TaskStagesResponse){}
}
~~~

~~~go
package tasks

type TaskStages struct {
	Id          int    `json:"id"`
	Name        string `json:"name"`
	ProjectCode int64  `json:"project_code"`
	Sort        int    `json:"sort"`
	Description string `json:"description"`
	CreateTime  int64  `json:"create_time"`
	Deleted     int    `json:"deleted"`
}

func (*TaskStages) TableName() string {
	return "ms_task_stages"
}

func ToTaskStagesMap(tss []*TaskStages) map[int]*TaskStages {
	m := make(map[int]*TaskStages)
	for _, v := range tss {
		m[v.Id] = v
	}
	return m
}

~~~

~~~go
package task_service_v1

import (
	"context"
	"github.com/jinzhu/copier"
	"go.uber.org/zap"
	"strconv"
	"test.com/project-common/encrypts"
	"test.com/project-common/errs"
	"test.com/project-common/tms"
	"test.com/project-grpc/task"
	"test.com/project-project/internal/dao"
	"test.com/project-project/internal/data/tasks"
	"test.com/project-project/internal/database/tran"
	"test.com/project-project/internal/repo"
	"test.com/project-project/pkg/model"
	"time"
)

type TaskService struct {
	task.UnimplementedTaskServiceServer
	cache                  repo.Cache
	transaction            tran.Transaction
	taskStagesTemplateRepo repo.TaskStagesTemplateRepo
	taskStagesRepo         repo.TaskStagesRepo
}

func New() *TaskService {
	return &TaskService{
		cache:                  dao.Rc,
		transaction:            dao.NewTransaction(),
		taskStagesTemplateRepo: dao.NewTaskStagesTemplateDao(),
		taskStagesRepo:         dao.NewTaskStagesDao(),
	}
}

func (t *TaskService) TaskStages(ctx context.Context, msg *task.TaskReqMessage) (*task.TaskStagesResponse, error) {
	projectCodeStr, _ := encrypts.Decrypt(msg.ProjectCode, model.AESKey)
	projectCode, _ := strconv.ParseInt(projectCodeStr, 10, 64)
	page := msg.Page
	pageSize := msg.PageSize
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	taskStages, total, err := t.taskStagesRepo.FindByProjectCode(c, projectCode, page, pageSize)
	if err != nil {
		zap.L().Error("project task TaskStages FindByProjectCode error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	tsMap := tasks.ToTaskStagesMap(taskStages)
	var resp []*task.TaskStagesMessage
	copier.Copy(&resp, taskStages)
	for _, v := range resp {
		stages := tsMap[int(v.Id)]
		v.Code, _ = encrypts.EncryptInt64(int64(v.Id), model.AESKey)
		v.CreateTime = tms.FormatByMill(stages.CreateTime)
		v.ProjectCode = msg.ProjectCode
	}
	return &task.TaskStagesResponse{
		List:  resp,
		Total: total,
	}, nil
}

~~~

~~~go
package repo

import (
	"context"
	"test.com/project-project/internal/data/tasks"
	"test.com/project-project/internal/database"
)

type TaskStagesTemplateRepo interface {
	FindInProTemIds(ctx context.Context, ids []int) ([]tasks.MsTaskStagesTemplate, error)
	FindByProjectTemplate(ctx context.Context, projectTemplateCode int) ([]tasks.MsTaskStagesTemplate, error)
}
type TaskStagesRepo interface {
	Save(ctx context.Context, conn database.DbConn, stages *tasks.TaskStages) error
	FindByProjectCode(ctx context.Context, projectCode int64, page int64, size int64) ([]*tasks.TaskStages, int64, error)
}

~~~

~~~go
package dao

import (
	"context"
	"test.com/project-project/internal/data/tasks"
	"test.com/project-project/internal/database"
	"test.com/project-project/internal/database/gorms"
)

type TaskStagesDao struct {
	conn *gorms.GormConn
}

func (t *TaskStagesDao) FindByProjectCode(ctx context.Context, projectCode int64, page int64, size int64) ([]*tasks.TaskStages, int64, error) {
	session := t.conn.Session(ctx)
	var stages []*tasks.TaskStages
	err := session.Model(&tasks.TaskStages{}).Where("project_code=? and deleted=?", projectCode, 0).Order("sort asc").Limit(int(size)).Offset(int((page - 1) * size)).Find(&stages).Error
	var total int64
	err = session.Model(&tasks.TaskStages{}).Where("project_code=?", projectCode).Count(&total).Error
	return stages, total, err
}

func (t *TaskStagesDao) Save(ctx context.Context, conn database.DbConn, stages *tasks.TaskStages) error {
	t.conn = conn.(*gorms.GormConn)
	session := t.conn.Tx(ctx)
	return session.Save(&stages).Error
}

func NewTaskStagesDao() *TaskStagesDao {
	return &TaskStagesDao{
		conn: gorms.New(),
	}
}

~~~



## 3. 任务用户

请求uri：project/project_member/index

参数：

| 字段          | 类型   | 描述         |
| ------------- | ------ | ------------ |
| Authorization | string | header       |
| projectCode   | string | 项目id       |
| pageSize      | int    | 每页显示数量 |
| page          | int    | 当前页       |

返回：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "total":1,
        "page":1,
        "list":[
            {
                "name":"子龙",
                "avatar":"https:\/\/static.vilson.xyz\/cover.png",
                "code":"6v7be19pwman2fird04gqu53",
                "email":"123@123.com",
                "is_owner":1
            }
        ]
    }
}
~~~

### 3.1 实现

~~~go
group.POST("/project_member/index", t.taskMemberList)
~~~

~~~go

func (t *HandlerTask) taskMemberList(c *gin.Context) {
	result := &common.Result{}
	projectCode := c.PostForm("projectCode")
	page := &model.Page{}
	page.Bind(c)
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &task.TaskReqMessage{
		ProjectCode: projectCode,
		Page:        page.Page,
		PageSize:    page.PageSize,
	}
	memberResp, err := TaskServiceClient.MemberProjectList(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	var resp []*pro.MemberProjectResp
	copier.Copy(&resp, memberResp.List)
	if resp == nil {
		resp = []*pro.MemberProjectResp{}
	}
	c.JSON(http.StatusOK, result.Success(gin.H{
		"list":  resp,
		"total": memberResp.Total,
		"page":  page.Page,
	}))
}
~~~

~~~go
package pro

type MemberProjectResp struct {
	Name    string `json:"name"`
	Email   string `json:"email"`
	Avatar  string `json:"avatar"`
	Code    string `json:"code"`
	IsOwner int    `json:"isOwner"`
}

~~~

~~~protobuf
syntax = "proto3";
package task.service.v1;
option go_package = "project-project/pkg/service/project.service.v1";

message TaskReqMessage{
  string projectCode = 1;
  int64 page = 2;
  int64 pageSize = 3;
}
message TaskStagesMessage{
  string code = 1;
  string name = 2;
  string projectCode = 3;
  int32 sort = 4;
  string description = 5;
  string createTime = 6;
  int32 deleted = 7;
  int32 id = 8;
}
message TaskStagesResponse{
  int64 total = 1;
  repeated TaskStagesMessage list = 2;
}
message MemberProjectMessage{
  string name = 1;
  string avatar = 2;
  int64 memberCode = 3;
  string code = 4;
  string email = 5;
  int32 isOwner = 6;
}
message MemberProjectResponse{
  int64 total = 1;
  repeated MemberProjectMessage list = 2;
}
service TaskService {
  rpc TaskStages(TaskReqMessage) returns (TaskStagesResponse){}
  rpc MemberProjectList(TaskReqMessage) returns (MemberProjectResponse){}
}
~~~

~~~go
func (t *TaskService) MemberProjectList(ctx context.Context, msg *task.TaskReqMessage) (*task.MemberProjectResponse, error) {
	projectCodeStr, _ := encrypts.Decrypt(msg.ProjectCode, model.AESKey)
	projectCode, _ := strconv.ParseInt(projectCodeStr, 10, 64)
	page := msg.Page
	pageSize := msg.PageSize
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	memberInfos, total, err := t.projectRepo.FindMemberInfoByProjectCode(c, projectCode, page, pageSize)
	if err != nil {
		zap.L().Error("project task TaskStages FindByProjectCode error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	pmMap := pro.ToProjectMemberInfoMap(memberInfos)
	var resp []*task.MemberProjectMessage
	copier.Copy(&resp, memberInfos)
	for _, v := range resp {
		pm := pmMap[v.MemberCode]
		v.Code, _ = encrypts.EncryptInt64(v.MemberCode, model.AESKey)
		if pm.MemberCode == pm.IsOwner {
			v.IsOwner = 1
		} else {
			v.IsOwner = 0
		}
	}
	return &task.MemberProjectResponse{
		List:  resp,
		Total: total,
	}, nil
}
~~~

~~~go

type ProjectMemberInfo struct {
	ProjectCode int64
	MemberCode  int64
	Name        string
	Avatar      string
	IsOwner     int64
	Email       string
}

func ToProjectMemberInfoMap(pm []*ProjectMemberInfo) map[int64]*ProjectMemberInfo {
	m := make(map[int64]*ProjectMemberInfo)
	for _, v := range pm {
		m[v.MemberCode] = v
	}
	return m
}
~~~

~~~go
func (p *ProjectDao) FindMemberInfoByProjectCode(ctx context.Context, projectCode int64, page int64, size int64) ([]*pro.ProjectMemberInfo, int64, error) {
	sql := "select a.project_code,a.member_code,a.is_owner,b.`name`,b.avatar,b.email from ms_project_member a, ms_member b where a.member_code=b.id and project_code = ? limit ?,?"
	session := p.conn.Session(ctx)
	db := session.Raw(sql, projectCode, (page-1)*size, size)
	var mis []*pro.ProjectMemberInfo
	err := db.Scan(&mis).Error
	var total int64
	sqlCount := "select count(*) from ms_project_member a, ms_member b where a.member_code=b.id and project_code = ?"
	dbCount := session.Raw(sqlCount, projectCode)
	err = dbCount.Scan(&total).Error
	return mis, total, err
}
~~~

## 4. 任务步骤详情

请求uri：project/task_stages/tasks

参数：

| 字段          | 类型   | 描述   |
| ------------- | ------ | ------ |
| Authorization | string | header |
| stageCode     | string | 步骤id |

返回：

~~~json
{
    "code":200,
    "msg":"",
    "data":[
        {
            "code":"tmkyx21o4976w5pbached0iz",
            "project_code":"7mdlxqzeay96i1rbk4uovnfh",
            "name":"123123",
            "pri":0,
            "execute_status":"wait",
            "description":"",
            "create_by":"6v7be19pwman2fird04gqu53",
            "done_by":null,
            "done_time":null,
            "create_time":"2022-07-26 21:25:46",
            "assign_to":"6v7be19pwman2fird04gqu53",
            "deleted":0,
            "stage_code":"712uozsl6rj0fyhtp5ckix9n",
            "task_tag":null,
            "done":0,
            "begin_time":"",
            "end_time":"",
            "remind_time":null,
            "pcode":"",
            "sort":131072,
            "like":0,
            "star":0,
            "deleted_time":null,
            "private":0,
            "id_num":2,
            "path":"",
            "schedule":0,
            "version_code":"0",
            "features_code":"0",
            "work_time":0,
            "status":0,
            "executor":{
                "name":"子龙",
                "avatar":"https:\/\/static.vilson.xyz\/cover.png"
            },
            "priText":"普通",
            "statusText":"未开始",
            "liked":0,
            "stared":0,
            "tags":[

            ],
            "childCount":[
                0,
                0
            ],
            "hasUnDone":0,
            "parentDone":1,
            "hasComment":0,
            "hasSource":0,
            "canRead":1
        }
    ]
}
~~~

### 4.1 涉及到的表

~~~sql
CREATE TABLE `vex_task`  (
  `id` bigint(0) UNSIGNED NOT NULL AUTO_INCREMENT,
  `project_code` bigint(0) NOT NULL DEFAULT 0 COMMENT '项目编号',
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL,
  `pri` tinyint(0) UNSIGNED NULL DEFAULT 0 COMMENT '紧急程度',
  `execute_status` tinyint(0) NULL DEFAULT NULL COMMENT '执行状态',
  `description` text CHARACTER SET utf8 COLLATE utf8_general_ci NULL COMMENT '详情',
  `create_by` bigint(0) NULL DEFAULT NULL COMMENT '创建人',
  `done_by` bigint(0) NULL DEFAULT NULL COMMENT '完成人',
  `done_time` bigint(0) NULL DEFAULT NULL COMMENT '完成时间',
  `create_time` bigint(0) NULL DEFAULT NULL COMMENT '创建日期',
  `assign_to` bigint(0) NULL DEFAULT NULL COMMENT '指派给谁',
  `deleted` tinyint(1) NULL DEFAULT 0 COMMENT '回收站',
  `stage_code` int(0) NULL DEFAULT NULL COMMENT '任务列表',
  `task_tag` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '任务标签',
  `done` tinyint(0) NULL DEFAULT 0 COMMENT '是否完成',
  `begin_time` bigint(0) NULL DEFAULT NULL COMMENT '开始时间',
  `end_time` bigint(0) NULL DEFAULT NULL COMMENT '截止时间',
  `remind_time` bigint(0) NULL DEFAULT NULL COMMENT '提醒时间',
  `pcode` bigint(0) NULL DEFAULT NULL COMMENT '父任务id',
  `sort` int(0) NULL DEFAULT 0 COMMENT '排序',
  `like` int(0) NULL DEFAULT 0 COMMENT '点赞数',
  `star` int(0) NULL DEFAULT 0 COMMENT '收藏数',
  `deleted_time` bigint(0) NULL DEFAULT NULL COMMENT '删除时间',
  `private` tinyint(1) NULL DEFAULT 0 COMMENT '是否隐私模式',
  `id_num` int(0) NULL DEFAULT 1 COMMENT '任务id编号',
  `path` text CHARACTER SET utf8 COLLATE utf8_general_ci NULL COMMENT '上级任务路径',
  `schedule` int(0) NULL DEFAULT 0 COMMENT '进度百分比',
  `version_code` bigint(0) NULL DEFAULT 0 COMMENT '版本id',
  `features_code` bigint(0) NULL DEFAULT 0 COMMENT '版本库id',
  `work_time` int(0) NULL DEFAULT 0 COMMENT '预估工时',
  `status` tinyint(0) NULL DEFAULT 0 COMMENT '执行状态。0：未开始，1：已完成，2：进行中，3：挂起，4：测试中',
  PRIMARY KEY (`id`, `project_code`) USING BTREE,
  INDEX `stage_code`(`stage_code`) USING BTREE,
  INDEX `project_code`(`project_code`) USING BTREE,
  INDEX `pcode`(`pcode`) USING BTREE,
  INDEX `sort`(`sort`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 12363 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci COMMENT = '任务表' ROW_FORMAT = COMPACT;
~~~

~~~sql
CREATE TABLE `vex_task_member`  (
  `id` bigint(0) NOT NULL AUTO_INCREMENT,
  `task_code` bigint(0) NULL DEFAULT 0 COMMENT '任务ID',
  `is_executor` tinyint(1) NULL DEFAULT 0 COMMENT '执行者',
  `member_code` bigint(0) NULL DEFAULT NULL COMMENT '成员id',
  `join_time` bigint(0) NULL DEFAULT NULL,
  `is_owner` tinyint(1) NULL DEFAULT 0 COMMENT '是否创建人',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE INDEX `id`(`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 273 CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '任务-成员表' ROW_FORMAT = COMPACT;
~~~



模型：

~~~go
package tasks

type TaskDisplay struct {
	ProjectCode   string   `json:"project_code"`
	Name          string   `json:"name"`
	Pri           int      `json:"pri"`
	ExecuteStatus string   `json:"execute_status"`
	Description   string   `json:"description"`
	CreateBy      string   `json:"create_by"`
	DoneBy        string   `json:"done_by"`
	DoneTime      string   `json:"done_time"`
	CreateTime    string   `json:"create_time"`
	AssignTo      string   `json:"assign_to"`
	Deleted       int      `json:"deleted"`
	StageCode     string   `json:"stage_code"`
	TaskTag       string   `json:"task_tag"`
	Done          int      `json:"done"`
	BeginTime     string   `json:"begin_time"`
	EndTime       string   `json:"end_time"`
	RemindTime    string   `json:"remind_time"`
	Pcode         string   `json:"pcode"`
	Sort          int      `json:"sort"`
	Like          int      `json:"like"`
	Star          int      `json:"star"`
	DeletedTime   string   `json:"deleted_time"`
	Private       int      `json:"private"`
	IdNum         int      `json:"id_num"`
	Path          string   `json:"path"`
	Schedule      int      `json:"schedule"`
	VersionCode   string   `json:"version_code"`
	FeaturesCode  string   `json:"features_code"`
	WorkTime      int      `json:"work_time"`
	Status        int      `json:"status"`
	Code          string   `json:"code"`
	CanRead       int      `json:"canRead"`
	HasUnDone     int      `json:"hasUnDone"`
	ParentDone    int      `json:"parentDone"`
	HasComment    int      `json:"hasComment"`
	HasSource     int      `json:"hasSource"`
	Executor      Executor `json:"executor"`
	PriText       string   `json:"priText"`
	StatusText    string   `json:"statusText"`
	Liked         int      `json:"liked"`
	Stared        int      `json:"stared"`
	Tags          []int    `json:"tags"`
	ChildCount    []int    `json:"childCount"`
}

type Executor struct {
	Name   string `json:"name"`
	Avatar string `json:"avatar"`
}

type TaskSaveReq struct {
	Name        string `form:"name"`
	StageCode   string `form:"stage_code"`
	ProjectCode string `form:"project_code"`
	AssignTo    string `form:"assign_to"`
}

~~~

~~~go
syntax = "proto3";
package task.service.v1;
option go_package = "project-project/pkg/service/task.service.v1";

message TaskReqMessage{
  string projectCode = 1;
  int64 page = 2;
  int64 pageSize = 3;
  string stageCode = 4;
  string name = 5;
  string assignTo = 6;
  int64 memberId = 7;

}
message TaskStagesMessage{
  string code = 1;
  string name = 2;
  string projectCode = 3;
  int32 sort = 4;
  string description = 5;
  string createTime = 6;
  int32 deleted = 7;
  int32 id = 8;
}
message TaskStagesResponse{
  int64 total = 1;
  repeated TaskStagesMessage list = 2;
}
message MemberProjectMessage{
  string name = 1;
  string avatar = 2;
  int64 memberCode = 3;
  string code = 4;
  string email = 5;
  int32 isOwner = 6;
}
message MemberProjectResponse{
  int64 total = 1;
  repeated MemberProjectMessage list = 2;
}

message TaskMessage{
  int64 Id  = 1;
  string ProjectCode  = 2;
  string Name  = 3;
  int32 Pri  = 4;
  string ExecuteStatus  = 5;
  string Description  = 6;
  string CreateBy  = 7;
  string DoneBy  = 8;
  string DoneTime  = 9;
  string CreateTime  = 10;
  string AssignTo  = 11;
  int32 Deleted  = 12;
  string StageCode  = 13;
  string TaskTag  = 14;
  int32 Done  = 15;
  string BeginTime  = 16;
  string EndTime  = 17;
  string RemindTime  = 18;
  string Pcode  = 19;
  int32 Sort  = 20;
  int32 Like  = 21;
  int32 Star  = 22;
  string DeletedTime  = 23;
  int32 Private  = 24;
  int32 IdNum  = 25;
  string Path  = 26;
  int32 Schedule  = 27;
  string VersionCode  = 28;
  string FeaturesCode  = 29;
  int32 WorkTime  = 30;
  int32 Status  = 31;
  string code = 32;
  int32 canRead = 33;
}
message TaskListResponse{
  repeated TaskMessage list = 1;
}
service TaskService {
  rpc TaskStages(TaskReqMessage) returns (TaskStagesResponse){}
  rpc MemberProjectList(TaskReqMessage) returns (MemberProjectResponse){}
  rpc TaskList(TaskReqMessage) returns (TaskListResponse){}
  rpc SaveTask(TaskReqMessage) returns (TaskMessage){}
}
~~~

~~~go
package tasks

import (
	"github.com/jinzhu/copier"
	"test.com/project-common/encrypts"
	"test.com/project-common/tms"
)

type MsTaskStagesTemplate struct {
	Id                  int
	Name                string
	ProjectTemplateCode int
	CreateTime          int64
	Sort                int
}

func (*MsTaskStagesTemplate) TableName() string {
	return "ms_task_stages_template"
}

type TaskStagesOnlyName struct {
	Name string
}

//CovertProjectMap 模板id->任务步骤列表
func CovertProjectMap(tsts []MsTaskStagesTemplate) map[int][]*TaskStagesOnlyName {
	var tss = make(map[int][]*TaskStagesOnlyName)
	for _, v := range tsts {
		ts := &TaskStagesOnlyName{}
		ts.Name = v.Name
		tss[v.ProjectTemplateCode] = append(tss[v.ProjectTemplateCode], ts)
	}
	return tss
}

//Task
type Task struct {
	Id            int64
	ProjectCode   int64
	Name          string
	Pri           int
	ExecuteStatus int
	Description   string
	CreateBy      int64
	DoneBy        int64
	DoneTime      int64
	CreateTime    int64
	AssignTo      int64
	Deleted       int
	StageCode     int
	TaskTag       string
	Done          int
	BeginTime     int64
	EndTime       int64
	RemindTime    int64
	Pcode         int64
	Sort          int
	Like          int
	Star          int
	DeletedTime   int64
	Private       int
	IdNum         int
	Path          string
	Schedule      int
	VersionCode   int64
	FeaturesCode  int64
	WorkTime      int
	Status        int
}

func (*Task) TableName() string {
	return "ms_task"
}

type TaskMember struct {
	Id         int64
	TaskCode   int64
	IsExecutor int
	MemberCode int64
	JoinTime   int64
	IsOwner    int
}

func (*TaskMember) TableName() string {
	return "ms_task_member"
}

const (
	Wait = iota
	Doing
	Done
	Pause
	Cancel
	Closed
)

func (t *Task) GetExecuteStatusStr() string {
	status := t.ExecuteStatus
	if status == Wait {
		return "wait"
	}
	if status == Doing {
		return "doing"
	}
	if status == Done {
		return "done"
	}
	if status == Pause {
		return "pause"
	}
	if status == Cancel {
		return "cancel"
	}
	if status == Closed {
		return "closed"
	}
	return ""
}

type TaskDisplay struct {
	Id            int64
	ProjectCode   string
	Name          string
	Pri           int
	ExecuteStatus string
	Description   string
	CreateBy      string
	DoneBy        string
	DoneTime      string
	CreateTime    string
	AssignTo      string
	Deleted       int
	StageCode     string
	TaskTag       string
	Done          int
	BeginTime     string
	EndTime       string
	RemindTime    string
	Pcode         string
	Sort          int
	Like          int
	Star          int
	DeletedTime   string
	Private       int
	IdNum         int
	Path          string
	Schedule      int
	VersionCode   string
	FeaturesCode  string
	WorkTime      int
	Status        int
	Code          string
	CanRead       int
}

func (t *Task) ToTaskDisplay() *TaskDisplay {
	td := &TaskDisplay{}
	copier.Copy(td, t)
	td.CreateTime = tms.FormatByMill(t.CreateTime)
	td.DoneTime = tms.FormatByMill(t.DoneTime)
	td.BeginTime = tms.FormatByMill(t.BeginTime)
	td.EndTime = tms.FormatByMill(t.EndTime)
	td.RemindTime = tms.FormatByMill(t.RemindTime)
	td.DeletedTime = tms.FormatByMill(t.DeletedTime)
	td.CreateBy = encrypts.EncryptNoErr(t.CreateBy)
	td.ProjectCode = encrypts.EncryptNoErr(t.ProjectCode)
	td.DoneBy = encrypts.EncryptNoErr(t.DoneBy)
	td.AssignTo = encrypts.EncryptNoErr(t.AssignTo)
	td.StageCode = encrypts.EncryptNoErr(int64(t.StageCode))
	td.Pcode = encrypts.EncryptNoErr(t.Pcode)
	td.VersionCode = encrypts.EncryptNoErr(t.VersionCode)
	td.FeaturesCode = encrypts.EncryptNoErr(t.FeaturesCode)
	td.ExecuteStatus = t.GetExecuteStatusStr()
	td.Code = encrypts.EncryptNoErr(t.Id)
	td.CanRead = 1
	return td
}

~~~

~~~go

const (
	NoExecutor = iota
	Executor
)
const (
	NoOwner = iota
	Owner
)
const (
	NoCanRead = iota
	CanRead
)
~~~



### 4.2 实现

~~~go
func (t *HandlerTask) taskList(c *gin.Context) {
	result := &common.Result{}
	stageCode := c.PostForm("stageCode")
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	list, err := TaskServiceClient.TaskList(ctx, &task.TaskReqMessage{StageCode: stageCode})
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	var taskDisplayList []*tasks.TaskDisplay
	copier.Copy(&taskDisplayList, list.List)
	if taskDisplayList == nil {
		taskDisplayList = []*tasks.TaskDisplay{}
	}
	for _, v := range taskDisplayList {
		if v.Tags == nil {
			v.Tags = []int{}
		}
		if v.ChildCount == nil {
			v.ChildCount = []int{}
		}
	}
	c.JSON(http.StatusOK, result.Success(taskDisplayList))
}
~~~

~~~go
package dao

import (
	"context"
	"gorm.io/gorm"
	"test.com/project-project/internal/data/tasks"
	"test.com/project-project/internal/database/gorms"
)

type TaskDao struct {
	conn *gorms.GormConn
}

func (t *TaskDao) FindTaskMemberByTaskId(ctx context.Context, taskCode int64, memberCode int64) (*tasks.TaskMember, error) {
	var tm *tasks.TaskMember
	err := t.conn.Session(ctx).Where("task_code=? and member_code=?", taskCode, memberCode).Limit(1).Find(&tm).Error
	if err == gorm.ErrRecordNotFound {
		return nil, nil
	}
	return tm, err
}

func (t *TaskDao) SaveTaskMember(ctx context.Context, tm *tasks.TaskMember) error {
	return t.conn.Session(ctx).Save(&tm).Error
}

func (t *TaskDao) SaveTask(ctx context.Context, ts *tasks.Task) error {
	return t.conn.Session(ctx).Save(&ts).Error
}

func (t *TaskDao) FindTaskSort(ctx context.Context, projectCode int64, stageCode int64) (v int64, err error) {
	session := t.conn.Session(ctx)
	m := make(map[string]*int64)
	err = session.Model(&tasks.Task{}).Where("project_code=? and stage_code=?", projectCode, stageCode).Select("max(sort) as sort").Take(&m).Error
	if m["sort"] == nil {
		return 0, nil
	}
	v = *m["sort"]
	return
}

func (t *TaskDao) FindTaskMaxIdNum(ctx context.Context, projectCode int64) (v int64, err error) {
	session := t.conn.Session(ctx)
	m := make(map[string]*int64)
	err = session.Model(&tasks.Task{}).Where("project_code=?", projectCode).Select("max(id_num) as maxIdNum").Take(&m).Error
	if m["maxIdNum"] == nil {
		return 0, nil
	}
	v = *m["maxIdNum"]
	return
}

func (t *TaskDao) FindTaskByStageCode(ctx context.Context, stageCode int) (taskList []*tasks.Task, err error) {
	session := t.conn.Session(ctx)
	err = session.Model(&tasks.Task{}).Where("stage_code=?", stageCode).Find(&taskList).Error
	return
}

func NewTaskDao() *TaskDao {
	return &TaskDao{
		conn: gorms.New(),
	}
}

~~~

~~~go

func (t *TaskStagesDao) FindById(ctx context.Context, stageCode int) (ts *tasks.TaskStages, err error) {
	err = t.conn.Session(ctx).Where("id=?", stageCode).Find(&ts).Error
	if err == gorm.ErrRecordNotFound {
		return nil, nil
	}
	return
}

func (t *TaskStagesDao) FindByProjectCode(ctx context.Context, projectCode int64, page int64, size int64) ([]*tasks.TaskStages, int64, error) {
	session := t.conn.Session(ctx)
	var stages []*tasks.TaskStages
	err := session.Model(&tasks.TaskStages{}).Where("project_code=? and deleted=?", projectCode, 0).Order("sort asc").Limit(int(size)).Offset(int((page - 1) * size)).Find(&stages).Error
	var total int64
	err = session.Model(&tasks.TaskStages{}).Where("project_code=?", projectCode).Count(&total).Error
	return stages, total, err
}
~~~

~~~go

func (p *ProjectDao) FindProjectById(ctx context.Context, id int64) (pj *pro.Project, err error) {
	err = p.conn.Session(ctx).Where("id=?", id).Find(&pj).Error
	return
}

~~~

~~~go

func (t *TaskService) TaskList(ctx context.Context, msg *task.TaskReqMessage) (*task.TaskListResponse, error) {
	stageCode := encrypts.DecryptNoErr(msg.StageCode)
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	taskList, err := t.taskRepo.FindTaskByStageCode(c, int(stageCode))
	if err != nil {
		zap.L().Error("project task TaskList FindTaskByStageCode error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	var taskDisplayList []*tasks.TaskDisplay
	for _, v := range taskList {
		display := v.ToTaskDisplay()
		tm, err := t.taskRepo.FindTaskMemberByTaskId(ctx, v.Id, msg.MemberId)
		if err != nil {
			zap.L().Error("project task TaskList FindTaskMemberByTaskId error", zap.Error(err))
			return nil, errs.GrpcError(model.DBError)
		}
		if tm == nil {
			display.CanRead = model.NoCanRead
		} else {
			display.CanRead = model.CanRead
		}
		taskDisplayList = append(taskDisplayList, display)
	}
	var taskMessageList []*task.TaskMessage
	copier.Copy(&taskMessageList, taskDisplayList)
	return &task.TaskListResponse{List: taskMessageList}, nil
}
~~~



## 5. 任务列表

请求uri：project/task/selfList

参数：

| 字段                    | 类型   | 描述                                      |
| ----------------------- | ------ | ----------------------------------------- |
| Authorization（Header） | string | bearer ${token}                           |
| page(form表单)          | int    | 当前页数                                  |
| pageSize(form表单)      | int    | 每页显示数量                              |
| taskType                | int    | 任务类型 1 我执行的 2 我参与的 3 我创建的 |
| type                    | int    | 0 未完成 1 已完成                         |

响应：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "list":[
            {
                "id":12368,
                "code":"lafy9kec23mzs1noqwj874pr",
                "project_code":"lbevtfoz618xr7su3ih0mpnc",
                "name":"213213",
                "pri":0,
                "execute_status":"wait",
                "description":"",
                "create_by":"6v7be19pwman2fird04gqu53",
                "done_by":null,
                "done_time":null,
                "create_time":"2022-07-26 21:46:55",
                "assign_to":"6v7be19pwman2fird04gqu53",
                "deleted":0,
                "stage_code":"e9dtqrj1lx84pzoy30fvh6in",
                "task_tag":null,
                "done":0,
                "begin_time":"",
                "end_time":"",
                "remind_time":null,
                "pcode":"",
                "sort":65536,
                "like":0,
                "star":0,
                "deleted_time":null,
                "private":1,
                "id_num":3,
                "path":"",
                "schedule":0,
                "version_code":"0",
                "features_code":"0",
                "work_time":0,
                "status":0,
                "cover":"http:\/\/127.0.0.1\/static\/image\/default\/project-cover.png",
                "access_control_type":"open",
                "white_list":null,
                "order":0,
                "template_code":"",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "prefix":null,
                "open_prefix":0,
                "archive":0,
                "archive_time":null,
                "open_begin_time":0,
                "open_task_private":0,
                "task_board_theme":"simple",
                "auto_update_schedule":0,
                "parentDone":1,
                "hasUnDone":0,
                "priText":"普通",
                "executor":{
                    "name":"子龙",
                    "avatar":"https:\/\/static.vilson.xyz\/cover.png"
                },
                "projectInfo":{
                    "name":"12312",
                    "code":"lbevtfoz618xr7su3ih0mpnc"
                }
            },
            {
                "id":12367,
                "code":"jkpgncydz58w10mvf7xs62ar",
                "project_code":"lbevtfoz618xr7su3ih0mpnc",
                "name":"324234",
                "pri":0,
                "execute_status":"wait",
                "description":"",
                "create_by":"6v7be19pwman2fird04gqu53",
                "done_by":null,
                "done_time":null,
                "create_time":"2022-07-26 21:33:25",
                "assign_to":"6v7be19pwman2fird04gqu53",
                "deleted":0,
                "stage_code":"c64dw1tsokzxiha0gjqvln93",
                "task_tag":null,
                "done":0,
                "begin_time":"",
                "end_time":"",
                "remind_time":null,
                "pcode":"",
                "sort":65536,
                "like":0,
                "star":0,
                "deleted_time":null,
                "private":1,
                "id_num":2,
                "path":"",
                "schedule":0,
                "version_code":"0",
                "features_code":"0",
                "work_time":0,
                "status":0,
                "cover":"http:\/\/127.0.0.1\/static\/image\/default\/project-cover.png",
                "access_control_type":"open",
                "white_list":null,
                "order":0,
                "template_code":"",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "prefix":null,
                "open_prefix":0,
                "archive":0,
                "archive_time":null,
                "open_begin_time":0,
                "open_task_private":0,
                "task_board_theme":"simple",
                "auto_update_schedule":0,
                "parentDone":1,
                "hasUnDone":0,
                "priText":"普通",
                "executor":{
                    "name":"子龙",
                    "avatar":"https:\/\/static.vilson.xyz\/cover.png"
                },
                "projectInfo":{
                    "name":"12312",
                    "code":"lbevtfoz618xr7su3ih0mpnc"
                }
            },
            {
                "id":12366,
                "code":"62md58390gt7foacqswykvrb",
                "project_code":"lbevtfoz618xr7su3ih0mpnc",
                "name":"人团体",
                "pri":0,
                "execute_status":"wait",
                "description":"",
                "create_by":"6v7be19pwman2fird04gqu53",
                "done_by":null,
                "done_time":null,
                "create_time":"2022-07-26 21:31:13",
                "assign_to":"6v7be19pwman2fird04gqu53",
                "deleted":0,
                "stage_code":"z7ban2dkj15gwq0misr8oucx",
                "task_tag":null,
                "done":0,
                "begin_time":"",
                "end_time":"",
                "remind_time":null,
                "pcode":"",
                "sort":65536,
                "like":0,
                "star":0,
                "deleted_time":null,
                "private":1,
                "id_num":1,
                "path":"",
                "schedule":0,
                "version_code":"0",
                "features_code":"0",
                "work_time":0,
                "status":0,
                "cover":"http:\/\/127.0.0.1\/static\/image\/default\/project-cover.png",
                "access_control_type":"open",
                "white_list":null,
                "order":0,
                "template_code":"",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "prefix":null,
                "open_prefix":0,
                "archive":0,
                "archive_time":null,
                "open_begin_time":0,
                "open_task_private":0,
                "task_board_theme":"simple",
                "auto_update_schedule":0,
                "parentDone":1,
                "hasUnDone":0,
                "priText":"普通",
                "executor":{
                    "name":"子龙",
                    "avatar":"https:\/\/static.vilson.xyz\/cover.png"
                },
                "projectInfo":{
                    "name":"12312",
                    "code":"lbevtfoz618xr7su3ih0mpnc"
                }
            },
            {
                "id":12365,
                "code":"lp78wgimxjtu34vr0dn5csb2",
                "project_code":"7mdlxqzeay96i1rbk4uovnfh",
                "name":"123123",
                "pri":0,
                "execute_status":"wait",
                "description":"",
                "create_by":"6v7be19pwman2fird04gqu53",
                "done_by":null,
                "done_time":null,
                "create_time":"2022-07-26 21:25:52",
                "assign_to":"6v7be19pwman2fird04gqu53",
                "deleted":0,
                "stage_code":"t7xez34gqasinr908d6lwbuj",
                "task_tag":null,
                "done":0,
                "begin_time":"",
                "end_time":"",
                "remind_time":null,
                "pcode":"",
                "sort":65536,
                "like":0,
                "star":0,
                "deleted_time":null,
                "private":1,
                "id_num":3,
                "path":"",
                "schedule":0,
                "version_code":"0",
                "features_code":"0",
                "work_time":0,
                "status":0,
                "cover":"http:\/\/127.0.0.1\/static\/image\/default\/project-cover.png",
                "access_control_type":"open",
                "white_list":null,
                "order":0,
                "template_code":"",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "prefix":null,
                "open_prefix":0,
                "archive":0,
                "archive_time":null,
                "open_begin_time":0,
                "open_task_private":0,
                "task_board_theme":"simple",
                "auto_update_schedule":0,
                "parentDone":1,
                "hasUnDone":0,
                "priText":"普通",
                "executor":{
                    "name":"子龙",
                    "avatar":"https:\/\/static.vilson.xyz\/cover.png"
                },
                "projectInfo":{
                    "name":"财务管理系统",
                    "code":"7mdlxqzeay96i1rbk4uovnfh"
                }
            },
            {
                "id":12364,
                "code":"tmkyx21o4976w5pbached0iz",
                "project_code":"7mdlxqzeay96i1rbk4uovnfh",
                "name":"123123",
                "pri":0,
                "execute_status":"wait",
                "description":"",
                "create_by":"6v7be19pwman2fird04gqu53",
                "done_by":null,
                "done_time":null,
                "create_time":"2022-07-26 21:25:46",
                "assign_to":"6v7be19pwman2fird04gqu53",
                "deleted":0,
                "stage_code":"712uozsl6rj0fyhtp5ckix9n",
                "task_tag":null,
                "done":0,
                "begin_time":"",
                "end_time":"",
                "remind_time":null,
                "pcode":"",
                "sort":131072,
                "like":0,
                "star":0,
                "deleted_time":null,
                "private":1,
                "id_num":2,
                "path":"",
                "schedule":0,
                "version_code":"0",
                "features_code":"0",
                "work_time":0,
                "status":0,
                "cover":"http:\/\/127.0.0.1\/static\/image\/default\/project-cover.png",
                "access_control_type":"open",
                "white_list":null,
                "order":0,
                "template_code":"",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "prefix":null,
                "open_prefix":0,
                "archive":0,
                "archive_time":null,
                "open_begin_time":0,
                "open_task_private":0,
                "task_board_theme":"simple",
                "auto_update_schedule":0,
                "parentDone":1,
                "hasUnDone":0,
                "priText":"普通",
                "executor":{
                    "name":"子龙",
                    "avatar":"https:\/\/static.vilson.xyz\/cover.png"
                },
                "projectInfo":{
                    "name":"财务管理系统",
                    "code":"7mdlxqzeay96i1rbk4uovnfh"
                }
            },
            {
                "id":12363,
                "code":"t7nr8ifcq3hxubp1j9o5egaz",
                "project_code":"7mdlxqzeay96i1rbk4uovnfh",
                "name":"213",
                "pri":0,
                "execute_status":"wait",
                "description":"",
                "create_by":"6v7be19pwman2fird04gqu53",
                "done_by":null,
                "done_time":null,
                "create_time":"2022-07-26 21:25:44",
                "assign_to":"6v7be19pwman2fird04gqu53",
                "deleted":0,
                "stage_code":"712uozsl6rj0fyhtp5ckix9n",
                "task_tag":null,
                "done":0,
                "begin_time":"",
                "end_time":"",
                "remind_time":null,
                "pcode":"",
                "sort":65536,
                "like":0,
                "star":0,
                "deleted_time":null,
                "private":1,
                "id_num":1,
                "path":"",
                "schedule":0,
                "version_code":"0",
                "features_code":"0",
                "work_time":0,
                "status":0,
                "cover":"http:\/\/127.0.0.1\/static\/image\/default\/project-cover.png",
                "access_control_type":"open",
                "white_list":null,
                "order":0,
                "template_code":"",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "prefix":null,
                "open_prefix":0,
                "archive":0,
                "archive_time":null,
                "open_begin_time":0,
                "open_task_private":0,
                "task_board_theme":"simple",
                "auto_update_schedule":0,
                "parentDone":1,
                "hasUnDone":0,
                "priText":"普通",
                "executor":{
                    "name":"子龙",
                    "avatar":"https:\/\/static.vilson.xyz\/cover.png"
                },
                "projectInfo":{
                    "name":"财务管理系统",
                    "code":"7mdlxqzeay96i1rbk4uovnfh"
                }
            }
        ],
        "total":6
    }
}
~~~

### 5.1 api

~~~go

type MyTaskDisplay struct {
	ProjectCode        string      `json:"project_code"`
	Name               string      `json:"name"`
	Pri                int         `json:"pri"`
	ExecuteStatus      string      `json:"execute_status"`
	Description        string      `json:"description"`
	CreateBy           string      `json:"create_by"`
	DoneBy             string      `json:"done_by"`
	DoneTime           string      `json:"done_time"`
	CreateTime         string      `json:"create_time"`
	AssignTo           string      `json:"assign_to"`
	Deleted            int         `json:"deleted"`
	StageCode          string      `json:"stage_code"`
	TaskTag            string      `json:"task_tag"`
	Done               int         `json:"done"`
	BeginTime          string      `json:"begin_time"`
	EndTime            string      `json:"end_time"`
	RemindTime         string      `json:"remind_time"`
	Pcode              string      `json:"pcode"`
	Sort               int         `json:"sort"`
	Like               int         `json:"like"`
	Star               int         `json:"star"`
	DeletedTime        string      `json:"deleted_time"`
	Private            int         `json:"private"`
	IdNum              int         `json:"id_num"`
	Path               string      `json:"path"`
	Schedule           int         `json:"schedule"`
	VersionCode        string      `json:"version_code"`
	FeaturesCode       string      `json:"features_code"`
	WorkTime           int         `json:"work_time"`
	Status             int         `json:"status"`
	Code               string      `json:"code"`
	ProjectName        string      `json:"project_name"`
	Cover              string      `json:"cover"`
	AccessControlType  string      `json:"access_control_type"`
	WhiteList          string      `json:"white_list"`
	Order              int         `json:"order"`
	TemplateCode       string      `json:"template_code"`
	OrganizationCode   string      `json:"organization_code"`
	Prefix             string      `json:"prefix"`
	OpenPrefix         int         `json:"open_prefix"`
	Archive            int         `json:"archive"`
	ArchiveTime        string      `json:"archive_time"`
	OpenBeginTime      int         `json:"open_begin_time"`
	OpenTaskPrivate    int         `json:"open_task_private"`
	TaskBoardTheme     string      `json:"task_board_theme"`
	AutoUpdateSchedule int         `json:"auto_update_schedule"`
	HasUnDone          int         `json:"hasUnDone"`
	ParentDone         int         `json:"parentDone"`
	PriText            string      `json:"priText"`
	Executor           Executor    `json:"executor"`
	ProjectInfo        ProjectInfo `json:"projectInfo"`
}

type ProjectInfo struct {
	Name string `json:"name"`
	Code string `json:"code"`
}


~~~

~~~go

func (t *HandlerTask) myTaskList(c *gin.Context) {
	result := &common.Result{}
	var req *tasks.MyTaskReq
	c.ShouldBind(&req)
	memberId := c.GetInt64("memberId")
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &task.TaskReqMessage{
		MemberId: memberId,
		TaskType: int32(req.TaskType),
		Type:     int32(req.Type),
	}
	myTaskListResponse, err := TaskServiceClient.MyTaskList(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	var myTaskList []*tasks.MyTaskDisplay
	copier.Copy(&myTaskList, myTaskListResponse.List)
	if myTaskList == nil {
		myTaskList = []*tasks.MyTaskDisplay{}
	}
	for _, v := range myTaskList {
		v.ProjectInfo = tasks.ProjectInfo{
			Name: v.ProjectName,
			Code: v.ProjectCode,
		}
	}
	c.JSON(http.StatusOK, result.Success(gin.H{
		"list":  myTaskList,
		"total": myTaskListResponse.Total,
	}))
}
~~~

### 5.2 proto

~~~protobuf
syntax = "proto3";
package task.service.v1;
option go_package = "project-project/pkg/service/project.service.v1";

message TaskReqMessage{
  string projectCode = 1;
  int64 page = 2;
  int64 pageSize = 3;
  string stageCode = 4;
  string name = 5;
  string assignTo = 6;
  int64 memberId = 7;
  int32 taskType = 8;
  int32 type = 9;

}
message TaskStagesMessage{
  string code = 1;
  string name = 2;
  string projectCode = 3;
  int32 sort = 4;
  string description = 5;
  string createTime = 6;
  int32 deleted = 7;
  int32 id = 8;
}
message TaskStagesResponse{
  int64 total = 1;
  repeated TaskStagesMessage list = 2;
}
message MemberProjectMessage{
  string name = 1;
  string avatar = 2;
  int64 memberCode = 3;
  string code = 4;
  string email = 5;
  int32 isOwner = 6;
}
message MemberProjectResponse{
  int64 total = 1;
  repeated MemberProjectMessage list = 2;
}

message TaskMessage{
  int64 Id  = 1;
  string ProjectCode  = 2;
  string Name  = 3;
  int32 Pri  = 4;
  string ExecuteStatus  = 5;
  string Description  = 6;
  string CreateBy  = 7;
  string DoneBy  = 8;
  string DoneTime  = 9;
  string CreateTime  = 10;
  string AssignTo  = 11;
  int32 Deleted  = 12;
  string StageCode  = 13;
  string TaskTag  = 14;
  int32 Done  = 15;
  string BeginTime  = 16;
  string EndTime  = 17;
  string RemindTime  = 18;
  string Pcode  = 19;
  int32 Sort  = 20;
  int32 Like  = 21;
  int32 Star  = 22;
  string DeletedTime  = 23;
  int32 Private  = 24;
  int32 IdNum  = 25;
  string Path  = 26;
  int32 Schedule  = 27;
  string VersionCode  = 28;
  string FeaturesCode  = 29;
  int32 WorkTime  = 30;
  int32 Status  = 31;
  string code = 32;
  int32 canRead = 33;
}
message TaskListResponse{
  repeated TaskMessage list = 1;
}

message MyTaskMessage{
  int64 Id  = 1;
  string ProjectCode  = 2;
  string Name  = 3;
  int32 Pri  = 4;
  string ExecuteStatus  = 5;
  string Description  = 6;
  string CreateBy  = 7;
  string DoneBy  = 8;
  string DoneTime  = 9;
  string CreateTime  = 10;
  string AssignTo  = 11;
  int32 Deleted  = 12;
  string StageCode  = 13;
  string TaskTag  = 14;
  int32 Done  = 15;
  string BeginTime  = 16;
  string EndTime  = 17;
  string RemindTime  = 18;
  string Pcode  = 19;
  int32 Sort  = 20;
  int32 Like  = 21;
  int32 Star  = 22;
  string DeletedTime  = 23;
  int32 Private  = 24;
  int32 IdNum  = 25;
  string Path  = 26;
  int32 Schedule  = 27;
  string VersionCode  = 28;
  string FeaturesCode  = 29;
  int32 WorkTime  = 30;
  int32 Status  = 31;
  string code = 32;
  string Cover = 33;
  string AccessControlType = 34;
  string WhiteList = 35;
  int32 Order =36;
  string TemplateCode = 37;
  string OrganizationCode = 38;
  string Prefix = 39;
  int32 OpenPrefix = 40;
  int32 Archive = 41;
  int64 ArchiveTime = 42;
  int32 OpenBeginTime = 43;
  int32 OpenTaskPrivate = 44;
  string TaskBoardTheme = 45;
  int32 AutoUpdateSchedule = 46;
  ExecutorMessage executor = 47;
  string projectName = 48;
}
message ExecutorMessage{
  string name = 1;
  string avatar = 2;
}
message MyTaskListResponse{
  repeated MyTaskMessage list = 1;
  int64  total = 2;
}
service TaskService {
  rpc TaskStages(TaskReqMessage) returns (TaskStagesResponse){}
  rpc MemberProjectList(TaskReqMessage) returns (MemberProjectResponse){}
  rpc TaskList(TaskReqMessage) returns (TaskListResponse){}
  rpc SaveTask(TaskReqMessage) returns (TaskMessage){}
  rpc MyTaskList(TaskReqMessage) returns (MyTaskListResponse){}
}
~~~

### 5.3 服务实现

~~~go

func (t *TaskService) MyTaskList(ctx context.Context, msg *task.TaskReqMessage) (*task.MyTaskListResponse, error) {
	var tsList []*data.Task
	var err error
	var total int64
	if msg.TaskType == 1 {
		//我执行的
		tsList, total, err = t.taskRepo.FindTaskByAssignTo(ctx, msg.MemberId, int(msg.Type))
		if err != nil {
			zap.L().Error("project task MyTaskList taskRepo.FindTaskByAssignTo error", zap.Error(err))
			return nil, errs.GrpcError(model.DBError)
		}
	}
	if msg.TaskType == 2 {
		//我执行的
		tsList, total, err = t.taskRepo.FindTaskByMemberCode(ctx, msg.MemberId, int(msg.Type))
		if err != nil {
			zap.L().Error("project task MyTaskList taskRepo.FindTaskByMemberCode error", zap.Error(err))
			return nil, errs.GrpcError(model.DBError)
		}
	}
	if msg.TaskType == 3 {
		//我执行的
		tsList, total, err = t.taskRepo.FindTaskByCreateBy(ctx, msg.MemberId, int(msg.Type))
		if err != nil {
			zap.L().Error("project task MyTaskList taskRepo.FindTaskByCreateBy error", zap.Error(err))
			return nil, errs.GrpcError(model.DBError)
		}
	}
	if tsList == nil || len(tsList) <= 0 {
		return &task.MyTaskListResponse{List: nil, Total: 0}, nil
	}
	var pids []int64
	var mids []int64
	for _, v := range tsList {
		pids = append(pids, v.ProjectCode)
		mids = append(mids, v.AssignTo)
	}
	pList, err := t.projectRepo.FindProjectByIds(ctx, pids)
	projectMap := data.ToProjectMap(pList)

	mList, err := rpc.LoginServiceClient.FindMemInfoByIds(ctx, &login.UserMessage{
		MIds: mids,
	})
	mMap := make(map[int64]*login.MemberMessage)
	for _, v := range mList.MemberList {
		mMap[v.Id] = v
	}
	var mtdList []*data.MyTaskDisplay
	for _, v := range tsList {
		memberMessage := mMap[v.AssignTo]
		name := memberMessage.Name
		avatar := memberMessage.Avatar
		mtd := v.ToMyTaskDisplay(projectMap[v.ProjectCode], name, avatar)
		mtdList = append(mtdList, mtd)
	}
	var myMsgs []*task.MyTaskMessage
	copier.Copy(&myMsgs, mtdList)
	return &task.MyTaskListResponse{List: myMsgs, Total: total}, nil
}

~~~

~~~go

type MyTaskDisplay struct {
	Id                 int64
	ProjectCode        string
	Name               string
	Pri                int
	ExecuteStatus      string
	Description        string
	CreateBy           string
	DoneBy             string
	DoneTime           string
	CreateTime         string
	AssignTo           string
	Deleted            int
	StageCode          string
	TaskTag            string
	Done               int
	BeginTime          string
	EndTime            string
	RemindTime         string
	Pcode              string
	Sort               int
	Like               int
	Star               int
	DeletedTime        string
	Private            int
	IdNum              int
	Path               string
	Schedule           int
	VersionCode        string
	FeaturesCode       string
	WorkTime           int
	Status             int
	Code               string
	Cover              string `json:"cover"`
	AccessControlType  string `json:"access_control_type"`
	WhiteList          string `json:"white_list"`
	Order              int    `json:"order"`
	TemplateCode       string `json:"template_code"`
	OrganizationCode   string `json:"organization_code"`
	Prefix             string `json:"prefix"`
	OpenPrefix         int    `json:"open_prefix"`
	Archive            int    `json:"archive"`
	ArchiveTime        string `json:"archive_time"`
	OpenBeginTime      int    `json:"open_begin_time"`
	OpenTaskPrivate    int    `json:"open_task_private"`
	TaskBoardTheme     string `json:"task_board_theme"`
	AutoUpdateSchedule int    `json:"auto_update_schedule"`
	HasUnDone          int    `json:"hasUnDone"`
	ParentDone         int    `json:"parentDone"`
	PriText            string `json:"priText"`
	ProjectName        string
	Executor           *Executor
}

type Executor struct {
	Name   string `json:"name"`
	Avatar string `json:"avatar"`
}

func (t *Task) ToMyTaskDisplay(p *Project, name string, avatar string) *MyTaskDisplay {
	td := &MyTaskDisplay{}
	copier.Copy(td, p)
	copier.Copy(td, t)
	td.Executor = &Executor{
		Name:   name,
		Avatar: avatar,
	}
	td.ProjectName = p.Name
	td.CreateTime = tms.FormatByMill(t.CreateTime)
	td.DoneTime = tms.FormatByMill(t.DoneTime)
	td.BeginTime = tms.FormatByMill(t.BeginTime)
	td.EndTime = tms.FormatByMill(t.EndTime)
	td.RemindTime = tms.FormatByMill(t.RemindTime)
	td.DeletedTime = tms.FormatByMill(t.DeletedTime)
	td.CreateBy = encrypts.EncryptNoErr(t.CreateBy)
	td.ProjectCode = encrypts.EncryptNoErr(t.ProjectCode)
	td.DoneBy = encrypts.EncryptNoErr(t.DoneBy)
	td.AssignTo = encrypts.EncryptNoErr(t.AssignTo)
	td.StageCode = encrypts.EncryptNoErr(int64(t.StageCode))
	td.Pcode = encrypts.EncryptNoErr(t.Pcode)
	td.VersionCode = encrypts.EncryptNoErr(t.VersionCode)
	td.FeaturesCode = encrypts.EncryptNoErr(t.FeaturesCode)
	td.ExecuteStatus = t.GetExecuteStatusStr()
	td.Code = encrypts.EncryptNoErr(t.Id)
	td.AccessControlType = p.GetAccessControlType()
	td.ArchiveTime = tms.FormatByMill(p.ArchiveTime)
	td.TemplateCode = encrypts.EncryptNoErr(int64(p.TemplateCode))
	td.OrganizationCode = encrypts.EncryptNoErr(p.OrganizationCode)
	return td
}
~~~

~~~go
type TaskRepo interface {
	FindTaskByStageCode(ctx context.Context, stageCode int) ([]*data.Task, error)
	FindTaskMaxIdNum(ctx context.Context, projectCode int64) (int64, error)
	FindTaskSort(ctx context.Context, projectCode int64, stageCode int64) (int64, error)
	SaveTask(ctx context.Context, conn database.DbConn, ts *data.Task) error
	SaveTaskMember(ctx context.Context, conn database.DbConn, tm *data.TaskMember) error
	FindTaskMemberByTaskId(ctx context.Context, taskCode int64, memberCode int64) (*data.TaskMember, error)
	FindTaskByAssignTo(ctx context.Context, memberId int64, done int) ([]*data.Task, int64, error)
	FindTaskByMemberCode(ctx context.Context, memberId int64, done int) (tList []*data.Task, total int64, err error)
	FindTaskByCreateBy(ctx context.Context, memberId int64, done int) (tList []*data.Task, total int64, err error)
}
~~~

~~~go

func (t *TaskDao) FindTaskByCreateBy(ctx context.Context, memberId int64, done int) (tList []*data.Task, total int64, err error) {
	session := t.conn.Session(ctx)
	err = session.Model(&data.Task{}).Where("create_by=? and deleted=0 and done=?", memberId, done).Find(&tList).Error
	err = session.Model(&data.Task{}).Where("create_by=? and deleted=0 and done=?", memberId, done).Count(&total).Error
	return
}

func (t *TaskDao) FindTaskByMemberCode(ctx context.Context, memberId int64, done int) (tList []*data.Task, total int64, err error) {
	session := t.conn.Session(ctx)
	sql := "select a.* from ms_task a,ms_task_member b where a.id=b.task_code and member_code=? and a.deleted=0 and a.done=?"
	raw := session.Model(&data.Task{}).Raw(sql, memberId, done)
	err = raw.Scan(&tList).Error
	if err != nil {
		return nil, 0, err
	}
	sqlCount := "select count(*) from ms_task a,ms_task_member b where a.id=b.task_code and member_code=? and a.deleted=0 and a.done=?"
	rawCount := session.Model(&data.Task{}).Raw(sqlCount, memberId, done)
	err = rawCount.Scan(&total).Error
	return
}

func (t *TaskDao) FindTaskByAssignTo(ctx context.Context, memberId int64, done int) (tsList []*data.Task, total int64, err error) {
	session := t.conn.Session(ctx)
	err = session.Model(&data.Task{}).Where("assign_to=? and deleted=0 and done=?", memberId, done).Find(&tsList).Error
	err = session.Model(&data.Task{}).Where("assign_to=? and deleted=0 and done=?", memberId, done).Count(&total).Error
	return
}

func (t *TaskDao) FindTaskMemberByTaskId(ctx context.Context, taskCode int64, memberCode int64) (*data.TaskMember, error) {
	var tm *data.TaskMember
	err := t.conn.Session(ctx).Where("task_code=? and member_code=?", taskCode, memberCode).Limit(1).Find(&tm).Error
	if err == gorm.ErrRecordNotFound {
		return nil, nil
	}
	return tm, err
}

~~~



## 6. 创建任务

请求uri：project/task/save

参数：

| 字段                    | 类型   | 描述            |
| ----------------------- | ------ | --------------- |
| Authorization（Header） | string | bearer ${token} |
| name(form表单)          | string | 内容            |
| stage_code(form表单)    | string | 步骤id          |
| project_code            | string | 项目id          |
| assign_to               | string | 分配的用户id    |

响应：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "code":"q6jpxum4io81nhg9fbckw07z",
        "project_code":"7mdlxqzeay96i1rbk4uovnfh",
        "name":"分发",
        "pri":0,
        "execute_status":"wait",
        "description":"",
        "create_by":"6v7be19pwman2fird04gqu53",
        "done_by":null,
        "done_time":null,
        "create_time":"2022-12-17 20:15:54",
        "assign_to":"6v7be19pwman2fird04gqu53",
        "deleted":0,
        "stage_code":"712uozsl6rj0fyhtp5ckix9n",
        "task_tag":null,
        "done":0,
        "begin_time":"",
        "end_time":"",
        "remind_time":null,
        "pcode":"",
        "sort":196608,
        "like":0,
        "star":0,
        "deleted_time":null,
        "private":1,
        "id_num":4,
        "path":"",
        "schedule":0,
        "version_code":"0",
        "features_code":"0",
        "work_time":0,
        "status":0,
        "executor":{
            "name":"子龙",
            "code":"6v7be19pwman2fird04gqu53",
            "avatar":"https:\/\/static.vilson.xyz\/cover.png"
        },
        "openBeginTime":1,
        "projectName":"财务管理系统",
        "stageName":"需求收集",
        "priText":"普通",
        "statusText":"未开始",
        "liked":0,
        "stared":0,
        "tags":[

        ],
        "childCount":[
            0,
            0
        ],
        "hasUnDone":0,
        "parentDone":1,
        "hasComment":0,
        "hasSource":0,
        "canRead":1
    }
}
~~~

### 6.1 实现

~~~go
type TaskSaveReq struct {
	Name        string `form:"name"`
	StageCode   string `form:"stage_code"`
	ProjectCode string `form:"project_code"`
	AssignTo    string `form:"assign_to"`
}

~~~

~~~go

func (t *HandlerTask) saveTask(c *gin.Context) {
	result := &common.Result{}
	var req *tasks.TaskSaveReq
	c.ShouldBind(&req)
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &task.TaskReqMessage{
		ProjectCode: req.ProjectCode,
		Name:        req.Name,
		StageCode:   req.StageCode,
		AssignTo:    req.AssignTo,
		MemberId:    c.GetInt64("memberId"),
	}
	taskMessage, err := TaskServiceClient.SaveTask(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	td := &tasks.TaskDisplay{}
	copier.Copy(td, taskMessage)
	if td != nil {
		if td.Tags == nil {
			td.Tags = []int{}
		}
		if td.ChildCount == nil {
			td.ChildCount = []int{}
		}
	}
	c.JSON(http.StatusOK, result.Success(td))
}
~~~

~~~go
func (t *TaskService) SaveTask(ctx context.Context, msg *task.TaskReqMessage) (*task.TaskMessage, error) {
	//先检查业务
	if msg.Name == "" {
		return nil, errs.GrpcError(model.TaskNameNotNull)
	}
	stageCode := encrypts.DecryptNoErr(msg.StageCode)
	taskStages, err := t.taskStagesRepo.FindById(ctx, int(stageCode))
	if err != nil {
		zap.L().Error("project task SaveTask taskStagesRepo.FindById error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	if taskStages == nil {
		return nil, errs.GrpcError(model.TaskStagesNotNull)
	}
	projectCode := encrypts.DecryptNoErr(msg.ProjectCode)
	project, err := t.projectRepo.FindProjectById(ctx, projectCode)
	if err != nil {
		zap.L().Error("project task SaveTask projectRepo.FindProjectById error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	if project.Deleted == model.Deleted {
		return nil, errs.GrpcError(model.ProjectAlreadyDeleted)
	}
	maxIdNum, err := t.taskRepo.FindTaskMaxIdNum(ctx, projectCode)
	if err != nil {
		zap.L().Error("project task SaveTask taskRepo.FindTaskMaxIdNum error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	maxSort, err := t.taskRepo.FindTaskSort(ctx, projectCode, stageCode)
	if err != nil {
		zap.L().Error("project task SaveTask taskRepo.FindTaskSort error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	assignTo := encrypts.DecryptNoErr(msg.AssignTo)
	ts := &tasks.Task{
		Name:        msg.Name,
		CreateTime:  time.Now().UnixMilli(),
		CreateBy:    msg.MemberId,
		AssignTo:    assignTo,
		ProjectCode: projectCode,
		StageCode:   int(stageCode),
		IdNum:       int(maxIdNum + 1),
		Private:     project.OpenTaskPrivate,
		Sort:        int(maxSort + 1),
		BeginTime:   time.Now().UnixMilli(),
		EndTime:     time.Now().Add(2 * 24 * time.Hour).UnixMilli(),
	}
	err = t.transaction.Action(func(conn database.DbConn) error {
		err = t.taskRepo.SaveTask(ctx, conn, ts)
		if err != nil {
			zap.L().Error("project task SaveTask taskRepo.SaveTask error", zap.Error(err))
			return errs.GrpcError(model.DBError)
		}
		tm := &tasks.TaskMember{
			MemberCode: msg.MemberId,
			TaskCode:   ts.Id,
			IsExecutor: model.Executor,
			JoinTime:   time.Now().UnixMilli(),
			IsOwner:    model.Owner,
		}
		err = t.taskRepo.SaveTaskMember(ctx, conn, tm)
		if err != nil {
			zap.L().Error("project task SaveTask taskRepo.SaveTaskMember error", zap.Error(err))
			return errs.GrpcError(model.DBError)
		}
		return nil
	})
	if err != nil {
		return nil, err
	}
	display := ts.ToTaskDisplay()
	tm := &task.TaskMessage{}
	copier.Copy(tm, display)
	return tm, nil
}
~~~

~~~go
package repo

import (
	"context"
	"test.com/project-project/internal/data/tasks"
	"test.com/project-project/internal/database"
)

type TaskStagesTemplateRepo interface {
	FindInProTemIds(ctx context.Context, ids []int) ([]tasks.MsTaskStagesTemplate, error)
	FindByProjectTemplate(ctx context.Context, projectTemplateCode int) ([]tasks.MsTaskStagesTemplate, error)
}
type TaskStagesRepo interface {
	Save(ctx context.Context, conn database.DbConn, stages *tasks.TaskStages) error
	FindByProjectCode(ctx context.Context, projectCode int64, page int64, size int64) ([]*tasks.TaskStages, int64, error)
	FindById(ctx context.Context, stageCode int) (*tasks.TaskStages, error)
}

type TaskRepo interface {
	FindTaskByStageCode(ctx context.Context, stageCode int) ([]*tasks.Task, error)
	FindTaskMaxIdNum(ctx context.Context, projectCode int64) (int64, error)
	FindTaskSort(ctx context.Context, projectCode int64, stageCode int64) (int64, error)
	SaveTask(ctx context.Context, conn database.DbConn, ts *tasks.Task) error
	SaveTaskMember(ctx context.Context, conn database.DbConn, tm *tasks.TaskMember) error
	FindTaskMemberByTaskId(ctx context.Context, taskCode int64, memberCode int64) (*tasks.TaskMember, error)
}

~~~

~~~go

func (t *TaskDao) SaveTaskMember(ctx context.Context, conn database.DbConn, tm *tasks.TaskMember) error {
	t.conn = conn.(*gorms.GormConn)
	return t.conn.Tx(ctx).Save(&tm).Error
}

func (t *TaskDao) SaveTask(ctx context.Context, conn database.DbConn, ts *tasks.Task) error {
	t.conn = conn.(*gorms.GormConn)
	return t.conn.Tx(ctx).Save(&ts).Error
}
func (t *TaskDao) FindTaskSort(ctx context.Context, projectCode int64, stageCode int64) (v int64, err error) {
	session := t.conn.Session(ctx)
	err = session.Model(&data.Task{}).Where("project_code=? and stage_code=?", projectCode, stageCode).Select("max(sort) as sort").Scan(&v).Error
	return
}

func (t *TaskDao) FindTaskMaxIdNum(ctx context.Context, projectCode int64) (v int64, err error) {
	session := t.conn.Session(ctx)
	err = session.Model(&data.Task{}).Where("project_code=?", projectCode).Select("max(id_num) as maxIdNum").Scan(&v).Error
	return
}

~~~



## 7. 移动任务

请求uri：project/task/sort

参数：

| 字段                    | 类型   | 描述            |
| ----------------------- | ------ | --------------- |
| Authorization（Header） | string | bearer ${token} |
| preTaskCode             | string | 上一个任务id    |
| nextTaskCode            | string | 下一个任务id    |
| toStageCode             | string | 移动到的步骤id  |

响应：

~~~json
{"code":200,"msg":"","data":[]}
~~~



### 7.1 实现

~~~go

func (t *HandlerTask) taskSort(c *gin.Context) {
	result := &common.Result{}
	var req *tasks.TaskSortReq
	c.ShouldBind(&req)
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &task.TaskReqMessage{
		PreTaskCode:  req.PreTaskCode,
		NextTaskCode: req.NextTaskCode,
		ToStageCode:  req.ToStageCode,
	}
	_, err := TaskServiceClient.TaskSort(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	c.JSON(http.StatusOK, result.Success([]int{}))
}
~~~

~~~go
type TaskSortReq struct {
	PreTaskCode  string `form:"preTaskCode"`
	NextTaskCode string `form:"nextTaskCode"`
	ToStageCode  string `form:"toStageCode"`
}

~~~

~~~protobuf

message TaskReqMessage{
  string projectCode = 1;
  int64 page = 2;
  int64 pageSize = 3;
  string stageCode = 4;
  string name = 5;
  string assignTo = 6;
  int64 memberId = 7;
  int32 taskType = 8;
  int32 type = 9;
  string preTaskCode = 10;
  string nextTaskCode = 11;
  string toStageCode = 12;
}
message TaskSortResponse{

}
service TaskService {
  rpc TaskSort(TaskReqMessage) returns (TaskSortResponse){}
}
~~~

~~~go

func (t *TaskService) TaskSort(ctx context.Context, msg *task.TaskReqMessage) (*task.TaskSortResponse, error) {
	preTaskCode := encrypts.DecryptNoErr(msg.PreTaskCode)
	stageCode := encrypts.DecryptNoErr(msg.ToStageCode)
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	ts, err := t.taskRepo.FindTaskById(c, preTaskCode)
	if err != nil {
		zap.L().Error("project task TaskSort taskRepo.FindTaskById error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	isChange := false
	if ts.StageCode != int(stageCode) {
		//任务步骤变化 移动到其他步骤
		ts.StageCode = int(stageCode)
		isChange = true
	}
	err = t.transaction.Action(func(conn database.DbConn) error {
		nextTaskCode := msg.NextTaskCode
		if nextTaskCode != "" {
			//顺序变了 需要互换位置
			nextTaskId := encrypts.DecryptNoErr(nextTaskCode)
			nextTs, err := t.taskRepo.FindTaskById(c, nextTaskId)
			if err != nil {
				zap.L().Error("project task TaskSort nextTaskId taskRepo.FindTaskById error", zap.Error(err))
				return errs.GrpcError(model.DBError)
			}
			sort := ts.Sort
			ts.Sort = nextTs.Sort
			nextTs.Sort = sort
			isChange = true
			err = t.taskRepo.UpdateTaskSort(ctx, conn, nextTs)
			if err != nil {
				return err
			}
		}
		if isChange {
			err := t.taskRepo.UpdateTaskSort(ctx, conn, ts)
			if err != nil {
				return err
			}
		}
		return nil
	})
	if err != nil {
		return nil, err
	}
	return &task.TaskSortResponse{}, nil
}

~~~

~~~go

type TaskRepo interface {
	FindTaskByStageCode(ctx context.Context, stageCode int) ([]*data.Task, error)
	FindTaskMaxIdNum(ctx context.Context, projectCode int64) (int64, error)
	FindTaskSort(ctx context.Context, projectCode int64, stageCode int64) (int64, error)
	SaveTask(ctx context.Context, conn database.DbConn, ts *data.Task) error
	SaveTaskMember(ctx context.Context, conn database.DbConn, tm *data.TaskMember) error
	FindTaskMemberByTaskId(ctx context.Context, taskCode int64, memberCode int64) (*data.TaskMember, error)
	FindTaskByAssignTo(ctx context.Context, memberId int64, done int) ([]*data.Task, int64, error)
	FindTaskByMemberCode(ctx context.Context, memberId int64, done int) (tList []*data.Task, total int64, err error)
	FindTaskByCreateBy(ctx context.Context, memberId int64, done int) (tList []*data.Task, total int64, err error)
	FindTaskById(ctx context.Context, taskCode int64) (*data.Task, error)
	UpdateTaskSort(ctx context.Context, conn database.DbConn, ts *data.Task) error
}
~~~

~~~go

func (t *TaskDao) UpdateTaskSort(ctx context.Context, conn database.DbConn, ts *data.Task) error {
	t.conn = conn.(*gorms.GormConn)
	err := t.conn.Tx(ctx).Model(&data.Task{}).
		Where("id=?", ts.Id).
		Select("sort", "stage_code").
		Updates(&ts).
		Error
	return err
}

func (t *TaskDao) FindTaskById(ctx context.Context, taskCode int64) (ts *data.Task, err error) {
	session := t.conn.Session(ctx)
	err = session.Where("id=?", taskCode).Take(&ts).Error
	return
}
~~~

### 7.2 改造排序

~~~go

func (t *TaskService) sortTask(preTaskCode int64, nextTaskCode string, toStageCode int64) error {
	//1. 从小到大排
	//2. 原有的顺序  比如 1 2 3 4 5 4排到2前面去 4的序号在1和2 之间 如果4是最后一个 保证 4比所有的序号都打 如果 排到第一位 直接置为0

	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	ts, err := t.taskRepo.FindTaskById(c, preTaskCode)
	if err != nil {
		zap.L().Error("project task TaskSort taskRepo.FindTaskById error", zap.Error(err))
		return errs.GrpcError(model.DBError)
	}
	err = t.transaction.Action(func(conn database.DbConn) error {
		//如果相等是不需要进行改变的
		ts.StageCode = int(toStageCode)
		if nextTaskCode != "" {
			//意味着要进行排序的替换
			nextTaskCode := encrypts.DecryptNoErr(nextTaskCode)
			next, err := t.taskRepo.FindTaskById(c, nextTaskCode)
			if err != nil {
				zap.L().Error("project task TaskSort taskRepo.FindTaskById error", zap.Error(err))
				return errs.GrpcError(model.DBError)
			}
			// next.Sort 要找到比它小的那个任务
			prepre, err := t.taskRepo.FindTaskByStageCodeLtSort(c, next.StageCode, next.Sort)
			if err != nil {
				zap.L().Error("project task TaskSort taskRepo.FindTaskByStageCodeLtSort error", zap.Error(err))
				return errs.GrpcError(model.DBError)
			}
			if prepre != nil {
				ts.Sort = (prepre.Sort + next.Sort) / 2
			}
			if prepre == nil {
				ts.Sort = 0
			}
			//sort := ts.Sort
			//ts.Sort = next.Sort
			//next.Sort = sort
			//err = t.taskRepo.UpdateTaskSort(c, conn, next)
			//if err != nil {
			//	zap.L().Error("project task TaskSort taskRepo.UpdateTaskSort error", zap.Error(err))
			//	return errs.GrpcError(model.DBError)
			//}
		} else {
			maxSort, err := t.taskRepo.FindTaskSort(c, ts.ProjectCode, int64(ts.StageCode))
			if err != nil {
				zap.L().Error("project task TaskSort taskRepo.FindTaskSort error", zap.Error(err))
				return errs.GrpcError(model.DBError)
			}
			if maxSort == nil {
				a := 0
				maxSort = &a
			}
			ts.Sort = *maxSort + 65536
		}
		if ts.Sort < 50 {
			//重置排序
			err = t.resetSort(toStageCode)
			if err != nil {
				zap.L().Error("project task TaskSort resetSort error", zap.Error(err))
				return errs.GrpcError(model.DBError)
			}
			return t.sortTask(preTaskCode, nextTaskCode, toStageCode)
		}
		err = t.taskRepo.UpdateTaskSort(c, conn, ts)
		if err != nil {
			zap.L().Error("project task TaskSort taskRepo.UpdateTaskSort error", zap.Error(err))
			return errs.GrpcError(model.DBError)
		}
		return nil
	})
	return err
}

func (t *TaskService) resetSort(stageCode int64) error {
	list, err := t.taskRepo.FindTaskByStageCode(context.Background(), int(stageCode))
	if err != nil {
		return err
	}
	return t.transaction.Action(func(conn database.DbConn) error {
		iSort := 65536
		for index, v := range list {
			v.Sort = (index + 1) * iSort
			return t.taskRepo.UpdateTaskSort(context.Background(), conn, v)
		}
		return nil
	})

}
~~~

~~~go

func (t *TaskDao) FindTaskByStageCodeLtSort(ctx context.Context, stageCode int, sort int) (ts *data.Task, err error) {
	session := t.conn.Session(ctx)
	err = session.Where("stage_code=? and sort < ?", stageCode, sort).Order("sort desc").Limit(1).Find(&ts).Error
	if err == gorm.ErrRecordNotFound {
		return nil, nil
	}
	return
}

~~~

