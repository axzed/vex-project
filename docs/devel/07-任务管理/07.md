# 任务管理

## 1. 思考

### 1.1 登录安全性

> 一个问题：如果用户的token被窃，如何保证安全性？



我们在前面的程序中，进行登录认证时，只是做了jwt的合法性认证，并无其他手段，也就意味着一旦用户的token丢失，在token的有效期内是无法保证用户安全的。

#### 1.1.1 通过绑定设备解决

如果是移动端，我们知道每个设备有唯一的设备id，生成token时将设备id，放入jwt中的payload中，如果用户请求的设备id和token中的不一致时，通知用户重新进行登录。

**由于jwt的slat值在我们手中，并不担心token的伪造**

在想的极端一点，如果设备id能被伪造，也就是说后端收到的请求设备id和token是一致的，这种怎么办？

在这种情况下，设备id只要不被攻击者知道即可，这时候，我们在和前端传递token时，可以在做一层`加密`。

#### 1.1.2 通过绑定客户端ip解决

如果是浏览器，这也是我们应用的场景，可以在登录时获取到当前用户的客户端ip，放入jwt中的payload中，如果下次请求的客户端ip和token中的不一致时，通知用户重新进行登录。

~~~go
// 获取ip函数
func GetIp(c *gin.Context) string {
	ip := c.ClientIP()
	if ip == "::1" {
		ip = "127.0.0.1"
	}
	return ip
}
~~~

一般情况下，客户端ip无法被篡改，因为其要进行tcp三次握手。

可以放在一台服务器上进行测试一下：

~~~go
package main

import (
	"flag"
	"fmt"
	"github.com/gin-gonic/gin"
)

var port = flag.Int("port", 9999, "server port")

func main() {
	flag.Parse()
	engine := gin.Default()
	engine.GET("/getIp", func(c *gin.Context) {
		ip := c.ClientIP()
		if ip == "::1" {
			ip = "127.0.0.1"
		}
		c.JSON(200, gin.H{
			"ip": ip,
		})
	})
	err := engine.Run(fmt.Sprintf("0.0.0.0:%d", *port))
	if err != nil {
		panic(err)
	}
}

~~~

> 遇到恶意访问的情况，可以通过设置黑名单的形式去解决，这种一般会使用风控策略，场景常见于游戏，金融等场景 

#### 1.1.3 退出登录token失效

> jwt最大的好处在于其认证简单，安全以及快速

目前，我们的token是直接下发给客户端的，服务端对token是无感知的，也就是常说的无状态服务。

这时候如果退出登录，前端固然可以销毁存储的token，但如果仍旧持有旧token进行访问的时候，我们如何判别此用户已经登出了呢？

**之前，我们将登录用户的信息进行了缓存，退出登录时，只要清除缓存即可**

### 1.2 接口访问速度

> 一个接口写的是否合格，最直观的衡量标准就是接口从发起请求到响应所经历的时间，一般情况下，这个时间的上限是`300ms`，越小越好，因为用户直观的看到页面，会经历多个接口，还要请求页面资源等
>

**一定要注意300ms只是上限，一般接口时间都应该小于100ms，简单接口应该都小于50ms**

~~~go
package midd

import (
	"fmt"
	"github.com/gin-gonic/gin"
	"go.uber.org/zap"
	"time"
)

func RequestLog() func(*gin.Context) {

	return func(c *gin.Context) {
		start := time.Now()
		c.Next()
		diff := time.Now().UnixMilli() - start.UnixMilli()
		zap.L().Info(fmt.Sprintf("%s 用时 %d ms", c.Request.RequestURI, diff))
	}
}

~~~

#### 1.2.1 go特色优化

~~~go
func (srv *Server) Serve(l net.Listener) error {
	  //...每进来一个请求 go会开启一个协程处理
		go c.serve(connCtx)
	}
}
~~~

以MyTaskList为例：

```go
func (t *TaskService) MyTaskList(ctx context.Context, msg *task.TaskReqMessage) (*task.MyTaskListResponse, error) {
    //这个是查询数据库
    pList, err := t.projectRepo.FindProjectByIds(ctx, pids)
	projectMap := data.ToProjectMap(pList)
	//这个是查询用户信息 这两个操作是可以并行操作
	mList, err := rpc.LoginServiceClient.FindMemInfoByIds(ctx, &login.UserMessage{
		MIds: mids,
	})
}
   
```

~~~go
	pListChan := make(chan []*data.Project)
	defer close(pListChan)
	mListChan := make(chan *login.MemberMessageList)
	defer close(mListChan)
   
	go func() {
		pList, _ := t.projectRepo.FindProjectByIds(ctx, pids)
		pListChan <- pList
	}()
	go func() {
		mList, _ := rpc.LoginServiceClient.FindMemInfoByIds(ctx, &login.UserMessage{
			MIds: mids,
		})
		mListChan <- mList
	}()

	pList := <-pListChan
	projectMap := data.ToProjectMap(pList)
	mList := <-mListChan
	mMap := make(map[int64]*login.MemberMessage)
	for _, v := range mList.List {
		mMap[v.Id] = v
	}
~~~

**协程就是用来使用的，不用担心开启过多的协程，但需要注意，要控制开启长任务的协程数量**

## 2. 任务详情

请求uri：project/task/read

参数：

| 字段          | 类型   | 描述   |
| ------------- | ------ | ------ |
| Authorization | string | header |
| taskCode      | string | 任务id |

返回：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "code":"th8m10gor5xwunivpj2zfkyc",
        "project_code":"g5bt7cphnxq2kfu8jd1or0v4",
        "name":"test任务",
        "pri":0,
        "execute_status":"wait",
        "description":"",
        "create_by":"6v7be19pwman2fird04gqu53",
        "done_by":null,
        "done_time":null,
        "create_time":"2022-12-27 21:30:53",
        "assign_to":"6v7be19pwman2fird04gqu53",
        "deleted":0,
        "stage_code":"r3zd95xlof7y8wbu4e01kitn",
        "task_tag":null,
        "done":0,
        "begin_time":"",
        "end_time":"",
        "remind_time":null,
        "pcode":"",
        "sort":65536,
        "like":0,
        "star":0,
        "deleted_time":null,
        "private":0,
        "id_num":1,
        "path":"",
        "schedule":0,
        "version_code":"0",
        "features_code":"0",
        "work_time":0,
        "status":0,
        "executor":{
            "name":"子龙",
            "code":"6v7be19pwman2fird04gqu53",
            "avatar":"https:\/\/static.vilson.xyz\/cover.png"
        },
        "openBeginTime":0,
        "projectName":"测试项目",
        "stageName":"需求收集",
        "priText":"普通",
        "statusText":"未开始",
        "liked":0,
        "stared":0,
        "tags":[

        ],
        "childCount":[
            0,
            0
        ],
        "hasUnDone":0,
        "parentDone":1,
        "hasComment":0,
        "hasSource":1,
        "canRead":1
    }
}
~~~

### 2.1 实现

~~~go

func (t *HandlerTask) readTask(c *gin.Context) {
	result := &common.Result{}
	taskCode := c.PostForm("taskCode")
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &task.TaskReqMessage{
		TaskCode: taskCode,
		MemberId: c.GetInt64("memberId"),
	}
	taskMessage, err := TaskServiceClient.ReadTask(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	td := &tasks.TaskDisplay{}
	copier.Copy(td, taskMessage)
	if td != nil {
		if td.Tags == nil {
			td.Tags = []int{}
		}
		if td.ChildCount == nil {
			td.ChildCount = []int{}
		}
	}
	c.JSON(200, result.Success(td))
}
~~~

~~~go
type TaskDisplay struct {
	ProjectCode   string   `json:"project_code"`
	Name          string   `json:"name"`
	Pri           int      `json:"pri"`
	ExecuteStatus string   `json:"execute_status"`
	Description   string   `json:"description"`
	CreateBy      string   `json:"create_by"`
	DoneBy        string   `json:"done_by"`
	DoneTime      string   `json:"done_time"`
	CreateTime    string   `json:"create_time"`
	AssignTo      string   `json:"assign_to"`
	Deleted       int      `json:"deleted"`
	StageCode     string   `json:"stage_code"`
	TaskTag       string   `json:"task_tag"`
	Done          int      `json:"done"`
	BeginTime     string   `json:"begin_time"`
	EndTime       string   `json:"end_time"`
	RemindTime    string   `json:"remind_time"`
	Pcode         string   `json:"pcode"`
	Sort          int      `json:"sort"`
	Like          int      `json:"like"`
	Star          int      `json:"star"`
	DeletedTime   string   `json:"deleted_time"`
	Private       int      `json:"private"`
	IdNum         int      `json:"id_num"`
	Path          string   `json:"path"`
	Schedule      int      `json:"schedule"`
	VersionCode   string   `json:"version_code"`
	FeaturesCode  string   `json:"features_code"`
	WorkTime      int      `json:"work_time"`
	Status        int      `json:"status"`
	Code          string   `json:"code"`
	CanRead       int      `json:"canRead"`
	HasUnDone     int      `json:"hasUnDone"`
	ParentDone    int      `json:"parentDone"`
	HasComment    int      `json:"hasComment"`
	HasSource     int      `json:"hasSource"`
	Executor      Executor `json:"executor"`
	PriText       string   `json:"priText"`
	StatusText    string   `json:"statusText"`
	Liked         int      `json:"liked"`
	Stared        int      `json:"stared"`
	Tags          []int    `json:"tags"`
	ChildCount    []int    `json:"childCount"`
	ProjectName   string   `json:"projectName"`
	StageName     string   `json:"stageName"`
}
~~~

~~~protobuf

message TaskMessage{
  int64 Id  = 1;
  string ProjectCode  = 2;
  string Name  = 3;
  int32 Pri  = 4;
  string ExecuteStatus  = 5;
  string Description  = 6;
  string CreateBy  = 7;
  string DoneBy  = 8;
  string DoneTime  = 9;
  string CreateTime  = 10;
  string AssignTo  = 11;
  int32 Deleted  = 12;
  string StageCode  = 13;
  string TaskTag  = 14;
  int32 Done  = 15;
  string BeginTime  = 16;
  string EndTime  = 17;
  string RemindTime  = 18;
  string Pcode  = 19;
  int32 Sort  = 20;
  int32 Like  = 21;
  int32 Star  = 22;
  string DeletedTime  = 23;
  int32 Private  = 24;
  int32 IdNum  = 25;
  string Path  = 26;
  int32 Schedule  = 27;
  string VersionCode  = 28;
  string FeaturesCode  = 29;
  int32 WorkTime  = 30;
  int32 Status  = 31;
  string code = 32;
  int32 canRead = 33;
  ExecutorMessage executor = 34;
  string projectName = 35;
  string stageName = 36;
  string  priText = 37;
  string statusText = 38;
}
message TaskReqMessage {
  int64 memberId = 1;
  string projectCode = 2;
  int64 page = 3;
  int64 pageSize = 4;
  string stageCode = 5;
  string name = 6;
  string assignTo = 7;
  int32 taskType = 8;
  int32 type = 9;
  string preTaskCode = 10;
  string nextTaskCode = 11;
  string toStageCode = 12;
  string taskCode = 13;
}
service TaskService {
  rpc TaskStages(TaskReqMessage) returns (TaskStagesResponse) {}
  rpc MemberProjectList(TaskReqMessage) returns (MemberProjectResponse){}
  rpc TaskList(TaskReqMessage) returns (TaskListResponse){}
  rpc SaveTask(TaskReqMessage) returns(TaskMessage){}
  rpc TaskSort(TaskReqMessage) returns (TaskSortResponse){}
  rpc MyTaskList(TaskReqMessage) returns (MyTaskListResponse){}
  rpc ReadTask(TaskReqMessage) returns (TaskMessage){}
}
~~~



~~~go

const (
	Wait = iota
	Doing
	Done
	Pause
	Cancel
	Closed
)
const (
	NoStarted = iota
	Started
)
const (
	Normal = iota
	Urgent
	VeryUrgent
)

func (t *Task) GetStatusStr() string {
	status := t.Status
	if status == NoStarted {
		return "未开始"
	}
	if status == Started {
		return "开始"
	}
	return ""
}
func (t *Task) GetPriStr() string {
	status := t.Pri
	if status == Normal {
		return "普通"
	}
	if status == Urgent {
		return "紧急"
	}
	if status == VeryUrgent {
		return "非常紧急"
	}
	return ""
}
func (t *Task) GetExecuteStatusStr() string {
	status := t.ExecuteStatus
	if status == Wait {
		return "wait"
	}
	if status == Doing {
		return "doing"
	}
	if status == Done {
		return "done"
	}
	if status == Pause {
		return "pause"
	}
	if status == Cancel {
		return "cancel"
	}
	if status == Closed {
		return "closed"
	}
	return ""
}

type TaskDisplay struct {
	Id            int64
	ProjectCode   string
	Name          string
	Pri           int
	ExecuteStatus string
	Description   string
	CreateBy      string
	DoneBy        string
	DoneTime      string
	CreateTime    string
	AssignTo      string
	Deleted       int
	StageCode     string
	TaskTag       string
	Done          int
	BeginTime     string
	EndTime       string
	RemindTime    string
	Pcode         string
	Sort          int
	Like          int
	Star          int
	DeletedTime   string
	Private       int
	IdNum         int
	Path          string
	Schedule      int
	VersionCode   string
	FeaturesCode  string
	WorkTime      int
	Status        int
	Code          string
	CanRead       int
	Executor      Executor
	ProjectName   string
	StageName     string
	PriText       string
	StatusText    string
}

type Executor struct {
	Name   string
	Avatar string
	Code   string
}

func (t *Task) ToTaskDisplay() *TaskDisplay {
	td := &TaskDisplay{}
	copier.Copy(td, t)
	td.CreateTime = tms.FormatByMill(t.CreateTime)
	td.DoneTime = tms.FormatByMill(t.DoneTime)
	td.BeginTime = tms.FormatByMill(t.BeginTime)
	td.EndTime = tms.FormatByMill(t.EndTime)
	td.RemindTime = tms.FormatByMill(t.RemindTime)
	td.DeletedTime = tms.FormatByMill(t.DeletedTime)
	td.CreateBy = encrypts.EncryptNoErr(t.CreateBy)
	td.ProjectCode = encrypts.EncryptNoErr(t.ProjectCode)
	td.DoneBy = encrypts.EncryptNoErr(t.DoneBy)
	td.AssignTo = encrypts.EncryptNoErr(t.AssignTo)
	td.StageCode = encrypts.EncryptNoErr(int64(t.StageCode))
	td.Pcode = encrypts.EncryptNoErr(t.Pcode)
	td.VersionCode = encrypts.EncryptNoErr(t.VersionCode)
	td.FeaturesCode = encrypts.EncryptNoErr(t.FeaturesCode)
	td.ExecuteStatus = t.GetExecuteStatusStr()
	td.Code = encrypts.EncryptNoErr(t.Id)
	td.CanRead = 1
	td.StatusText = t.GetStatusStr()
	td.PriText = t.GetPriStr()
	return td
}
~~~

~~~go

func (t *TaskService) ReadTask(ctx context.Context, msg *task.TaskReqMessage) (*task.TaskMessage, error) {
	taskCode := encrypts.DecryptNoErr(msg.TaskCode)
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	taskInfo, err := t.taskRepo.FindTaskById(c, taskCode)
	if err != nil {
		zap.L().Error("project task ReadTask taskRepo FindTaskById error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	if taskInfo == nil {
		return &task.TaskMessage{}, nil
	}
	display := taskInfo.ToTaskDisplay()
	if taskInfo.Private == 1 {
		//代表隐私模式
		taskMember, err := t.taskRepo.FindTaskMemberByTaskId(ctx, taskInfo.Id, msg.MemberId)
		if err != nil {
			zap.L().Error("project task TaskList taskRepo.FindTaskMemberByTaskId error", zap.Error(err))
			return nil, errs.GrpcError(model.DBError)
		}
		if taskMember != nil {
			display.CanRead = model.CanRead
		} else {
			display.CanRead = model.NoCanRead
		}
	}
	pj, err := t.projectRepo.FindProjectById(c, taskInfo.ProjectCode)
	display.ProjectName = pj.Name
	taskStages, err := t.taskStagesRepo.FindById(c, taskInfo.StageCode)
	display.StageName = taskStages.Name
	// in ()
	memberMessage, err := rpc.LoginServiceClient.FindMemInfoById(ctx, &login.UserMessage{MemId: taskInfo.AssignTo})
	if err != nil {
		zap.L().Error("project task TaskList LoginServiceClient.FindMemInfoById error", zap.Error(err))
		return nil, err
	}
	e := data.Executor{
		Name:   memberMessage.Name,
		Avatar: memberMessage.Avatar,
	}
	display.Executor = e
	var taskMessage = &task.TaskMessage{}
	copier.Copy(taskMessage, display)
	return taskMessage, nil
}
~~~



## 3. 任务成员

请求uri：project/task_member

参数：

| 字段          | 类型   | 描述   |
| ------------- | ------ | ------ |
| Authorization | string | header |
| taskCode      | string | 任务id |
| pageSize      | int    |        |
| page          | int    |        |

返回：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "total":1,
        "page":1,
        "list":[
            {
                "id":582,
                "name":"子龙",
                "avatar":"https:\/\/static.vilson.xyz\/cover.png",
                "code":"6v7be19pwman2fird04gqu53",
                "membar_account_code":"6v7be19pwman2fird04gqu11",
                "is_executor":1,
                "is_owner":1
            }
        ]
    }
}
~~~

### 3.1 实现

~~~go

func (t *HandlerTask) listTaskMember(c *gin.Context) {
	result := &common.Result{}
	taskCode := c.PostForm("taskCode")
	page := &model.Page{}
	page.Bind(c)
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &task.TaskReqMessage{
		TaskCode: taskCode,
		MemberId: c.GetInt64("memberId"),
		Page:     page.Page,
		PageSize: page.PageSize,
	}
	taskMemberResponse, err := TaskServiceClient.ListTaskMember(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	var tms []*tasks.TaskMember
	copier.Copy(&tms, taskMemberResponse.List)
	if tms == nil {
		tms = []*tasks.TaskMember{}
	}
	c.JSON(http.StatusOK, result.Success(gin.H{
		"list":  tms,
		"total": taskMemberResponse.Total,
		"page":  page.Page,
	}))
}
~~~

~~~protobuf

message TaskMemberMessage{
  int64 id = 1;
  string name = 2;
  string avatar = 3;
  string code = 4;
  string membarAccountCode = 5;
  int32 isExecutor = 6;
  int32 isOwner = 7;
}

message TaskMemberList{
  repeated TaskMemberMessage list = 1;
  int64  total = 2;
}
service TaskService {
  rpc TaskStages(TaskReqMessage) returns (TaskStagesResponse) {}
  rpc MemberProjectList(TaskReqMessage) returns (MemberProjectResponse){}
  rpc TaskList(TaskReqMessage) returns (TaskListResponse){}
  rpc SaveTask(TaskReqMessage) returns(TaskMessage){}
  rpc TaskSort(TaskReqMessage) returns (TaskSortResponse){}
  rpc MyTaskList(TaskReqMessage) returns (MyTaskListResponse){}
  rpc ReadTask(TaskReqMessage) returns (TaskMessage){}
  rpc ListTaskMember(TaskReqMessage) returns(TaskMemberList){}
}
~~~

~~~go
func (t *TaskService) ListTaskMember(ctx context.Context, msg *task.TaskReqMessage) (*task.TaskMemberList, error) {
	taskCode := encrypts.DecryptNoErr(msg.TaskCode)
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	taskMemberPage, total, err := t.taskRepo.FindTaskMemberPage(c, taskCode, msg.Page, msg.PageSize)
	if err != nil {
		zap.L().Error("project task TaskList taskRepo.FindTaskMemberPage error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	var mids []int64
	for _, v := range taskMemberPage {
		mids = append(mids, v.MemberCode)
	}
	messageList, err := rpc.LoginServiceClient.FindMemInfoByIds(ctx, &login.UserMessage{MIds: mids})
	mMap := make(map[int64]*login.MemberMessage, len(messageList.List))
	for _, v := range messageList.List {
		mMap[v.Id] = v
	}
	var taskMemeberMemssages []*task.TaskMemberMessage
	for _, v := range taskMemberPage {
		tm := &task.TaskMemberMessage{}
		tm.Code = encrypts.EncryptNoErr(v.MemberCode)
		tm.Id = v.Id
		message := mMap[v.MemberCode]
		tm.Name = message.Name
		tm.Avatar = message.Avatar
		tm.IsExecutor = int32(v.IsExecutor)
		tm.IsOwner = int32(v.IsOwner)
		taskMemeberMemssages = append(taskMemeberMemssages, tm)
	}
	return &task.TaskMemberList{List: taskMemeberMemssages, Total: total}, nil
}

~~~

~~~go
func (t *TaskDao) FindTaskMemberPage(ctx context.Context, taskCode int64, page int64, size int64) (tList []*data.TaskMember, total int64, err error) {
	session := t.conn.Session(ctx)
	offset := (page - 1) * size
	err = session.Model(&data.TaskMember{}).
		Where("task_code=?", taskCode).
		Limit(int(size)).
		Offset(int(offset)).Find(&tList).Error
	err = session.Model(&data.TaskMember{}).
		Where("task_code=?", taskCode).
		Count(&total).Error
	return
}
~~~



## 4. 任务动态

请求uri：project/task/taskLog

参数：

| 字段          | 类型   | 描述                    |
| ------------- | ------ | ----------------------- |
| Authorization | string | header                  |
| taskCode      | string | 任务id                  |
| pageSize      | int    |                         |
| page          | int    |                         |
| all           | int    | 0 不显示全部 1 显示全部 |
| comment       | int    | 0 全部显示 1 只显示评论 |

返回：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "total":4,
        "page":1,
        "list":[
            {
                "id":4505,
                "code":"yfwkb5can3ohgej7qldi8u16",
                "member_code":"6v7be19pwman2fird04gqu53",
                "content":"test任务",
                "remark":"创建了任务 ",
                "type":"create",
                "create_time":"2022-12-27 21:30:53",
                "source_code":"th8m10gor5xwunivpj2zfkyc",
                "action_type":"task",
                "to_member_code":"",
                "is_comment":0,
                "project_code":"g5bt7cphnxq2kfu8jd1or0v4",
                "icon":"plus",
                "is_robot":0,
                "member":{
                    "id":582,
                    "name":"子龙",
                    "avatar":"https:\/\/static.vilson.xyz\/cover.png",
                    "code":"6v7be19pwman2fird04gqu53"
                }
            },
            {
                "id":4506,
                "code":"mdroybczit3uv9gjq0w47n26",
                "member_code":"6v7be19pwman2fird04gqu53",
                "content":"",
                "remark":"认领了任务 ",
                "type":"claim",
                "create_time":"2022-12-27 21:30:53",
                "source_code":"th8m10gor5xwunivpj2zfkyc",
                "action_type":"task",
                "to_member_code":"",
                "is_comment":0,
                "project_code":"g5bt7cphnxq2kfu8jd1or0v4",
                "icon":"user",
                "is_robot":0,
                "member":{
                    "id":582,
                    "name":"子龙",
                    "avatar":"https:\/\/static.vilson.xyz\/cover.png",
                    "code":"6v7be19pwman2fird04gqu53"
                }
            },
            {
                "id":4507,
                "code":"4rabs7v9ncwxdigl6kujh0t8",
                "member_code":"6v7be19pwman2fird04gqu53",
                "content":"<a target=\"_blank\" class=\"muted\" href=\"http:\/\/127.0.0.1\/static\/upload\/file\/default\/6v7be19pwman2fird04gqu53\/6v7be19pwman2fird04gqu53\/20221227\/20221227220823-封面.jpg \">封面.jpg<\/a>",
                "remark":"关联了文件 ",
                "type":"linkFile",
                "create_time":"2022-12-27 22:08:23",
                "source_code":"th8m10gor5xwunivpj2zfkyc",
                "action_type":"task",
                "to_member_code":"",
                "is_comment":0,
                "project_code":"g5bt7cphnxq2kfu8jd1or0v4",
                "icon":"link",
                "is_robot":0,
                "member":{
                    "id":582,
                    "name":"子龙",
                    "avatar":"https:\/\/static.vilson.xyz\/cover.png",
                    "code":"6v7be19pwman2fird04gqu53"
                }
            },
            {
                "id":4509,
                "code":"b1ims70y6hzacjngquo8e35t",
                "member_code":"6v7be19pwman2fird04gqu53",
                "content":"213",
                "remark":"213",
                "type":"comment",
                "create_time":"2022-12-27 22:16:11",
                "source_code":"th8m10gor5xwunivpj2zfkyc",
                "action_type":"task",
                "to_member_code":"",
                "is_comment":1,
                "project_code":"g5bt7cphnxq2kfu8jd1or0v4",
                "icon":"file-text",
                "is_robot":0,
                "member":{
                    "id":582,
                    "name":"子龙",
                    "avatar":"https:\/\/static.vilson.xyz\/cover.png",
                    "code":"6v7be19pwman2fird04gqu53"
                }
            }
        ]
    }
}
~~~

### 4.1 涉及到的表

~~~sql
CREATE TABLE `vex_project_log`  (
  `id` bigint(0) NOT NULL AUTO_INCREMENT,
  `member_code` bigint(0) NULL DEFAULT 0 COMMENT '操作人id',
  `content` text CHARACTER SET utf8 COLLATE utf8_general_ci NULL COMMENT '操作内容',
  `remark` text CHARACTER SET utf8 COLLATE utf8_general_ci NULL,
  `type` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT 'create' COMMENT '操作类型',
  `create_time` bigint(0) NULL DEFAULT NULL COMMENT '添加时间',
  `source_code` bigint(0) NULL DEFAULT 0 COMMENT '任务id',
  `action_type` varchar(30) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '场景类型',
  `to_member_code` bigint(0) NULL DEFAULT 0,
  `is_comment` tinyint(1) NULL DEFAULT 0 COMMENT '是否评论，0：否',
  `project_code` bigint(0) NULL DEFAULT NULL,
  `icon` varchar(20) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `is_robot` tinyint(1) NULL DEFAULT 0 COMMENT '是否机器人',
  PRIMARY KEY (`id`) USING BTREE,
  INDEX `member_code`(`member_code`) USING BTREE,
  INDEX `source_code`(`source_code`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 5086 CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '项目日志表' ROW_FORMAT = DYNAMIC;
~~~

当进行任何需要记录的操作时，想log中添加一条记录即可，动态就是展现出日志内容

### 4.2 实现

#### 4.2.1 添加动态

~~~go
package data

import (
	"github.com/jinzhu/copier"
	"test.com/project-common/encrypts"
	"test.com/project-common/tms"
)

type ProjectLog struct {
	Id           int64
	MemberCode   int64
	Content      string
	Remark       string
	Type         string
	CreateTime   int64
	SourceCode   int64
	ActionType   string
	ToMemberCode int64
	IsComment    int
	ProjectCode  int64
	Icon         string
	IsRobot      int
}

func (*ProjectLog) TableName() string {
	return "ms_project_log"
}

type ProjectLogDisplay struct {
	Id           int64
	MemberCode   string
	Content      string
	Remark       string
	Type         string
	CreateTime   string
	SourceCode   string
	ActionType   string
	ToMemberCode string
	IsComment    int
	ProjectCode  string
	Icon         string
	IsRobot      int
	Member       Member
}

func (l *ProjectLog) ToDisplay() *ProjectLogDisplay {
	pd := &ProjectLogDisplay{}
	copier.Copy(pd, l)
	pd.MemberCode = encrypts.EncryptNoErr(l.MemberCode)
	pd.ToMemberCode = encrypts.EncryptNoErr(l.ToMemberCode)
	pd.ProjectCode = encrypts.EncryptNoErr(l.ProjectCode)
	pd.CreateTime = tms.FormatByMill(l.CreateTime)
	pd.SourceCode = encrypts.EncryptNoErr(l.SourceCode)
	return pd
}

~~~

~~~go
package dao

import (
	"context"
	"test.com/project-project/internal/data"
	"test.com/project-project/internal/database/gorms"
)

type ProjectLogDao struct {
	conn *gorms.GormConn
}

func (p *ProjectLogDao) SaveProjectLog(pl *data.ProjectLog) {
	session := p.conn.Session(context.Background())
	session.Save(&pl)
}

func (p *ProjectLogDao) FindLogByTaskCode(ctx context.Context, taskCode int64, comment int) (list []*data.ProjectLog, total int64, err error) {
	session := p.conn.Session(ctx)
	model := session.Model(&data.ProjectLog{})
	if comment == 1 {
		model.Where("source_code=? and is_comment=?", taskCode, comment).Find(&list)
		model.Where("source_code=? and is_comment=?", taskCode, comment).Count(&total)
	} else {
		model.Where("source_code=?", taskCode).Find(&list)
		model.Where("source_code=?", taskCode).Count(&total)
	}
	return
}

func (p *ProjectLogDao) FindLogByTaskCodePage(ctx context.Context, taskCode int64, comment int, page int, pageSize int) (list []*data.ProjectLog, total int64, err error) {
	session := p.conn.Session(ctx)
	model := session.Model(&data.ProjectLog{})
	offset := (page - 1) * pageSize
	if comment == 1 {
		model.Where("source_code=? and is_comment=?", taskCode, comment).Limit(pageSize).Offset(offset).Find(&list)
		model.Where("source_code=? and is_comment=?", taskCode, comment).Count(&total)
	} else {
		model.Where("source_code=?", taskCode).Limit(pageSize).Offset(offset).Find(&list)
		model.Where("source_code=?", taskCode).Count(&total)
	}
	return
}

func NewProjectLogDao() *ProjectLogDao {
	return &ProjectLogDao{
		conn: gorms.New(),
	}
}

~~~

~~~go
package repo

import (
	"context"
	"test.com/project-project/internal/data"
)

type ProjectLogRepo interface {
	FindLogByTaskCode(ctx context.Context, taskCode int64, comment int) (list []*data.ProjectLog, total int64, err error)
	FindLogByTaskCodePage(ctx context.Context, taskCode int64, comment int, page int, pageSize int) (list []*data.ProjectLog, total int64, err error)
	SaveProjectLog(pl *data.ProjectLog)
}

~~~

~~~go
//添加任务动态
	createProjectLog(t.projectLogRepo, ts.ProjectCode, ts.Id, ts.Name, ts.AssignTo, "create", "task")
	

func createProjectLog(
	logRepo repo.ProjectLogRepo,
	projectCode int64,
	taskCode int64,
	taskName string,
	toMemberCode int64,
	logType string,
	actionType string) {
	remark := ""
	if logType == "create" {
		remark = "创建了任务"
	}
	pl := &data.ProjectLog{
		MemberCode:  toMemberCode,
		SourceCode:  taskCode,
		Content:     taskName,
		Remark:      remark,
		ProjectCode: projectCode,
		CreateTime:  time.Now().UnixMilli(),
		Type:        logType,
		ActionType:  actionType,
		Icon:        "plus",
		IsComment:   0,
		IsRobot:     0,
	}
	logRepo.SaveProjectLog(pl)
}
~~~

#### 4.2.2 查询

~~~go

func (t *HandlerTask) taskLog(c *gin.Context) {
	result := &common.Result{}
	var req *model.TaskLogReq
	c.ShouldBind(&req)
	if req.Page <= 0 {
		req.Page = 1
	}
	if req.PageSize <= 0 {
		req.PageSize = 10
	}
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &task.TaskReqMessage{
		TaskCode: req.TaskCode,
		MemberId: c.GetInt64("memberId"),
		Page:     int64(req.Page),
		PageSize: int64(req.PageSize),
		All:      int32(req.All),
		Comment:  int32(req.Comment),
	}
	taskLogResponse, err := TaskServiceClient.TaskLog(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	var tms []*model.ProjectLogDisplay
	copier.Copy(&tms, taskLogResponse.List)
	if tms == nil {
		tms = []*model.ProjectLogDisplay{}
	}
	c.JSON(http.StatusOK, result.Success(gin.H{
		"list":  tms,
		"total": taskLogResponse.Total,
		"page":  req.Page,
	}))
}
~~~

~~~go

type TaskLogReq struct {
	TaskCode string `form:"taskCode"`
	PageSize int    `form:"pageSize"`
	Page     int    `form:"page"`
	All      int    `form:"all"`
	Comment  int    `form:"comment"`
}
type ProjectLogDisplay struct {
	Id           int64  `json:"id"`
	MemberCode   string `json:"member_code"`
	Content      string `json:"content"`
	Remark       string `json:"remark"`
	Type         string `json:"type"`
	CreateTime   string `json:"create_time"`
	SourceCode   string `json:"source_code"`
	ActionType   string `json:"action_type"`
	ToMemberCode string `json:"to_member_code"`
	IsComment    int    `json:"is_comment"`
	ProjectCode  string `json:"project_code"`
	Icon         string `json:"icon"`
	IsRobot      int    `json:"is_robot"`
	Member       Member `json:"member"`
}

type Member struct {
	Id     int64  `json:"id"`
	Name   string `json:"name"`
	Code   string `json:"code"`
	Avatar string `json:"avatar"`
}

~~~

~~~protobuf
message TaskLog {
  int64 id = 1;
  string MemberCode = 2;
  string Content = 3;
  string remark = 4;
  string Type = 5;
  string CreateTime = 6;
  string SourceCode = 7;
  string ActionType = 8;
  string ToMemberCode = 9;
  int32 IsComment = 10;
  string ProjectCode = 11;
  string Icon = 12;
  int32 IsRobot = 13;
  Member member = 14;
}
message Member{
  int64 id = 1;
  string name = 2;
  string avatar = 3;
  string code = 4;
}
message TaskLogList{
  repeated TaskLog list = 1;
  int64  total = 2;
}
service TaskService {
  rpc TaskStages(TaskReqMessage) returns (TaskStagesResponse) {}
  rpc MemberProjectList(TaskReqMessage) returns (MemberProjectResponse){}
  rpc TaskList(TaskReqMessage) returns (TaskListResponse){}
  rpc SaveTask(TaskReqMessage) returns(TaskMessage){}
  rpc TaskSort(TaskReqMessage) returns (TaskSortResponse){}
  rpc MyTaskList(TaskReqMessage) returns (MyTaskListResponse){}
  rpc ReadTask(TaskReqMessage) returns (TaskMessage){}
  rpc ListTaskMember(TaskReqMessage) returns(TaskMemberList){}
  rpc TaskLog(TaskReqMessage) returns(TaskLogList){}
}
~~~

~~~go

func (t *TaskService) TaskLog(ctx context.Context, msg *task.TaskReqMessage) (*task.TaskLogList, error) {
	taskCode := encrypts.DecryptNoErr(msg.TaskCode)
	all := msg.All
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	var list []*data.ProjectLog
	var total int64
	var err error
	if all == 1 {
		//显示全部
		list, total, err = t.projectLogRepo.FindLogByTaskCode(c, taskCode, int(msg.Comment))
	}
	if all == 0 {
		//分页
		list, total, err = t.projectLogRepo.FindLogByTaskCodePage(c, taskCode, int(msg.Comment), int(msg.Page), int(msg.PageSize))
	}
	if err != nil {
		zap.L().Error("project task TaskLog projectLogRepo.FindLogByTaskCodePage error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	if total == 0 {
		return &task.TaskLogList{}, nil
	}
	var displayList []*data.ProjectLogDisplay
	var mIdList []int64
	for _, v := range list {
		mIdList = append(mIdList, v.MemberCode)
	}
	messageList, err := rpc.LoginServiceClient.FindMemInfoByIds(c, &login.UserMessage{MIds: mIdList})
	mMap := make(map[int64]*login.MemberMessage)
	for _, v := range messageList.List {
		mMap[v.Id] = v
	}
	for _, v := range list {
		display := v.ToDisplay()
		message := mMap[v.MemberCode]
		m := data.Member{}
		m.Name = message.Name
		m.Id = message.Id
		m.Avatar = message.Avatar
		m.Code = message.Code
		display.Member = m
		displayList = append(displayList, display)
	}
	var l []*task.TaskLog
	copier.Copy(&l, displayList)
	return &task.TaskLogList{List: l, Total: total}, nil
}

~~~

## 5. 任务工时列表

请求uri：project/task/_taskWorkTimeList

参数：

| 字段          | 类型   | 描述   |
| ------------- | ------ | ------ |
| Authorization | string | header |
| taskCode      | string | 任务id |

返回：

~~~json
{
    "code":200,
    "msg":"",
    "data":[
        {
            "id":1,
            "task_code":"th8m10gor5xwunivpj2zfkyc",
            "member_code":"6v7be19pwman2fird04gqu53",
            "create_time":"2022-12-27 22:19:54",
            "content":"22",
            "begin_time":"2022-12-27 22:19",
            "num":5,
            "code":"vfeyr2p0oh6gkbca591i8xd7",
            "member":{
                "avatar":"https:\/\/static.vilson.xyz\/cover.png",
                "name":"子龙"
            }
        }
    ]
}
~~~

### 5.1 涉及到的表

~~~sql
CREATE TABLE `vex_task_work_time`  (
  `id` bigint(0) NOT NULL AUTO_INCREMENT,
  `task_code` bigint(0) NULL DEFAULT 0 COMMENT '任务ID',
  `member_code` bigint(0) NULL DEFAULT NULL COMMENT '成员id',
  `create_time` bigint(0) NULL DEFAULT NULL,
  `content` varchar(500) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '描述',
  `begin_time` bigint(0) NULL DEFAULT NULL COMMENT '开始时间',
  `num` int(0) NULL DEFAULT 0 COMMENT '工时',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE INDEX `id`(`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '任务工时表' ROW_FORMAT = COMPACT;
~~~

### 5.2 实现

~~~go
package model

type TaskWorkTime struct {
	Id         int64  `json:"id"`
	TaskCode   string `json:"task_code"`
	MemberCode string `json:"member_code"`
	CreateTime string `json:"create_time"`
	Content    string `json:"content"`
	BeginTime  string `json:"begin_time"`
	Num        int    `json:"num"`
	Code       string `json:"code"`
	Member     Member `json:"member"`
}

~~~



~~~go

func (t *HandlerTask) taskWorkTimeList(c *gin.Context) {
	taskCode := c.PostForm("taskCode")
	result := &common.Result{}
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &task.TaskReqMessage{
		TaskCode: taskCode,
		MemberId: c.GetInt64("memberId"),
	}
	taskWorkTimeResponse, err := TaskServiceClient.TaskWorkTimeList(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	var tms []*model.TaskWorkTime
	copier.Copy(&tms, taskWorkTimeResponse.List)
	if tms == nil {
		tms = []*model.TaskWorkTime{}
	}
	c.JSON(http.StatusOK, result.Success(tms))
}
~~~

~~~protobuf
message TaskWorkTime {
  int64 id = 1;
  string memberCode = 2;
  string createTime = 3;
  string content = 4;
  string beginTime = 5;
  int32  num = 6;
  string code = 7;
  Member member = 8;
}

message TaskWorkTimeResponse {
  repeated TaskWorkTime list = 1;
  int64 total = 2;
}
service TaskService {
  rpc TaskStages(TaskReqMessage) returns (TaskStagesResponse) {}
  rpc MemberProjectList(TaskReqMessage) returns (MemberProjectResponse){}
  rpc TaskList(TaskReqMessage) returns (TaskListResponse){}
  rpc SaveTask(TaskReqMessage) returns(TaskMessage){}
  rpc TaskSort(TaskReqMessage) returns (TaskSortResponse){}
  rpc MyTaskList(TaskReqMessage) returns (MyTaskListResponse){}
  rpc ReadTask(TaskReqMessage) returns (TaskMessage){}
  rpc ListTaskMember(TaskReqMessage) returns(TaskMemberList){}
  rpc TaskLog(TaskReqMessage) returns(TaskLogList){}
  rpc TaskWorkTimeList(TaskReqMessage) returns(TaskWorkTimeResponse){}
}
~~~

~~~go
func (t *TaskService) TaskWorkTimeList(ctx context.Context, msg *task.TaskReqMessage) (*task.TaskWorkTimeResponse, error) {
	taskCode := encrypts.DecryptNoErr(msg.TaskCode)
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	var list []*data.TaskWorkTime
	var err error
	list, err = t.taskWorkTimeRepo.FindWorkTimeList(c, taskCode)
	if err != nil {
		zap.L().Error("project task TaskWorkTimeList taskWorkTimeRepo.FindWorkTimeList error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
    if len(list) == 0 {
		return &task.TaskWorkTimeResponse{}, nil
	}
	var displayList []*data.TaskWorkTimeDisplay
	var mIdList []int64
	for _, v := range list {
		mIdList = append(mIdList, v.MemberCode)
	}
	messageList, err := rpc.LoginServiceClient.FindMemInfoByIds(c, &login.UserMessage{MIds: mIdList})
	mMap := make(map[int64]*login.MemberMessage)
	for _, v := range messageList.List {
		mMap[v.Id] = v
	}
	for _, v := range list {
		display := v.ToDisplay()
		message := mMap[v.MemberCode]
		m := data.Member{}
		m.Name = message.Name
		m.Id = message.Id
		m.Avatar = message.Avatar
		m.Code = message.Code
		display.Member = m
		displayList = append(displayList, display)
	}
	var l []*task.TaskWorkTime
	copier.Copy(&l, displayList)
	return &task.TaskWorkTimeResponse{List: l, Total: total}, nil
}
~~~

~~~go
package repo

import (
	"context"
	"test.com/project-project/internal/data"
)

type TaskWorkTimeRepo interface {
	Save(ctx context.Context, twt *data.TaskWorkTime) error
	FindWorkTimeList(ctx context.Context, taskCode int64) (list []*data.TaskWorkTime, err error)
}
~~~

~~~go
package data

import (
	"github.com/jinzhu/copier"
	"test.com/project-common/encrypts"
	"test.com/project-common/tms"
)

type TaskWorkTime struct {
	Id         int64
	TaskCode   int64
	MemberCode int64
	CreateTime int64
	Content    string
	BeginTime  int64
	Num        int
}

func (*TaskWorkTime) TableName() string {
	return "ms_task_work_time"
}

type TaskWorkTimeDisplay struct {
	Id         int64
	TaskCode   string
	MemberCode string
	CreateTime string
	Content    string
	BeginTime  string
	Num        int
	Member     Member
}

func (t *TaskWorkTime) ToDisplay() *TaskWorkTimeDisplay {
	td := &TaskWorkTimeDisplay{}
	copier.Copy(td, t)
	td.MemberCode = encrypts.EncryptNoErr(t.MemberCode)
	td.TaskCode = encrypts.EncryptNoErr(t.TaskCode)
	td.CreateTime = tms.FormatByMill(t.CreateTime)
	td.BeginTime = tms.FormatByMill(t.BeginTime)
	return td
}

~~~

~~~go
package dao

import (
	"context"
	"test.com/project-project/internal/data"
	"test.com/project-project/internal/database/gorms"
)

type TaskWorkTimeDao struct {
	conn *gorms.GormConn
}

func (t *TaskWorkTimeDao) Save(ctx context.Context, twt *data.TaskWorkTime) error {
	session := t.conn.Session(ctx)
	err := session.Save(&twt).Error
	return err
}

func (t *TaskWorkTimeDao) FindWorkTimeList(ctx context.Context, taskCode int64) (list []*data.TaskWorkTime, err error) {
	session := t.conn.Session(ctx)
	err = session.Model(&data.TaskWorkTime{}).Where("task_code=?", taskCode).Find(&list).Error
	return
}

func NewTaskWorkTimeDao() *TaskWorkTimeDao {
	return &TaskWorkTimeDao{
		conn: gorms.New(),
	}
}

~~~





## 6. 添加工时

请求uri：project/task/saveTaskWorkTime

参数：

| 字段          | 类型   | 描述     |
| ------------- | ------ | -------- |
| Authorization | string | header   |
| taskCode      | string | 任务id   |
| content       | string | 备注     |
| num           | int    | 工时     |
| beginTime     | string | 开始时间 |

返回：

~~~json
{"code":200,"msg":"","data":[]}
~~~

### 6.1 实现

~~~go

func (t *HandlerTask) saveTaskWorkTime(c *gin.Context) {
	result := &common.Result{}
	var req *model.SaveTaskWorkTimeReq
	c.ShouldBind(&req)
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &task.TaskReqMessage{
		TaskCode:  req.TaskCode,
		MemberId:  c.GetInt64("memberId"),
		Content:   req.Content,
		Num:       int32(req.Num),
		BeginTime: tms.ParseTime(req.BeginTime),
	}
	_, err := TaskServiceClient.SaveTaskWorkTime(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	c.JSON(http.StatusOK, result.Success([]int{}))
}
~~~

~~~go
type SaveTaskWorkTimeReq struct {
	TaskCode  string `json:"task_code" form:"taskCode"`
	Content   string `form:"content"`
	Num       int    `form:"num"`
	BeginTime string `form:"beginTime"`
}

~~~

~~~protobuf
message TaskReqMessage {
  int64 memberId = 1;
  string projectCode = 2;
  int64 page = 3;
  int64 pageSize = 4;
  string stageCode = 5;
  string name = 6;
  string assignTo = 7;
  int32 taskType = 8;
  int32 type = 9;
  string preTaskCode = 10;
  string nextTaskCode = 11;
  string toStageCode = 12;
  string taskCode = 13;
  int32 All = 14;
  int32 Comment = 15;
  string content = 16;
  int32 num = 17;
  int64 beginTime = 18;
}
message SaveTaskWorkTimeResponse {
}
service TaskService {
  rpc TaskStages(TaskReqMessage) returns (TaskStagesResponse) {}
  rpc MemberProjectList(TaskReqMessage) returns (MemberProjectResponse){}
  rpc TaskList(TaskReqMessage) returns (TaskListResponse){}
  rpc SaveTask(TaskReqMessage) returns(TaskMessage){}
  rpc TaskSort(TaskReqMessage) returns (TaskSortResponse){}
  rpc MyTaskList(TaskReqMessage) returns (MyTaskListResponse){}
  rpc ReadTask(TaskReqMessage) returns (TaskMessage){}
  rpc ListTaskMember(TaskReqMessage) returns(TaskMemberList){}
  rpc TaskLog(TaskReqMessage) returns(TaskLogList){}
  rpc TaskWorkTimeList(TaskReqMessage) returns(TaskWorkTimeResponse){}
  rpc SaveTaskWorkTime(TaskReqMessage) returns(SaveTaskWorkTimeResponse){}
}
~~~

~~~go

func (t *TaskService) SaveTaskWorkTime(ctx context.Context, msg *task.TaskReqMessage) (*task.SaveTaskWorkTimeResponse, error) {
	tmt := &data.TaskWorkTime{}
	tmt.BeginTime = msg.BeginTime
	tmt.Num = int(msg.Num)
	tmt.Content = msg.Content
	tmt.TaskCode = encrypts.DecryptNoErr(msg.TaskCode)
	tmt.MemberCode = msg.MemberId
	c, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	err := t.taskWorkTimeRepo.Save(c, tmt)
	if err != nil {
		zap.L().Error("project task SaveTaskWorkTime taskWorkTimeRepo.Save error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	return &task.SaveTaskWorkTimeResponse{}, nil
}

~~~



## 7. 上传文件（分片上传）

请求uri：/project/file/uploadFiles

参数：



| 字段                 | 类型   | 描述          |
| -------------------- | ------ | ------------- |
| Authorization        | string | header        |
| taskCode             | string | 任务id        |
| projectName          | string | 项目名称      |
| **projectCode**      | string | 项目id        |
| **totalChunks**      | int    | Chunk总数     |
| **relativePath**     | string | 相对路径      |
| **filename**         | string | 文件名        |
| **chunkNumber**      | int    | chunk数量     |
| **chunkSize**        | int    | chunk大小     |
| **currentChunkSize** | int    | 当前chunk大小 |
| **totalSize**        | int    | 总大小        |
| **identifier**       | string | 标识符        |

返回：

~~~json
{
    "code":200,
    "msg":"",
    "data":{
        "file":"E:\\develop\\phpstudy_pro\\WWW\\static\/upload\/file\/default\/6v7be19pwman2fird04gqu53\/6v7be19pwman2fird04gqu53\/20221227\/20221227222331-封面.jpg",
        "hash":"02c1f20d40222c95f4c07ac788325e44",
        "key":"static\/upload\/file\/default\/6v7be19pwman2fird04gqu53\/6v7be19pwman2fird04gqu53\/20221227\/20221227222331-封面.jpg",
        "url":"http:\/\/127.0.0.1\/static\/upload\/file\/default\/6v7be19pwman2fird04gqu53\/6v7be19pwman2fird04gqu53\/20221227\/20221227222331-封面.jpg",
        "projectName":"测试项目"
    }
}
~~~

### 7.1 涉及到的表

~~~sql
CREATE TABLE `vex_file`  (
  `id` int(0) UNSIGNED NOT NULL AUTO_INCREMENT,
  `path_name` varchar(200) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '相对路径',
  `title` char(90) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '名称',
  `extension` char(30) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '扩展名',
  `size` int(0) UNSIGNED NULL DEFAULT 0 COMMENT '文件大小',
  `object_type` char(30) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '对象类型',
  `organization_code` bigint(0) NULL DEFAULT NULL COMMENT '组织编码',
  `task_code` bigint(0) NULL DEFAULT NULL COMMENT '任务编码',
  `project_code` bigint(0) NULL DEFAULT NULL COMMENT '项目编码',
  `create_by` bigint(0) NULL DEFAULT NULL COMMENT '上传人',
  `create_time` bigint(0) NULL DEFAULT NULL COMMENT '创建时间',
  `downloads` mediumint(0) UNSIGNED NULL DEFAULT 0 COMMENT '下载次数',
  `extra` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '额外信息',
  `deleted` tinyint(1) NULL DEFAULT 0 COMMENT '删除标记',
  `file_url` text CHARACTER SET utf8 COLLATE utf8_general_ci NULL COMMENT '完整地址',
  `file_type` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '文件类型',
  `deleted_time` bigint(0) NULL DEFAULT NULL COMMENT '删除时间',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 44 CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = '文件表' ROW_FORMAT = COMPACT;
~~~

~~~sql
CREATE TABLE `vex_source_link`  (
  `id` int(0) NOT NULL AUTO_INCREMENT,
  `source_type` char(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '资源类型',
  `source_code` bigint(0) NULL DEFAULT NULL COMMENT '资源编号',
  `link_type` char(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '关联类型',
  `link_code` bigint(0) NULL DEFAULT NULL COMMENT '关联编号',
  `organization_code` bigint(0) NULL DEFAULT NULL COMMENT '组织编码',
  `create_by` bigint(0) NULL DEFAULT NULL COMMENT '创建人',
  `create_time` varchar(30) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '创建时间',
  `sort` int(0) NULL DEFAULT 0 COMMENT '排序',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 6 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci COMMENT = '资源关联表' ROW_FORMAT = COMPACT;
~~~

### 7.2 实现

~~~go
package model

type UploadFileReq struct {
	TaskCode         string `form:"taskCode"`
	ProjectCode      string `form:"projectCode"`
	ProjectName      string `form:"projectName"`
	TotalChunks      int    `form:"totalChunks"`
	RelativePath     string `form:"relativePath"`
	Filename         string `form:"filename"`
	ChunkNumber      int    `form:"chunkNumber"`
	ChunkSize        int    `form:"chunkSize"`
	CurrentChunkSize int    `form:"currentChunkSize"`
	TotalSize        int    `form:"totalSize"`
	Identifier       string `form:"identifier"`
}

~~~

~~~go

func (t *HandlerTask) uploadFiles(c *gin.Context) {
	result := &common.Result{}
	req := model.UploadFileReq{}
	c.ShouldBind(&req)
	multipartForm, err := c.MultipartForm()
	if err != nil {
		zap.L().Error("c.MultipartForm() err", zap.Error(err))
		return
	}
	file := multipartForm.File
	key := ""
	if req.TotalChunks == 1 {
		//代表不分片，直接上传
		path := "upload/" + req.ProjectCode + "/" + req.TaskCode + "/" + tms.FormatYMD(time.Now())
		if !fs.IsExist(path) {
			os.MkdirAll(path, os.ModePerm)
		}
		dst := path + "/" + req.Filename
		key = dst
		header := file["file"][0]
		err := c.SaveUploadedFile(header, dst)
		if err != nil {
			c.JSON(http.StatusOK, result.Fail(-999, err.Error()))
			return
		}
	}
	if req.TotalChunks > 1 {
		//分片上传 合起来即可
		path := "upload/" + req.ProjectCode + "/" + req.TaskCode + "/" + tms.FormatYMD(time.Now())
		if !fs.IsExist(path) {
			os.MkdirAll(path, os.ModePerm)
		}
		fileName := path + "/" + req.Identifier
		openFile, err := os.OpenFile(fileName, os.O_CREATE|os.O_APPEND|os.O_RDWR, os.ModePerm)
		if err != nil {
			c.JSON(http.StatusOK, result.Fail(-999, err.Error()))
			return
		}
		open, err := file["file"][0].Open()
		defer open.Close()
		buf := make([]byte, req.CurrentChunkSize)
		open.Read(buf)
		openFile.Write(buf)
		openFile.Close()
		newpath := path + "/" + req.Filename
		key = newpath
		if req.TotalChunks == req.ChunkNumber {
			//最后一块 重命名文件名
			err := os.Rename(fileName, newpath)
			fmt.Println(err)
		}
	}
	//调用服务 存入file表
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	fileUrl := "http://localhost/" + key
	msg := &task.TaskFileReqMessage{
		TaskCode:         req.TaskCode,
		ProjectCode:      req.ProjectCode,
		OrganizationCode: c.GetString("organizationCode"),
		PathName:         key,
		FileName:         req.Filename,
		Size:             int64(req.TotalSize),
		Extension:        path.Ext(key),
		FileUrl:          fileUrl,
		FileType:         file["file"][0].Header.Get("Content-Type"),
		MemberId:         c.GetInt64("memberId"),
	}
	if req.TotalChunks == req.ChunkNumber {
		_, err = TaskServiceClient.SaveTaskFile(ctx, msg)
		if err != nil {
			code, msg := errs.ParseGrpcError(err)
			c.JSON(http.StatusOK, result.Fail(code, msg))
		}
	}
	c.JSON(http.StatusOK, result.Success(gin.H{
		"file":        key,
		"hash":        "",
		"key":         key,
		"url":         "http://localhost/" + key,
		"projectName": req.ProjectName,
	}))
	return
}
~~~



~~~protobuf

message TaskFileReqMessage{
  string pathName = 1;
  string fileName = 2;
  string extension = 3;
  int64 size = 4;
  string projectCode = 5;
  string taskCode = 6;
  string organizationCode = 7;
  string fileUrl = 8;
  string fileType = 9;
  int64 memberId = 10;
}
message TaskFileResponse{}

message TaskSourceMessage{
  int64  id = 1;
  string code = 2;
  string sourceType = 3;
  string sourceCode = 4;
  string linkType = 5;
  string linkCode = 6;
  string OrganizationCode = 7;
  string createBy = 8;
  string createTime = 9;
  int32 sort = 10;
  string title = 11;
  SourceDetail sourceDetail = 12;
}
message SourceDetail {
  int64  id = 1;
  string  code = 2;
  string pathName = 3;
  string title = 4;
  string Extension = 5;
  int32 size = 6;
  string ObjectType = 7;
  string OrganizationCode = 8;
  string  TaskCode = 9;
  string projectCode = 10;
  string createBy = 11;
  string createTime = 12;
  int32 downloads = 13;
  string Extra = 14;
  int32 Deleted = 15;
  string FileUrl = 16;
  string FileType = 17;
  string deletedTime = 18;
  string ProjectName = 19;
  string FullName = 20;
}
message TaskSourceResponse{
  repeated TaskSourceMessage list = 1;
}
service TaskService {
  rpc TaskStages(TaskReqMessage) returns (TaskStagesResponse) {}
  rpc MemberProjectList(TaskReqMessage) returns (MemberProjectResponse){}
  rpc TaskList(TaskReqMessage) returns (TaskListResponse){}
  rpc SaveTask(TaskReqMessage) returns(TaskMessage){}
  rpc TaskSort(TaskReqMessage) returns (TaskSortResponse){}
  rpc MyTaskList(TaskReqMessage) returns (MyTaskListResponse){}
  rpc ReadTask(TaskReqMessage) returns (TaskMessage){}
  rpc ListTaskMember(TaskReqMessage) returns(TaskMemberList){}
  rpc TaskLog(TaskReqMessage) returns(TaskLogList){}
  rpc TaskWorkTimeList(TaskReqMessage) returns(TaskWorkTimeResponse){}
  rpc SaveTaskWorkTime(TaskReqMessage) returns(SaveTaskWorkTimeResponse){}
  rpc SaveTaskFile(TaskFileReqMessage) returns(TaskFileResponse){}
  rpc TaskSources(TaskReqMessage) returns(TaskSourceResponse){}
}
~~~

~~~go

func (t *TaskService) SaveTaskFile(ctx context.Context, msg *task.TaskFileReqMessage) (*task.TaskFileResponse, error) {
	taskCode := encrypts.DecryptNoErr(msg.TaskCode)
	//存file表
	f := &data.File{
		PathName:         msg.PathName,
		Title:            msg.FileName,
		Extension:        msg.Extension,
		Size:             int(msg.Size),
		ObjectType:       "",
		OrganizationCode: encrypts.DecryptNoErr(msg.OrganizationCode),
		TaskCode:         encrypts.DecryptNoErr(msg.TaskCode),
		ProjectCode:      encrypts.DecryptNoErr(msg.ProjectCode),
		CreateBy:         msg.MemberId,
		CreateTime:       time.Now().UnixMilli(),
		Downloads:        0,
		Extra:            "",
		Deleted:          model.NoDeleted,
		FileType:         msg.FileType,
		FileUrl:          msg.FileUrl,
		DeletedTime:      0,
	}
	err := t.fileRepo.Save(context.Background(), f)
	if err != nil {
		zap.L().Error("project task SaveTaskFile fileRepo.Save error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	//存入source_link
	sl := &data.SourceLink{
		SourceType:       "file",
		SourceCode:       f.Id,
		LinkType:         "task",
		LinkCode:         taskCode,
		OrganizationCode: encrypts.DecryptNoErr(msg.OrganizationCode),
		CreateBy:         msg.MemberId,
		CreateTime:       time.Now().UnixMilli(),
		Sort:             0,
	}
	err = t.sourceLinkRepo.Save(context.Background(), sl)
	if err != nil {
		zap.L().Error("project task SaveTaskFile sourceLinkRepo.Save error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	return &task.TaskFileResponse{}, nil
}

~~~

~~~go

type File struct {
	Id               int64
	PathName         string
	Title            string
	Extension        string
	Size             int
	ObjectType       string
	OrganizationCode int64
	TaskCode         int64
	ProjectCode      int64
	CreateBy         int64
	CreateTime       int64
	Downloads        int
	Extra            string
	Deleted          int
	FileUrl          string
	FileType         string
	DeletedTime      int64
}

func (*File) TableName() string {
	return "ms_file"
}

~~~

~~~go
package data

import (
	"github.com/jinzhu/copier"
	"test.com/project-common/encrypts"
	"test.com/project-common/tms"
)

type SourceLink struct {
	Id               int64
	SourceType       string
	SourceCode       int64
	LinkType         string
	LinkCode         int64
	OrganizationCode int64
	CreateBy         int64
	CreateTime       int64
	Sort             int
}

func (*SourceLink) TableName() string {
	return "ms_source_link"
}

type SourceLinkDisplay struct {
	Id               int64        `json:"id"`
	Code             string       `json:"code"`
	SourceType       string       `json:"source_type"`
	SourceCode       string       `json:"source_code"`
	LinkType         string       `json:"link_type"`
	LinkCode         string       `json:"link_code"`
	OrganizationCode string       `json:"organization_code"`
	CreateBy         string       `json:"create_by"`
	CreateTime       string       `json:"create_time"`
	Sort             int          `json:"sort"`
	Title            string       `json:"title"`
	SourceDetail     SourceDetail `json:"sourceDetail"`
}

type SourceDetail struct {
	Id               int64  `json:"id"`
	Code             string `json:"code"`
	PathName         string `json:"path_name"`
	Title            string `json:"title"`
	Extension        string `json:"extension"`
	Size             int    `json:"size"`
	ObjectType       string `json:"object_type"`
	OrganizationCode string `json:"organization_code"`
	TaskCode         string `json:"task_code"`
	ProjectCode      string `json:"project_code"`
	CreateBy         string `json:"create_by"`
	CreateTime       string `json:"create_time"`
	Downloads        int    `json:"downloads"`
	Extra            string `json:"extra"`
	Deleted          int    `json:"deleted"`
	FileUrl          string `json:"file_url"`
	FileType         string `json:"file_type"`
	DeletedTime      string `json:"deleted_time"`
	ProjectName      string `json:"projectName"`
	FullName         string `json:"fullName"`
}

func (s *SourceLink) ToDisplay(f *File) *SourceLinkDisplay {
	sl := &SourceLinkDisplay{}
	copier.Copy(sl, s)
	sl.SourceDetail = SourceDetail{}
	copier.Copy(&sl.SourceDetail, f)
	sl.LinkCode = encrypts.EncryptNoErr(s.LinkCode)
	sl.OrganizationCode = encrypts.EncryptNoErr(s.OrganizationCode)
	sl.CreateTime = tms.FormatByMill(s.CreateTime)
	sl.CreateBy = encrypts.EncryptNoErr(s.CreateBy)
	sl.SourceCode = encrypts.EncryptNoErr(s.SourceCode)
	sl.SourceDetail.OrganizationCode = encrypts.EncryptNoErr(f.OrganizationCode)
	sl.SourceDetail.CreateBy = encrypts.EncryptNoErr(f.CreateBy)
	sl.SourceDetail.CreateTime = tms.FormatByMill(f.CreateTime)
	sl.SourceDetail.DeletedTime = tms.FormatByMill(f.DeletedTime)
	sl.SourceDetail.TaskCode = encrypts.EncryptNoErr(f.TaskCode)
	sl.SourceDetail.ProjectCode = encrypts.EncryptNoErr(f.ProjectCode)
	sl.SourceDetail.FullName = f.Title
	sl.Title = f.Title
	return sl
}

~~~

~~~go
package repo

import (
	"context"
	"test.com/project-project/internal/data"
)

type FileRepo interface {
	Save(ctx context.Context, file *data.File) error
	FindByIds(background context.Context, ids []int64) (list []*data.File, err error)
}

~~~

~~~go
package repo

import (
	"context"
	"test.com/project-project/internal/data"
)

type SourceLinkRepo interface {
	Save(ctx context.Context, link *data.SourceLink) error
	FindByTaskCode(ctx context.Context, taskCode int64) (list []*data.SourceLink, err error)
}

~~~

~~~go
package dao

import (
	"context"
	"test.com/project-project/internal/data"
	"test.com/project-project/internal/database/gorms"
)

type FileDao struct {
	conn *gorms.GormConn
}

func (f *FileDao) FindByIds(ctx context.Context, ids []int64) (list []*data.File, err error) {
	session := f.conn.Session(ctx)
	err = session.Model(&data.File{}).Where("id in (?)", ids).Find(&list).Error
	return
}

func (f *FileDao) Save(ctx context.Context, file *data.File) error {
	err := f.conn.Session(ctx).Save(&file).Error
	return err
}

func NewFileDao() *FileDao {
	return &FileDao{
		conn: gorms.New(),
	}
}

~~~

~~~go
package dao

import (
	"context"
	"test.com/project-project/internal/data"
	"test.com/project-project/internal/database/gorms"
)

type SourceLinkDao struct {
	conn *gorms.GormConn
}

func (s *SourceLinkDao) Save(ctx context.Context, link *data.SourceLink) error {
	return s.conn.Session(ctx).Save(&link).Error
}

func (s *SourceLinkDao) FindByTaskCode(ctx context.Context, taskCode int64) (list []*data.SourceLink, err error) {
	session := s.conn.Session(ctx)
	err = session.Model(&data.SourceLink{}).Where("link_code=?", taskCode).Find(&list).Error
	return
}

func NewSourceLinkDao() *SourceLinkDao {
	return &SourceLinkDao{
		conn: gorms.New(),
	}
}

~~~



## 8. 关联文件

请求uri：project/task/taskSources

参数：

| 字段          | 类型   | 描述   |
| ------------- | ------ | ------ |
| Authorization | string | header |
| taskCode      | string | 任务id |

返回：

~~~json
{
    "code":200,
    "msg":"",
    "data":[
        {
            "id":9,
            "code":"urvjpm9s8iaxb6w70yth4f51",
            "source_type":"file",
            "source_code":"1zijprh4c2b7dfal60gesovw",
            "link_type":"task",
            "link_code":"th8m10gor5xwunivpj2zfkyc",
            "organization_code":"6v7be19pwman2fird04gqu53",
            "create_by":"6v7be19pwman2fird04gqu53",
            "create_time":"2022-12-27 22:31:20",
            "sort":0,
            "title":"02",
            "sourceDetail":{
                "code":"1zijprh4c2b7dfal60gesovw",
                "path_name":"static\/upload\/file\/default\/6v7be19pwman2fird04gqu53\/6v7be19pwman2fird04gqu53\/20221227\/20221227223119-02.zip",
                "title":"02",
                "extension":"zip",
                "size":22532972,
                "object_type":"",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "task_code":null,
                "project_code":"g5bt7cphnxq2kfu8jd1or0v4",
                "create_by":"6v7be19pwman2fird04gqu53",
                "create_time":"2022-12-27 22:31:20",
                "downloads":0,
                "extra":"",
                "deleted":0,
                "file_url":"http:\/\/127.0.0.1\/static\/upload\/file\/default\/6v7be19pwman2fird04gqu53\/6v7be19pwman2fird04gqu53\/20221227\/20221227223119-02.zip",
                "file_type":"application\/x-zip-compressed",
                "deleted_time":"",
                "projectName":"测试项目",
                "fullName":"02.zip"
            }
        },
        {
            "id":8,
            "code":"hfyusvktie86q02rb5gco47x",
            "source_type":"file",
            "source_code":"0cytv4l5hw7dpbxing26aqs8",
            "link_type":"task",
            "link_code":"th8m10gor5xwunivpj2zfkyc",
            "organization_code":"6v7be19pwman2fird04gqu53",
            "create_by":"6v7be19pwman2fird04gqu53",
            "create_time":"2022-12-27 22:30:10",
            "sort":0,
            "title":"项目宣传",
            "sourceDetail":{
                "code":"0cytv4l5hw7dpbxing26aqs8",
                "path_name":"static\/upload\/file\/default\/6v7be19pwman2fird04gqu53\/6v7be19pwman2fird04gqu53\/20221227\/20221227223009-项目宣传.zip",
                "title":"项目宣传",
                "extension":"zip",
                "size":1027353,
                "object_type":"",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "task_code":null,
                "project_code":"g5bt7cphnxq2kfu8jd1or0v4",
                "create_by":"6v7be19pwman2fird04gqu53",
                "create_time":"2022-12-27 22:30:09",
                "downloads":0,
                "extra":"",
                "deleted":0,
                "file_url":"http:\/\/127.0.0.1\/static\/upload\/file\/default\/6v7be19pwman2fird04gqu53\/6v7be19pwman2fird04gqu53\/20221227\/20221227223009-项目宣传.zip",
                "file_type":"application\/x-zip-compressed",
                "deleted_time":"",
                "projectName":"测试项目",
                "fullName":"项目宣传.zip"
            }
        },
        {
            "id":7,
            "code":"m01hfrij2tvnl48kboczusq3",
            "source_type":"file",
            "source_code":"2s5yu0c6bwo39ifjkr7aehlt",
            "link_type":"task",
            "link_code":"th8m10gor5xwunivpj2zfkyc",
            "organization_code":"6v7be19pwman2fird04gqu53",
            "create_by":"6v7be19pwman2fird04gqu53",
            "create_time":"2022-12-27 22:23:31",
            "sort":0,
            "title":"封面",
            "sourceDetail":{
                "code":"2s5yu0c6bwo39ifjkr7aehlt",
                "path_name":"static\/upload\/file\/default\/6v7be19pwman2fird04gqu53\/6v7be19pwman2fird04gqu53\/20221227\/20221227222331-封面.jpg",
                "title":"封面",
                "extension":"jpg",
                "size":221963,
                "object_type":"",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "task_code":null,
                "project_code":"g5bt7cphnxq2kfu8jd1or0v4",
                "create_by":"6v7be19pwman2fird04gqu53",
                "create_time":"2022-12-27 22:23:31",
                "downloads":0,
                "extra":"",
                "deleted":0,
                "file_url":"http:\/\/127.0.0.1\/static\/upload\/file\/default\/6v7be19pwman2fird04gqu53\/6v7be19pwman2fird04gqu53\/20221227\/20221227222331-封面.jpg",
                "file_type":"image\/jpeg",
                "deleted_time":"",
                "projectName":"测试项目",
                "fullName":"封面.jpg"
            }
        },
        {
            "id":6,
            "code":"rujc0eykqw3i7t6ndapfohxv",
            "source_type":"file",
            "source_code":"orwv2zdtpm14un06hiq3jafl",
            "link_type":"task",
            "link_code":"th8m10gor5xwunivpj2zfkyc",
            "organization_code":"6v7be19pwman2fird04gqu53",
            "create_by":"6v7be19pwman2fird04gqu53",
            "create_time":"2022-12-27 22:08:23",
            "sort":0,
            "title":"封面",
            "sourceDetail":{
                "code":"orwv2zdtpm14un06hiq3jafl",
                "path_name":"static\/upload\/file\/default\/6v7be19pwman2fird04gqu53\/6v7be19pwman2fird04gqu53\/20221227\/20221227220823-封面.jpg",
                "title":"封面",
                "extension":"jpg",
                "size":221963,
                "object_type":"",
                "organization_code":"6v7be19pwman2fird04gqu53",
                "task_code":null,
                "project_code":"g5bt7cphnxq2kfu8jd1or0v4",
                "create_by":"6v7be19pwman2fird04gqu53",
                "create_time":"2022-12-27 22:08:23",
                "downloads":0,
                "extra":"",
                "deleted":0,
                "file_url":"http:\/\/127.0.0.1\/static\/upload\/file\/default\/6v7be19pwman2fird04gqu53\/6v7be19pwman2fird04gqu53\/20221227\/20221227220823-封面.jpg",
                "file_type":"image\/jpeg",
                "deleted_time":"",
                "projectName":"测试项目",
                "fullName":"封面.jpg"
            }
        }
    ]
}
~~~

### 8.1 实现

~~~go

func (t *HandlerTask) taskSources(c *gin.Context) {
	result := &common.Result{}
	taskCode := c.PostForm("taskCode")
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	sources, err := TaskServiceClient.TaskSources(ctx, &task.TaskReqMessage{TaskCode: taskCode})
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	var slList []*model.SourceLink
	copier.Copy(&slList, sources.List)
	if slList == nil {
		slList = []*model.SourceLink{}
	}
	c.JSON(http.StatusOK, result.Success(slList))
}

~~~

~~~go
package model

type SourceLink struct {
	Id               int64        `json:"id"`
	Code             string       `json:"code"`
	SourceType       string       `json:"source_type"`
	SourceCode       string       `json:"source_code"`
	LinkType         string       `json:"link_type"`
	LinkCode         string       `json:"link_code"`
	OrganizationCode string       `json:"organization_code"`
	CreateBy         string       `json:"create_by"`
	CreateTime       string       `json:"create_time"`
	Sort             int          `json:"sort"`
	Title            string       `json:"title"`
	SourceDetail     SourceDetail `json:"sourceDetail"`
}

type SourceDetail struct {
	Id               int64  `json:"id"`
	Code             string `json:"code"`
	PathName         string `json:"path_name"`
	Title            string `json:"title"`
	Extension        string `json:"extension"`
	Size             int    `json:"size"`
	ObjectType       string `json:"object_type"`
	OrganizationCode string `json:"organization_code"`
	TaskCode         string `json:"task_code"`
	ProjectCode      string `json:"project_code"`
	CreateBy         string `json:"create_by"`
	CreateTime       string `json:"create_time"`
	Downloads        int    `json:"downloads"`
	Extra            string `json:"extra"`
	Deleted          int    `json:"deleted"`
	FileUrl          string `json:"file_url"`
	FileType         string `json:"file_type"`
	DeletedTime      string `json:"deleted_time"`
	ProjectName      string `json:"projectName"`
	FullName         string `json:"fullName"`
}

~~~

~~~protobuf

message TaskSourceMessage{
  int64  id = 1;
  string code = 2;
  string sourceType = 3;
  string sourceCode = 4;
  string linkType = 5;
  string linkCode = 6;
  string OrganizationCode = 7;
  string createBy = 8;
  string createTime = 9;
  int32 sort = 10;
  string title = 11;
  SourceDetail sourceDetail = 12;
}
message SourceDetail {
  int64  id = 1;
  string  code = 2;
  string pathName = 3;
  string title = 4;
  string Extension = 5;
  int32 size = 6;
  string ObjectType = 7;
  string OrganizationCode = 8;
  string  TaskCode = 9;
  string projectCode = 10;
  string createBy = 11;
  string createTime = 12;
  int32 downloads = 13;
  string Extra = 14;
  int32 Deleted = 15;
  string FileUrl = 16;
  string FileType = 17;
  string deletedTime = 18;
  string ProjectName = 19;
  string FullName = 20;
}
message TaskSourceResponse{
  repeated TaskSourceMessage list = 1;
}
service TaskService {
  rpc TaskStages(TaskReqMessage) returns (TaskStagesResponse) {}
  rpc MemberProjectList(TaskReqMessage) returns (MemberProjectResponse){}
  rpc TaskList(TaskReqMessage) returns (TaskListResponse){}
  rpc SaveTask(TaskReqMessage) returns(TaskMessage){}
  rpc TaskSort(TaskReqMessage) returns (TaskSortResponse){}
  rpc MyTaskList(TaskReqMessage) returns (MyTaskListResponse){}
  rpc ReadTask(TaskReqMessage) returns (TaskMessage){}
  rpc ListTaskMember(TaskReqMessage) returns(TaskMemberList){}
  rpc TaskLog(TaskReqMessage) returns(TaskLogList){}
  rpc TaskWorkTimeList(TaskReqMessage) returns(TaskWorkTimeResponse){}
  rpc SaveTaskWorkTime(TaskReqMessage) returns(SaveTaskWorkTimeResponse){}
  rpc SaveTaskFile(TaskFileReqMessage) returns(TaskFileResponse){}
  rpc TaskSources(TaskReqMessage) returns(TaskSourceResponse){}
}
~~~

~~~go

func (t *TaskService) TaskSources(ctx context.Context, msg *task.TaskReqMessage) (*task.TaskSourceResponse, error) {
	taskCode := encrypts.DecryptNoErr(msg.TaskCode)
	sourceLinks, err := t.sourceLinkRepo.FindByTaskCode(context.Background(), taskCode)
	if err != nil {
		zap.L().Error("project task SaveTaskFile sourceLinkRepo.FindByTaskCode error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	if len(sourceLinks) == 0 {
		return &task.TaskSourceResponse{}, nil
	}
	var fIdList []int64
	for _, v := range sourceLinks {
		fIdList = append(fIdList, v.SourceCode)
	}
	files, err := t.fileRepo.FindByIds(context.Background(), fIdList)
	if err != nil {
		zap.L().Error("project task SaveTaskFile fileRepo.FindByIds error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	fMap := make(map[int64]*data.File)
	for _, v := range files {
		fMap[v.Id] = v
	}
	var list []*data.SourceLinkDisplay
	for _, v := range sourceLinks {
		list = append(list, v.ToDisplay(fMap[v.SourceCode]))
	}
	var slMsg []*task.TaskSourceMessage
	copier.Copy(&slMsg, list)
	return &task.TaskSourceResponse{List: slMsg}, nil
}

~~~



## 9. 评论

请求uri：project/task/createComment

参数：



| 字段          | 类型   | 描述       |
| ------------- | ------ | ---------- |
| Authorization | string | header     |
| taskCode      | string | 任务id     |
| comment       | string | 评论内容   |
| mentions      | array  | 提及的成员 |

返回：

~~~json
{"code":200,"msg":"","data":true}
~~~

### 9.1 实现

~~~go

func (t *HandlerTask) createComment(c *gin.Context) {
	result := &common.Result{}
	req := model.CommentReq{}
	c.ShouldBind(&req)
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &task.TaskReqMessage{
		TaskCode:       req.TaskCode,
		CommentContent: req.Comment,
		Mentions:       req.Mentions,
		MemberId:       c.GetInt64("memberId"),
	}
	_, err := TaskServiceClient.CreateComment(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	c.JSON(http.StatusOK, result.Success(true))
}
~~~

~~~go
package model

type CommentReq struct {
	TaskCode string   `form:"taskCode"`
	Comment  string   `form:"comment"`
	Mentions []string `form:"mentions"`
}

~~~



~~~protobuf
message TaskReqMessage {
  int64 memberId = 1;
  string projectCode = 2;
  int64 page = 3;
  int64 pageSize = 4;
  string stageCode = 5;
  string name = 6;
  string assignTo = 7;
  int32 taskType = 8;
  int32 type = 9;
  string preTaskCode = 10;
  string nextTaskCode = 11;
  string toStageCode = 12;
  string taskCode = 13;
  int32 all = 14;
  int32 comment = 15;
  string content = 16;
  int32 num = 17;
  int64 beginTime = 18;
  string commentContent = 19;
  repeated string Mentions = 20;
}
message CreateCommentResponse{

}
service TaskService {
  rpc TaskStages(TaskReqMessage) returns (TaskStagesResponse) {}
  rpc MemberProjectList(TaskReqMessage) returns (MemberProjectResponse){}
  rpc TaskList(TaskReqMessage) returns (TaskListResponse){}
  rpc SaveTask(TaskReqMessage) returns(TaskMessage){}
  rpc TaskSort(TaskReqMessage) returns (TaskSortResponse){}
  rpc MyTaskList(TaskReqMessage) returns (MyTaskListResponse){}
  rpc ReadTask(TaskReqMessage) returns (TaskMessage){}
  rpc ListTaskMember(TaskReqMessage) returns(TaskMemberList){}
  rpc TaskLog(TaskReqMessage) returns(TaskLogList){}
  rpc TaskWorkTimeList(TaskReqMessage) returns(TaskWorkTimeResponse){}
  rpc SaveTaskWorkTime(TaskReqMessage) returns(SaveTaskWorkTimeResponse){}
  rpc SaveTaskFile(TaskFileReqMessage) returns(TaskFileResponse){}
  rpc TaskSources(TaskReqMessage) returns(TaskSourceResponse){}
  rpc CreateComment(TaskReqMessage) returns(CreateCommentResponse){}
}
~~~



~~~go


func (t *TaskService) CreateComment(ctx context.Context, msg *task.TaskReqMessage) (*task.CreateCommentResponse, error) {
	taskCode := encrypts.DecryptNoErr(msg.TaskCode)
	taskById, err := t.taskRepo.FindTaskById(context.Background(), taskCode)
	if err != nil {
		zap.L().Error("project task CreateComment fileRepo.FindTaskById error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	pl := &data.ProjectLog{
		MemberCode:   msg.MemberId,
		Content:      msg.CommentContent,
		Remark:       msg.CommentContent,
		Type:         "createComment",
		CreateTime:   time.Now().UnixMilli(),
		SourceCode:   taskCode,
		ActionType:   "task",
		ToMemberCode: 0,
		IsComment:    model.Comment,
		ProjectCode:  taskById.ProjectCode,
		Icon:         "plus",
		IsRobot:      0,
	}
	t.projectLogRepo.SaveProjectLog(pl)
	return &task.CreateCommentResponse{}, nil
}

~~~



## 10.项目日志

请求uri：project/project/getLogBySelfProject

参数：



| 字段                    | 类型   | 描述            |
| ----------------------- | ------ | --------------- |
| Authorization（Header） | string | bearer ${token} |
| page                    | int    |                 |
| pageSize                | int    | 默认显示20条    |

响应：

~~~json
{
    "code":200,
    "msg":"",
    "data":[
        {
            "remark":"认领了任务 ",
            "content":"",
            "is_comment":0,
            "create_time":"2022-12-17 20:15:54",
            "project_name":"财务管理系统",
            "task_name":"分发",
            "source_code":"q6jpxum4io81nhg9fbckw07z",
            "project_code":"7mdlxqzeay96i1rbk4uovnfh",
            "member_avatar":"https:\/\/static.vilson.xyz\/cover.png",
            "member_name":"子龙"
        },
        {
            "remark":"创建了任务 ",
            "content":"分发",
            "is_comment":0,
            "create_time":"2022-12-17 20:15:54",
            "project_name":"财务管理系统",
            "task_name":"分发",
            "source_code":"q6jpxum4io81nhg9fbckw07z",
            "project_code":"7mdlxqzeay96i1rbk4uovnfh",
            "member_avatar":"https:\/\/static.vilson.xyz\/cover.png",
            "member_name":"子龙"
        },
        {
            "remark":"认领了任务 ",
            "content":"",
            "is_comment":0,
            "create_time":"2022-07-26 21:25:52",
            "project_name":"财务管理系统",
            "task_name":"123123",
            "source_code":"lp78wgimxjtu34vr0dn5csb2",
            "project_code":"7mdlxqzeay96i1rbk4uovnfh",
            "member_avatar":"https:\/\/static.vilson.xyz\/cover.png",
            "member_name":"子龙"
        },
        {
            "remark":"创建了任务 ",
            "content":"123123",
            "is_comment":0,
            "create_time":"2022-07-26 21:25:52",
            "project_name":"财务管理系统",
            "task_name":"123123",
            "source_code":"lp78wgimxjtu34vr0dn5csb2",
            "project_code":"7mdlxqzeay96i1rbk4uovnfh",
            "member_avatar":"https:\/\/static.vilson.xyz\/cover.png",
            "member_name":"子龙"
        },
        {
            "remark":"认领了任务 ",
            "content":"",
            "is_comment":0,
            "create_time":"2022-07-26 21:25:46",
            "project_name":"财务管理系统",
            "task_name":"123123",
            "source_code":"tmkyx21o4976w5pbached0iz",
            "project_code":"7mdlxqzeay96i1rbk4uovnfh",
            "member_avatar":"https:\/\/static.vilson.xyz\/cover.png",
            "member_name":"子龙"
        },
        {
            "remark":"创建了任务 ",
            "content":"123123",
            "is_comment":0,
            "create_time":"2022-07-26 21:25:46",
            "project_name":"财务管理系统",
            "task_name":"123123",
            "source_code":"tmkyx21o4976w5pbached0iz",
            "project_code":"7mdlxqzeay96i1rbk4uovnfh",
            "member_avatar":"https:\/\/static.vilson.xyz\/cover.png",
            "member_name":"子龙"
        },
        {
            "remark":"认领了任务 ",
            "content":"",
            "is_comment":0,
            "create_time":"2022-07-26 21:25:44",
            "project_name":"财务管理系统",
            "task_name":"213",
            "source_code":"t7nr8ifcq3hxubp1j9o5egaz",
            "project_code":"7mdlxqzeay96i1rbk4uovnfh",
            "member_avatar":"https:\/\/static.vilson.xyz\/cover.png",
            "member_name":"子龙"
        },
        {
            "remark":"创建了任务 ",
            "content":"213",
            "is_comment":0,
            "create_time":"2022-07-26 21:25:44",
            "project_name":"财务管理系统",
            "task_name":"213",
            "source_code":"t7nr8ifcq3hxubp1j9o5egaz",
            "project_code":"7mdlxqzeay96i1rbk4uovnfh",
            "member_avatar":"https:\/\/static.vilson.xyz\/cover.png",
            "member_name":"子龙"
        }
    ]
}
~~~

### 10.1 实现

~~~go
group.POST("/project/getLogBySelfProject", h.getLogBySelfProject)
~~~

~~~go

func (p *HandlerProject) getLogBySelfProject(c *gin.Context) {
	result := &common.Result{}
	var page = &model.Page{}
	page.Bind(c)
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
	defer cancel()
	msg := &project.ProjectRpcMessage{
		MemberId: c.GetInt64("memberId"),
		Page:     page.Page,
		PageSize: page.PageSize,
	}
	projectLogResponse, err := ProjectServiceClient.GetLogBySelfProject(ctx, msg)
	if err != nil {
		code, msg := errs.ParseGrpcError(err)
		c.JSON(http.StatusOK, result.Fail(code, msg))
	}
	var list []*model.ProjectLog
	copier.Copy(&list, projectLogResponse.List)
	if list == nil {
		list = []*model.ProjectLog{}
	}
	c.JSON(http.StatusOK, result.Success(list))
}

~~~

~~~go
package model

type ProjectLog struct {
	Content      string `json:"content"`
	Remark       string `json:"remark"`
	CreateTime   string `json:"create_time"`
	SourceCode   string `json:"source_code"`
	IsComment    int    `json:"is_comment"`
	ProjectCode  string `json:"project_code"`
	ProjectName  string `json:"project_name"`
	MemberAvatar string `json:"member_avatar"`
	MemberName   string `json:"member_name"`
	TaskName     string `json:"task_name"`
}

~~~

~~~protobuf
message ProjectLogMessage{
    string Content  = 1;
    string Remark       = 2;
    string CreateTime    = 3;
    string SourceCode    = 4;
    int32 IsComment       = 5;
    string ProjectCode   = 6;
    string ProjectName   =7;
    string MemberAvatar  =8;
    string MemberName   =9;
    string TaskName      = 10;
}
message ProjectLogResponse{
  repeated ProjectLogMessage list = 1;
  int64 total = 2;
}
service ProjectService {
  rpc Index(IndexMessage) returns (IndexResponse) {}
  rpc FindProjectByMemId(ProjectRpcMessage) returns (MyProjectResponse){}
  rpc FindProjectTemplate(ProjectRpcMessage) returns (ProjectTemplateResponse){}
  rpc SaveProject(ProjectRpcMessage) returns (SaveProjectMessage){}
  rpc FindProjectDetail(ProjectRpcMessage) returns (ProjectDetailMessage){}
  rpc UpdateDeletedProject(ProjectRpcMessage) returns (DeletedProjectResponse){}
  rpc UpdateCollectProject(ProjectRpcMessage) returns (CollectProjectResponse){}
  rpc UpdateProject(UpdateProjectMessage) returns (UpdateProjectResponse){}
  rpc GetLogBySelfProject(ProjectRpcMessage) returns (ProjectLogResponse){}
}
~~~

~~~go

func (ps *ProjectService) GetLogBySelfProject(ctx context.Context, msg *project.ProjectRpcMessage) (*project.ProjectLogResponse, error) {
	//根据用户id查询当前的用户的日志表

	projectLogs, total, err := ps.projectLogRepo.FindLogByMemberCode(context.Background(), msg.MemberId, msg.Page, msg.PageSize)
	if err != nil {
		zap.L().Error("project ProjectService::GetLogBySelfProject projectLogRepo.FindLogByMemberCode error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	//查询项目信息
	pIdList := make([]int64, len(projectLogs))
	mIdList := make([]int64, len(projectLogs))
	taskIdList := make([]int64, len(projectLogs))
	for _, v := range projectLogs {
		pIdList = append(pIdList, v.ProjectCode)
		mIdList = append(mIdList, v.MemberCode)
		taskIdList = append(taskIdList, v.SourceCode)
	}
	projects, err := ps.projectRepo.FindProjectByIds(context.Background(), pIdList)
	if err != nil {
		zap.L().Error("project ProjectService::GetLogBySelfProject projectLogRepo.FindProjectByIds error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	pMap := make(map[int64]*data.Project)
	for _, v := range projects {
		pMap[v.Id] = v
	}
	messageList, _ := rpc.LoginServiceClient.FindMemInfoByIds(context.Background(), &login.UserMessage{MIds: mIdList})
	mMap := make(map[int64]*login.MemberMessage)
	for _, v := range messageList.List {
		mMap[v.Id] = v
	}
	tasks, err := ps.taskRepo.FindTaskByIds(context.Background(), taskIdList)
	if err != nil {
		zap.L().Error("project ProjectService::GetLogBySelfProject projectLogRepo.FindTaskByIds error", zap.Error(err))
		return nil, errs.GrpcError(model.DBError)
	}
	tMap := make(map[int64]*data.Task)
	for _, v := range tasks {
		tMap[v.Id] = v
	}
	var list []*data.IndexProjectLogDisplay
	for _, v := range projectLogs {
		display := v.ToIndexDisplay()
		display.ProjectName = pMap[v.ProjectCode].Name
		display.MemberAvatar = mMap[v.MemberCode].Avatar
		display.MemberName = mMap[v.MemberCode].Name
		display.TaskName = tMap[v.SourceCode].Name
		list = append(list, display)
	}
	var msgList []*project.ProjectLogMessage
	copier.Copy(&msgList, list)
	return &project.ProjectLogResponse{List: msgList, Total: total}, nil
}
~~~

~~~go
type ProjectLogRepo interface {
	FindLogByTaskCode(ctx context.Context, taskCode int64, comment int) (list []*data.ProjectLog, total int64, err error)
	FindLogByTaskCodePage(ctx context.Context, taskCode int64, comment int, page int, pageSize int) (list []*data.ProjectLog, total int64, err error)
	SaveProjectLog(pl *data.ProjectLog)
	FindLogByMemberCode(background context.Context, memberId int64, page int64, size int64) (list []*data.ProjectLog, total int64, err error)
}
~~~

~~~go
func (p *ProjectLogDao) FindLogByMemberCode(ctx context.Context, memberId int64, page int64, size int64) (list []*data.ProjectLog, total int64, err error) {
	session := p.conn.Session(ctx)
	offset := (page - 1) * size
	err = session.Model(&data.ProjectLog{}).
		Where("member_code=?", memberId).
		Limit(int(size)).
		Offset(int(offset)).Order("create_time desc").Find(&list).Error
	err = session.Model(&data.ProjectLog{}).
		Where("member_code=?", memberId).Count(&total).Error
	return
}
~~~

~~~go

type IndexProjectLogDisplay struct {
	Content      string
	Remark       string
	CreateTime   string
	SourceCode   string
	IsComment    int
	ProjectCode  string
	MemberAvatar string
	MemberName   string
	ProjectName  string
	TaskName     string
}

func (l *ProjectLog) ToIndexDisplay() *IndexProjectLogDisplay {
	pd := &IndexProjectLogDisplay{}
	copier.Copy(pd, l)
	pd.ProjectCode = encrypts.EncryptNoErr(l.ProjectCode)
	pd.CreateTime = tms.FormatByMill(l.CreateTime)
	pd.SourceCode = encrypts.EncryptNoErr(l.SourceCode)
	return pd
}

~~~

